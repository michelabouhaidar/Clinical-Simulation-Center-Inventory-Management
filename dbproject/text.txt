package com.example.app;

import javax.persistence.EntityManager;
import javax.persistence.EntityManagerFactory;
import javax.persistence.Persistence;

public final class JPA {
    private static EntityManagerFactory emf;

    static {
        // Use the name from your persistence.xml
        emf = Persistence.createEntityManagerFactory("dbprojectPU");
    }

    private JPA() {}

    public static EntityManager em() { return emf.createEntityManager(); }
}
package com.example.app;

import javafx.application.Application;
import javafx.fxml.FXMLLoader;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.stage.Stage;

public class MainApp extends Application {

    @Override
    public void start(Stage primaryStage) throws Exception {
        FXMLLoader loader = new FXMLLoader(getClass().getResource("/ui/login.fxml"));
        Parent root = loader.load();

        primaryStage.setTitle("Login");
        primaryStage.setScene(new Scene(root));
        primaryStage.show();
    }

    public static void main(String[] args) {
        launch(args);
    }
}
package com.example.app;

import java.io.IOException;
import java.util.function.Consumer;

import javafx.event.ActionEvent;
import javafx.fxml.FXMLLoader;
import javafx.scene.Node;
import javafx.scene.Parent;
import javafx.scene.Scene;
import javafx.stage.Stage;

public final class ViewUtil {

    private ViewUtil() {
        // utility class
    }

    // ---------------------------------------------------------
    // Helpers
    // ---------------------------------------------------------

    /**
     * Resolve the stage from an ActionEvent (button/menu click, etc.).
     */
    private static Stage getStageFromEvent(ActionEvent event) {
        if (event == null) {
            throw new IllegalArgumentException("Event cannot be null");
        }
        Object source = event.getSource();
        if (!(source instanceof Node)) {
            throw new IllegalStateException("Event source is not a JavaFX Node");
        }
        Node node = (Node) source;
        return (Stage) node.getScene().getWindow();
    }

    /**
     * Create a new FXMLLoader for the given FXML path.
     * The path must be present on the classpath under resources.
     * Example: "/ui/main.fxml" or "login.fxml" depending on your structure.
     */
    private static FXMLLoader createLoader(String fxmlPath) {
        if (fxmlPath == null || fxmlPath.isBlank()) {
            throw new IllegalArgumentException("FXML path cannot be null or blank");
        }
        FXMLLoader loader = new FXMLLoader(ViewUtil.class.getResource(fxmlPath));
        if (loader.getLocation() == null) {
            throw new IllegalStateException("Cannot resolve FXML resource: " + fxmlPath);
        }
        return loader;
    }

    // ---------------------------------------------------------
    // Stage-based navigation
    // ---------------------------------------------------------

    /**
     * Switch scene on an existing Stage, simple version (no custom controller).
     */
    public static void switchScene(Stage stage, String fxmlPath, String title) {
        if (stage == null) {
            throw new IllegalArgumentException("Stage cannot be null");
        }

        try {
            FXMLLoader loader = createLoader(fxmlPath);
            Parent root = loader.load();
            Scene scene = new Scene(root);
            stage.setScene(scene);
            if (title != null && !title.isBlank()) {
                stage.setTitle(title);
            }
            stage.centerOnScreen();
            stage.show();
        } catch (IOException e) {
            throw new RuntimeException("Failed to load FXML: " + fxmlPath, e);
        }
    }

    /**
     * Switch scene with a custom loader configurator (e.g. injecting controller).
     */
    public static void switchScene(Stage stage,
                                   String fxmlPath,
                                   Consumer<FXMLLoader> loaderConfigurator) {
        if (stage == null) {
            throw new IllegalArgumentException("Stage cannot be null");
        }

        try {
            FXMLLoader loader = createLoader(fxmlPath);
            if (loaderConfigurator != null) {
                loaderConfigurator.accept(loader);
            }
            Parent root = loader.load();
            Scene scene = new Scene(root);
            stage.setScene(scene);
            stage.centerOnScreen();
            stage.show();
        } catch (IOException e) {
            throw new RuntimeException("Failed to load FXML: " + fxmlPath, e);
        }
    }

    // ---------------------------------------------------------
    // ActionEvent-based navigation (recommended for controllers)
    // ---------------------------------------------------------

    /**
     * Switch scene using an ActionEvent (e.g., from a Button onAction).
     * This reuses the same Stage (no new window).
     */
    public static void switchScene(ActionEvent event,
                                   String fxmlPath,
                                   String title) {
        Stage stage = getStageFromEvent(event);
        switchScene(stage, fxmlPath, title);
    }

    /**
     * Switch scene using an ActionEvent and configure the FXMLLoader
     * (for screens needing a custom controller).
     *
     * Example:
     * ViewUtil.switchScene(event, "/ui/set_password.fxml", loader -> {
     *     loader.setController(new SetPasswordController(username));
     * });
     */
    public static void switchScene(ActionEvent event,
                                   String fxmlPath,
                                   Consumer<FXMLLoader> loaderConfigurator) {
        Stage stage = getStageFromEvent(event);
        switchScene(stage, fxmlPath, loaderConfigurator);
    }
}
package com.example.domain;

import java.time.LocalDateTime;

import javax.persistence.Column;
import javax.persistence.JoinColumn;
import javax.persistence.ManyToOne;
import javax.persistence.MappedSuperclass;
import javax.persistence.PrePersist;
import javax.persistence.PreUpdate;

import com.example.session.AppSession;
import com.example.session.LoggedInUser;

@MappedSuperclass
public abstract class AuditableEntity {

    @ManyToOne
    @JoinColumn(name = "CREATED_BY", nullable = false)
    private User createdBy;

    @Column(name = "CREATED_ON", nullable = false)
    private LocalDateTime createdOn;

    @ManyToOne
    @JoinColumn(name = "UPDATED_BY", nullable = false)
    private User updatedBy;

    @Column(name = "UPDATED_ON", nullable = false)
    private LocalDateTime updatedOn;

    // ===== Getters & Setters =====

    public User getCreatedBy() {
        return createdBy;
    }

    public void setCreatedBy(User createdBy) {
        this.createdBy = createdBy;
    }

    public LocalDateTime getCreatedOn() {
        return createdOn;
    }

    public void setCreatedOn(LocalDateTime createdOn) {
        this.createdOn = createdOn;
    }

    public User getUpdatedBy() {
        return updatedBy;
    }

    public void setUpdatedBy(User updatedBy) {
        this.updatedBy = updatedBy;
    }

    public LocalDateTime getUpdatedOn() {
        return updatedOn;
    }

    public void setUpdatedOn(LocalDateTime updatedOn) {
        this.updatedOn = updatedOn;
    }

    // ===== JPA lifecycle callbacks =====

    @PrePersist
    protected void onCreate() {
        LocalDateTime now = LocalDateTime.now();

        LoggedInUser loggedIn = null;
        try {
            // Use your real AppSession
            loggedIn = AppSession.getCurrentUser();
        } catch (Exception ignored) {
            // In case AppSession is not initialized for some reason
        }

        if (loggedIn != null) {
            Integer userId = loggedIn.getId();

            if (createdBy == null && userId != null) {
                User u = new User();
                u.setId(userId);
                this.createdBy = u;
            }

            if (updatedBy == null && userId != null) {
                User u2 = new User();
                u2.setId(userId);
                this.updatedBy = u2;
            }
        }

        if (createdOn == null) {
            this.createdOn = now;
        }

        if (updatedOn == null) {
            this.updatedOn = now;
        }
    }

    @PreUpdate
    protected void onUpdate() {
        LocalDateTime now = LocalDateTime.now();

        LoggedInUser loggedIn = null;
        try {
            // Use your real AppSession
            loggedIn = AppSession.getCurrentUser();
        } catch (Exception ignored) {
        }

        if (loggedIn != null) {
            Integer userId = loggedIn.getId();
            if (userId != null) {
                User u = new User();
                u.setId(userId);
                this.updatedBy = u;
            }
        }

        this.updatedOn = now;
    }
}
package com.example.domain;

import java.io.Serializable;
import java.util.Objects;

import javax.persistence.Column;
import javax.persistence.Embeddable;
import javax.persistence.EmbeddedId;
import javax.persistence.Entity;
import javax.persistence.JoinColumn;
import javax.persistence.ManyToOne;
import javax.persistence.MapsId;
import javax.persistence.Table;

@Entity
@Table(name = "BORROW_CONS")
public class BorrowCons {

    // ============ Composite primary key: (BORROWID, STOCKID) ============
    @Embeddable
    public static class Id implements Serializable {

        @Column(name = "BORROWID")
        private Integer borrowId;

        @Column(name = "STOCKID")
        private Integer stockId;

        public Id() {}

        public Id(Integer borrowId, Integer stockId) {
            this.borrowId = borrowId;
            this.stockId = stockId;
        }

        public Integer getBorrowId() { return borrowId; }
        public void setBorrowId(Integer borrowId) { this.borrowId = borrowId; }

        public Integer getStockId() { return stockId; }
        public void setStockId(Integer stockId) { this.stockId = stockId; }

        @Override
        public boolean equals(Object o) {
            if (this == o) return true;
            if (!(o instanceof Id)) return false;
            Id that = (Id) o;
            return Objects.equals(borrowId, that.borrowId)
                    && Objects.equals(stockId, that.stockId);
        }

        @Override
        public int hashCode() {
            return Objects.hash(borrowId, stockId);
        }
    }

    @EmbeddedId
    private Id id = new Id();

    @ManyToOne
    @MapsId("borrowId")               // maps BORROWID part of PK
    @JoinColumn(name = "BORROWID", nullable = false)
    private Borrowing borrowing;

    @ManyToOne
    @MapsId("stockId")                // maps STOCKID part of PK
    @JoinColumn(name = "STOCKID", nullable = false)
    private Stock stock;

    @Column(name = "QUANTITY")
    private Integer quantity;

    public BorrowCons() {}

    public BorrowCons(Borrowing borrowing, Stock stock) {
        setBorrowing(borrowing);
        setStock(stock);
    }

    // ----- getters/setters -----

    public Id getId() { return id; }
    public void setId(Id id) { this.id = id; }

    public Borrowing getBorrowing() { return borrowing; }
    public void setBorrowing(Borrowing borrowing) {
        this.borrowing = borrowing;
        if (borrowing != null) {
            if (this.id == null) this.id = new Id();
            this.id.setBorrowId(borrowing.getId());
        }
    }

    public Stock getStock() { return stock; }
    public void setStock(Stock stock) {
        this.stock = stock;
        if (stock != null) {
            if (this.id == null) this.id = new Id();
            this.id.setStockId(stock.getId());
        }
    }

    public Integer getQuantity() { return quantity; }
    public void setQuantity(Integer quantity) { this.quantity = quantity; }
}
package com.example.domain;

import javax.persistence.*;
import java.time.LocalDate;
import java.util.*;

@Entity
@Table(name = "BORROWING")
public class Borrowing extends AuditableEntity {
    @Id
    @Column(name = "BORROWID", nullable = false)
    private Integer id;

    @ManyToOne @JoinColumn(name = "BRANCHID", nullable = false)
    private Branch branch;

    @ManyToOne @JoinColumn(name = "DEPTID", nullable = false)
    private Department department;

    @Column(name = "BORROWCODE", length = 60) private String borrowCode;
    @Column(name = "STARTDATE") private LocalDate startDate;
    @Column(name = "ENDDATE")   private LocalDate endDate;
    @Column(name = "NOTES", length = 1024) private String notes;
    @Column(name = "BORROWSTATUS", length = 60) private String status;

    // Many-to-many via BorrowSim
    @OneToMany(mappedBy = "borrowing", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<BorrowSim> borrowSims = new ArrayList<>();

    // Many-to-many via BorrowCons
    @OneToMany(mappedBy = "borrowing", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<BorrowCons> borrowConsList = new ArrayList<>();

    public Borrowing() {}
    public Borrowing(Integer id){ this.id = id; }

    public Integer getId(){ return id; }
    public void setId(Integer id){ this.id = id; }
    public Branch getBranch(){ return branch; }
    public void setBranch(Branch branch){ this.branch = branch; }
    public Department getDepartment(){ return department; }
    public void setDepartment(Department department){ this.department = department; }
    public String getBorrowCode(){ return borrowCode; }
    public void setBorrowCode(String borrowCode){ this.borrowCode = borrowCode; }
    public LocalDate getStartDate(){ return startDate; }
    public void setStartDate(LocalDate startDate){ this.startDate = startDate; }
    public LocalDate getEndDate(){ return endDate; }
    public void setEndDate(LocalDate endDate){ this.endDate = endDate; }
    public String getNotes(){ return notes; }
    public void setNotes(String notes){ this.notes = notes; }
    public String getStatus(){ return status; }
    public void setStatus(String status){ this.status = status; }

    public List<BorrowSim> getBorrowSims(){ return borrowSims; }
    public void addBorrowSim(BorrowSim bs){ if(!borrowSims.contains(bs)){ borrowSims.add(bs); bs.setBorrowing(this);} }
    public void removeBorrowSim(BorrowSim bs){ if(borrowSims.remove(bs) && bs.getBorrowing()==this) bs.setBorrowing(null); }

    public List<BorrowCons> getBorrowConsList(){ return borrowConsList; }
    public void addBorrowCons(BorrowCons bc){ if(!borrowConsList.contains(bc)){ borrowConsList.add(bc); bc.setBorrowing(this);} }
    public void removeBorrowCons(BorrowCons bc){ if(borrowConsList.remove(bc) && bc.getBorrowing()==this) bc.setBorrowing(null); }
}
package com.example.domain;

import java.io.Serializable;
import java.util.Objects;

import javax.persistence.Column;
import javax.persistence.Embeddable;
import javax.persistence.EmbeddedId;
import javax.persistence.Entity;
import javax.persistence.JoinColumn;
import javax.persistence.ManyToOne;
import javax.persistence.MapsId;
import javax.persistence.Table;

@Entity
@Table(name = "BORROW_SIM")
public class BorrowSim {

    // ============ Composite primary key: (SIMID, BORROWID) ============
    @Embeddable
    public static class Id implements Serializable {

        @Column(name = "SIMID")
        private Integer simId;

        @Column(name = "BORROWID")
        private Integer borrowId;

        public Id() {}

        public Id(Integer simId, Integer borrowId) {
            this.simId = simId;
            this.borrowId = borrowId;
        }

        public Integer getSimId() { return simId; }
        public void setSimId(Integer simId) { this.simId = simId; }

        public Integer getBorrowId() { return borrowId; }
        public void setBorrowId(Integer borrowId) { this.borrowId = borrowId; }

        @Override
        public boolean equals(Object o) {
            if (this == o) return true;
            if (!(o instanceof Id)) return false;
            Id that = (Id) o;
            return Objects.equals(simId, that.simId)
                    && Objects.equals(borrowId, that.borrowId);
        }

        @Override
        public int hashCode() {
            return Objects.hash(simId, borrowId);
        }
    }

    @EmbeddedId
    private Id id = new Id();

    @ManyToOne
    @MapsId("borrowId")                   // BORROWID part of PK
    @JoinColumn(name = "BORROWID", nullable = false)
    private Borrowing borrowing;

    @ManyToOne
    @MapsId("simId")                      // SIMID part of PK
    @JoinColumn(name = "SIMID", nullable = false)
    private Simulator simulator;

    @Column(name = "CONDOUT", length = 60)
    private String conditionOut;

    @Column(name = "CONDIN", length = 60)
    private String conditionIn;

    @Column(name = "RETURNNOTES", length = 1024)
    private String returnNotes;

    public BorrowSim() {}

    public BorrowSim(Borrowing borrowing, Simulator simulator) {
        setBorrowing(borrowing);
        setSimulator(simulator);
    }

    // ----- getters/setters -----

    public Id getId() { return id; }
    public void setId(Id id) { this.id = id; }

    public Borrowing getBorrowing() { return borrowing; }
    public void setBorrowing(Borrowing borrowing) {
        this.borrowing = borrowing;
        if (borrowing != null) {
            if (this.id == null) this.id = new Id();
            this.id.setBorrowId(borrowing.getId());
        }
    }

    public Simulator getSimulator() { return simulator; }
    public void setSimulator(Simulator simulator) {
        this.simulator = simulator;
        if (simulator != null) {
            if (this.id == null) this.id = new Id();
            this.id.setSimId(simulator.getId());
        }
    }

    public String getConditionOut() { return conditionOut; }
    public void setConditionOut(String conditionOut) { this.conditionOut = conditionOut; }

    public String getConditionIn() { return conditionIn; }
    public void setConditionIn(String conditionIn) { this.conditionIn = conditionIn; }

    public String getReturnNotes() { return returnNotes; }
    public void setReturnNotes(String returnNotes) { this.returnNotes = returnNotes; }
}
package com.example.domain;

import javax.persistence.*;
import java.util.*;

@Entity
@Table(name = "BRANCH")
public class Branch {
    @Id
    @Column(name = "BRANCHID", nullable = false)
    private Integer id;

    @Column(name = "NAME", nullable = false, length = 120)
    private String name;

    @Column(name = "LOCATION", length = 200)
    private String location;

    @OneToMany(mappedBy = "branch")
	private List<Simulator> simulators = new ArrayList<>();

	@OneToMany(mappedBy = "branch")
	private List<Stock>     stocks     = new ArrayList<>();

	@OneToMany(mappedBy = "branch")
	private List<Borrowing> borrowings = new ArrayList<>();


    public Branch() {}
    public Branch(Integer id) { this.id = id; }

    public Integer getId() { return id; }
    public void setId(Integer id) { this.id = id; }
    public String getName() { return name; }
    public void setName(String name) { this.name = name; }
    public String getLocation() { return location; }
    public void setLocation(String location) { this.location = location; }

    public List<Simulator> getSimulators() { return simulators; }
    public List<Stock> getStocks() { return stocks; }
    public List<Borrowing> getBorrowings() { return borrowings; }

    public void addSimulator(Simulator s){
		if(!simulators.contains(s)){
			simulators.add(s); s.setBranch(this);
		}
	}
    public void removeSimulator(Simulator s){
		if(simulators.remove(s) && s.getBranch()==this) s.setBranch(null);
		 }
    public void addStock(Stock st){
		if(!stocks.contains(st)){ stocks.add(st);
		 st.setBranch(this);
		}
	}
    public void removeStock(Stock st){
		if(stocks.remove(st) && st.getBranch()==this)
			st.setBranch(null);
	}
    public void addBorrowing(Borrowing b){
		if(!borrowings.contains(b)){ borrowings.add(b);
			b.setBranch(this);
		}
	}
    public void removeBorrowing(Borrowing b){
		if(borrowings.remove(b) && b.getBranch()==this)
			b.setBranch(null);
	}
}
package com.example.domain;

import java.util.ArrayList;
import java.util.List;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.OneToMany;
import javax.persistence.Table;

@Entity
@Table(name = "CONSUMABLE")
public class Consumable {
    @Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "CONSID", nullable = false)
    private Integer id;

    @Column(name = "ITEMNAME", length = 60)
    private String itemName;

    @Column(name = "MEASURE", length = 6)
    private String measure;

    @OneToMany(mappedBy = "consumable")
    private List<Stock> stocks = new ArrayList<>();

    public Consumable() {}
    public Consumable(Integer id){ this.id = id; }

    public Integer getId(){ return id; }
    public void setId(Integer id){ this.id = id; }
    public String getItemName(){ return itemName; }
    public void setItemName(String itemName){ this.itemName = itemName; }
    public String getMeasure(){ return measure; }
    public void setMeasure(String measure){ this.measure = measure; }

    public List<Stock> getStocks(){ return stocks; }
    public void addStock(Stock s){
		if(!stocks.contains(s)){ stocks.add(s);
			s.setConsumable(this);
		}
	}
    public void removeStock(Stock s){
		if(stocks.remove(s) && s.getConsumable()==this)
			s.setConsumable(null);
	}

	public String toString() {
        String name = (itemName != null ? itemName : "Consumable #" + id);
        String m    = (measure != null ? measure : "");
        return m.isEmpty() ? name : name + " (" + m + ")";
    }
}
package com.example.domain;

import javax.persistence.*;
import java.util.*;

@Entity
@Table(name = "DEPARTMENT")
public class Department {
    @Id
    @Column(name = "DEPTID", nullable = false)
    private Integer id;

    @Column(name = "DEPTNAME", length = 60)
    private String name;

    @Column(name = "CONTACTNAME", length = 60)
    private String contactName;

    @Column(name = "PHONE1", length = 12)
    private String phone1;

    @Column(name = "PHONE2", length = 12)
    private String phone2;

    @Column(name = "EMAIL", length = 120)
    private String email;

    @OneToMany(mappedBy = "department")
    private List<Borrowing> borrowings = new ArrayList<>();

    public Department() {}
    public Department(Integer id){ this.id = id; }

    public Integer getId(){ return id; }
    public void setId(Integer id){ this.id = id; }
    public String getName(){ return name; }
    public void setName(String name){ this.name = name; }
    public String getContactName(){ return contactName; }
    public void setContactName(String contactName){ this.contactName = contactName; }
    public String getPhone1(){ return phone1; }
    public void setPhone1(String phone1){ this.phone1 = phone1; }
    public String getPhone2(){ return phone2; }
    public void setPhone2(String phone2){ this.phone2 = phone2; }
    public String getEmail(){ return email; }
    public void setEmail(String email){ this.email = email; }

    public List<Borrowing> getBorrowings(){return borrowings; }
    public void addBorrowing(Borrowing b){
		if(!borrowings.contains(b)){ borrowings.add(b);
			b.setDepartment(this);
		}
	}
    public void removeBorrowing(Borrowing b){
		if(borrowings.remove(b) && b.getDepartment()==this)
			b.setDepartment(null);
	}
}
package com.example.domain;

import java.io.Serializable;
import java.util.Objects;

import javax.persistence.Column;
import javax.persistence.Embeddable;
import javax.persistence.EmbeddedId;
import javax.persistence.Entity;
import javax.persistence.FetchType;
import javax.persistence.JoinColumn;
import javax.persistence.ManyToOne;
import javax.persistence.MapsId;
import javax.persistence.Table;

@Entity
@Table(name = "MAINTAINED")
public class Maintained {

    // ============ Composite primary key: (SIMID, EVENTID) ============
    @Embeddable
    public static class Id implements Serializable {

        @Column(name = "SIMID")
        private Integer simId;

        @Column(name = "EVENTID")
        private Integer eventId;

        public Id() {}

        public Id(Integer simId, Integer eventId) {
            this.simId = simId;
            this.eventId = eventId;
        }

        public Integer getSimId() { return simId; }
        public void setSimId(Integer simId) { this.simId = simId; }

        public Integer getEventId() { return eventId; }
        public void setEventId(Integer eventId) { this.eventId = eventId; }

        @Override
        public boolean equals(Object o) {
            if (this == o) return true;
            if (!(o instanceof Id)) return false;
            Id that = (Id) o;
            return Objects.equals(simId, that.simId)
                    && Objects.equals(eventId, that.eventId);
        }

        @Override
        public int hashCode() {
            return Objects.hash(simId, eventId);
        }
    }

    @EmbeddedId
    private Id id = new Id();

    @ManyToOne(optional = false, fetch = FetchType.LAZY)
    @MapsId("eventId")                      // EVENTID part of PK
    @JoinColumn(name = "EVENTID", nullable = false)
    private Maintenance maintenance;

    @ManyToOne(optional = false, fetch = FetchType.LAZY)
    @MapsId("simId")                        // SIMID part of PK
    @JoinColumn(name = "SIMID", nullable = false)
    private Simulator simulator;

    public Maintained() {}

    public Maintained(Maintenance maintenance, Simulator simulator) {
        setMaintenance(maintenance);
        setSimulator(simulator);
    }

    public Id getId() { return id; }
    public void setId(Id id) { this.id = id; }

    public Maintenance getMaintenance() { return maintenance; }
    public void setMaintenance(Maintenance maintenance) {
        this.maintenance = maintenance;
        if (maintenance != null) {
            if (this.id == null) this.id = new Id();
            this.id.setEventId(maintenance.getId());
        }
    }

    public Simulator getSimulator() { return simulator; }
    public void setSimulator(Simulator simulator) {
        this.simulator = simulator;
        if (simulator != null) {
            if (this.id == null) this.id = new Id();
            this.id.setSimId(simulator.getId());
        }
    }

    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (!(o instanceof Maintained)) return false;
        Maintained that = (Maintained) o;
        return Objects.equals(id, that.id);
    }

    @Override
    public int hashCode() {
        return id != null ? id.hashCode() : 0;
    }
}
package com.example.domain;

import javax.persistence.*;
import java.time.LocalDate;
import java.util.*;

/**
 * Bidirectional JPA entity for MAINTENANCE table.
 * - Many-to-many via link entity:
 *     Maintenance ─< Maintained >─ Simulator
 * - Read-only ManyToMany "view":
 *     maintainedSimulatorsView (via MAINTAINED)
 * - Auditable fields inherited from AuditableEntity.
 */
@Entity
@Table(name = "MAINTENANCE")
public class Maintenance extends AuditableEntity {

    // -------------------------------------------------
    // Primary Key
    // -------------------------------------------------
    @Id
    @Column(name = "EVENTID", nullable = false)
    private Integer id;

    // -------------------------------------------------
    // Columns
    // -------------------------------------------------
    @Column(name = "TYPE", length = 60)
    private String type;

    @Column(name = "EVENTSTARTDATE")
    private LocalDate eventStartDate;

    @Column(name = "EVENTENDDATE")
    private LocalDate eventEndDate;

    @Column(name = "EVENTNOTES", length = 1024)
    private String eventNotes;

    @Column(name = "VENDOR", length = 60)
    private String vendor;

    // -------------------------------------------------
    // Association entity (true many-to-many)
    // -------------------------------------------------
    @OneToMany(mappedBy = "maintenance", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Maintained> maintainedItems = new ArrayList<>();

    // -------------------------------------------------
    // Read-only convenience view (pure ManyToMany navigation)
    // NOTE: Do not mutate this set; manage links via Maintained.
    // -------------------------------------------------
    @ManyToMany
    @JoinTable(
        name = "MAINTAINED",
        joinColumns = @JoinColumn(name = "EVENTID"),
        inverseJoinColumns = @JoinColumn(name = "SIMID")
    )
    private Set<Simulator> maintainedSimulatorsView = new HashSet<>();

    // -------------------------------------------------
    // Constructors
    // -------------------------------------------------
    public Maintenance() {}
    public Maintenance(Integer id) { this.id = id; }

    // -------------------------------------------------
    // Getters / Setters
    // -------------------------------------------------
    public Integer getId() { return id; }
    public void setId(Integer id) { this.id = id; }

    public String getType() { return type; }
    public void setType(String type) { this.type = type; }

    public LocalDate getEventStartDate() { return eventStartDate; }
    public void setEventStartDate(LocalDate eventStartDate) { this.eventStartDate = eventStartDate; }

    public LocalDate getEventEndDate() { return eventEndDate; }
    public void setEventEndDate(LocalDate eventEndDate) { this.eventEndDate = eventEndDate; }

    public String getEventNotes() { return eventNotes; }
    public void setEventNotes(String eventNotes) { this.eventNotes = eventNotes; }

    public String getVendor() { return vendor; }
    public void setVendor(String vendor) { this.vendor = vendor; }

    public List<Maintained> getMaintainedItems() { return maintainedItems; }

    // Read-only view (unmodifiable)
    public Set<Simulator> getMaintainedSimulatorsView() {
        return Collections.unmodifiableSet(maintainedSimulatorsView);
    }

    // -------------------------------------------------
    // Sync helpers for association entity
    // -------------------------------------------------
    public void addMaintained(Maintained m) {
        if (m == null) return;
        if (!maintainedItems.contains(m)) {
            maintainedItems.add(m);
            m.setMaintenance(this);
        }
    }

    public void removeMaintained(Maintained m) {
        if (m == null) return;
        if (maintainedItems.remove(m) && m.getMaintenance() == this) {
            m.setMaintenance(null);
        }
    }

    // -------------------------------------------------
    // equals / hashCode / toString (by PK)
    // -------------------------------------------------
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (!(o instanceof Maintenance)) return false;
        Maintenance that = (Maintenance) o;
        return Objects.equals(id, that.id);
    }

    @Override
    public int hashCode() { return Objects.hash(id); }

    @Override
    public String toString() {
        return "Maintenance{id=" + id + ", type='" + type + "'}";
    }
}
package com.example.domain;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.Collections;
import java.util.HashSet;
import java.util.List;
import java.util.Objects;
import java.util.Set;

import javax.persistence.CascadeType;
import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.JoinColumn;
import javax.persistence.JoinTable;
import javax.persistence.ManyToMany;
import javax.persistence.ManyToOne;
import javax.persistence.OneToMany;
import javax.persistence.Table;

/**
 * Bidirectional JPA entity for SIMULATOR table.
 * - Many-to-many via link entities:
 *     Simulator ─< BorrowSim >─ Borrowing
 *     Simulator ─< Maintained >─ Maintenance
 * - Read-only ManyToMany "views" (for quick navigation only):
 *     borrowingsView (via BORROW_SIM), maintenancesView (via MAINTAINED)
 * - Auditable fields inherited from AuditableEntity (CREATED_/UPDATED_).
 */
@Entity
@Table(name = "SIMULATOR")
public class Simulator extends AuditableEntity {

    // -------------------------------------------------
    // Primary Key
    // -------------------------------------------------
    @Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "SIMID", nullable = false)
    private Integer id;

    // -------------------------------------------------
    // Foreign Keys
    // -------------------------------------------------
    @ManyToOne
    @JoinColumn(name = "BRANCHID", nullable = false)
    private Branch branch;

    @ManyToOne
    @JoinColumn(name = "MODELID", nullable = false)
    private SimulatorModel model;

    // -------------------------------------------------
    // Columns
    // -------------------------------------------------
    @Column(name = "TAG", nullable = false, length = 60)
    private String tag;

    @Column(name = "SN", length = 60)
    private String serialNumber;

    @Column(name = "SIMSTATUS", length = 60)
    private String status;

    @Column(name = "CONDNOTES", length = 1024)
    private String conditionNotes;

    @Column(name = "CALDATE")
    private LocalDate calibrationDate;

    @Column(name = "NEXTCALDATE")
    private LocalDate nextCalibrationDate;

    // -------------------------------------------------
    // Association entities (true many-to-many with payload)
    // -------------------------------------------------
    @OneToMany(mappedBy = "simulator", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<BorrowSim> borrowSims = new ArrayList<>();

    @OneToMany(mappedBy = "simulator", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<Maintained> maintainedEvents = new ArrayList<>();

    // -------------------------------------------------
    // Read-only convenience views (pure ManyToMany navigation)
    // NOTE: Do not mutate these sets; manage links via BorrowSim/Maintained.
    // -------------------------------------------------
    @ManyToMany
    @JoinTable(
        name = "BORROW_SIM",
        joinColumns = @JoinColumn(name = "SIMID"),
        inverseJoinColumns = @JoinColumn(name = "BORROWID")
    )
    private Set<Borrowing> borrowingsView = new HashSet<>();

    @ManyToMany
    @JoinTable(
        name = "MAINTAINED",
        joinColumns = @JoinColumn(name = "SIMID"),
        inverseJoinColumns = @JoinColumn(name = "EVENTID")
    )
    private Set<Maintenance> maintenancesView = new HashSet<>();

    // -------------------------------------------------
    // Constructors
    // -------------------------------------------------
    public Simulator() {}
    public Simulator(Integer id) { this.id = id; }

    // -------------------------------------------------
    // Getters / Setters
    // -------------------------------------------------
    public Integer getId() { return id; }
    public void setId(Integer id) { this.id = id; }

    public Branch getBranch() { return branch; }
    public void setBranch(Branch branch) { this.branch = branch; }

    public SimulatorModel getModel() { return model; }
    public void setModel(SimulatorModel model) { this.model = model; }

    public String getTag() { return tag; }
    public void setTag(String tag) { this.tag = tag; }

    public String getSerialNumber() { return serialNumber; }
    public void setSerialNumber(String serialNumber) { this.serialNumber = serialNumber; }

    public String getStatus() { return status; }
    public void setStatus(String status) { this.status = status; }

    public String getConditionNotes() { return conditionNotes; }
    public void setConditionNotes(String conditionNotes) { this.conditionNotes = conditionNotes; }

    public LocalDate getCalibrationDate() { return calibrationDate; }
    public void setCalibrationDate(LocalDate calibrationDate) { this.calibrationDate = calibrationDate; }

    public LocalDate getNextCalibrationDate() { return nextCalibrationDate; }
    public void setNextCalibrationDate(LocalDate nextCalibrationDate) { this.nextCalibrationDate = nextCalibrationDate; }

    public List<BorrowSim> getBorrowSims() { return borrowSims; }
    public List<Maintained> getMaintainedEvents() { return maintainedEvents; }

    // Read-only views (unmodifiable)
    public Set<Borrowing> getBorrowingsView() { return Collections.unmodifiableSet(borrowingsView); }
    public Set<Maintenance> getMaintenancesView() { return Collections.unmodifiableSet(maintenancesView); }

    // -------------------------------------------------
    // Sync helpers for association entities
    // -------------------------------------------------
    public void addBorrowSim(BorrowSim bs) {
        if (bs == null) return;
        if (!borrowSims.contains(bs)) {
            borrowSims.add(bs);
            bs.setSimulator(this);
        }
    }
    public void removeBorrowSim(BorrowSim bs) {
        if (bs == null) return;
        if (borrowSims.remove(bs) && bs.getSimulator() == this) {
            bs.setSimulator(null);
        }
    }

    public void addMaintained(Maintained m) {
        if (m == null) return;
        if (!maintainedEvents.contains(m)) {
            maintainedEvents.add(m);
            m.setSimulator(this);
        }
    }
    public void removeMaintained(Maintained m) {
        if (m == null) return;
        if (maintainedEvents.remove(m) && m.getSimulator() == this) {
            m.setSimulator(null);
        }
    }

    // -------------------------------------------------
    // equals / hashCode / toString (by PK)
    // -------------------------------------------------
    @Override
    public boolean equals(Object o) {
        if (this == o) return true;
        if (!(o instanceof Simulator)) return false;
        Simulator that = (Simulator) o;
        return Objects.equals(id, that.id);
    }

    @Override
    public int hashCode() { return Objects.hash(id); }

    @Override
    public String toString() {
        return "Simulator{id=" + id + ", tag='" + tag + "'}";
    }
}
package com.example.domain;

import java.util.ArrayList;
import java.util.List;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.OneToMany;
import javax.persistence.Table;

@Entity
@Table(name = "SIMULATOR_MODEL")
public class SimulatorModel {
    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "MODELID", nullable = false)
    private Integer id;

    @Column(name = "MODELNAME", length = 50)
    private String modelName;

    @Column(name = "SPECS", length = 1024)
    private String specs;

    @Column(name = "CALREQ")
    private Boolean calReq;

    @Column(name = "MAXDAYS")
    private Integer maxDays;

    @OneToMany(mappedBy = "model")
    private List<Simulator> simulators = new ArrayList<>();

    public SimulatorModel() {}
    public SimulatorModel(Integer id){ this.id = id; }

    public Integer getId(){ return id; }
    public void setId(Integer id){ this.id = id; }
    public String getModelName(){ return modelName; }
    public void setModelName(String modelName){ this.modelName = modelName; }
    public String getSpecs(){ return specs; }
    public void setSpecs(String specs){ this.specs = specs; }
    public Boolean getCalReq(){ return calReq; }
    public void setCalReq(Boolean calReq){ this.calReq = calReq; }
    public Integer getMaxDays(){ return maxDays; }
    public void setMaxDays(Integer maxDays){ this.maxDays = maxDays; }

    public List<Simulator> getSimulators(){ return simulators; }
    public void addSimulator(Simulator s){ if(!simulators.contains(s)){ simulators.add(s); s.setModel(this);} }
    public void removeSimulator(Simulator s){ if(simulators.remove(s) && s.getModel()==this) s.setModel(null); }
	@Override
    public String toString() {
        return modelName != null ? modelName : ("Model #" + id);
    }

}
package com.example.domain;

public final class Status {

    private Status() {} // utility class

    public static final String SIM_AVAILABLE      = "AVAILABLE";
    public static final String SIM_BORROWED       = "BORROWED";
    public static final String SIM_MAINTENANCE    = "MAINTENANCE";
    public static final String SIM_OUT_OF_SERVICE = "OUT_OF_SERVICE";

    public static final String BORROW_ACTIVE           = "ACTIVE";
    public static final String BORROW_PARTIAL_RETURN   = "PARTIALLY_RETURNED";
    public static final String BORROW_CLOSED           = "CLOSED";
    public static final String BORROW_CANCELLED        = "CANCELLED";
}
package com.example.domain;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

import javax.persistence.CascadeType;
import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.GeneratedValue;
import javax.persistence.GenerationType;
import javax.persistence.Id;
import javax.persistence.JoinColumn;
import javax.persistence.ManyToOne;
import javax.persistence.OneToMany;
import javax.persistence.Table;

@Entity
@Table(name = "STOCK")
public class Stock extends AuditableEntity {
    @Id
	@GeneratedValue(strategy = GenerationType.IDENTITY)
    @Column(name = "STOCKID", nullable = false)
    private Integer id;

    @ManyToOne @JoinColumn(name = "BRANCHID", nullable = false)
    private Branch branch;

    @ManyToOne @JoinColumn(name = "CONSID", nullable = false)
    private Consumable consumable;

    @Column(name = "AVAILABLEQ")  private Integer availableQuantity;
    @Column(name = "RESERVEDQ")   private Integer reservedQuantity;
    @Column(name = "LASTCOUNTDATE") private LocalDate lastCountDate;

    // Many-to-many via link entity BorrowCons
    @OneToMany(mappedBy = "stock", cascade = CascadeType.ALL, orphanRemoval = true)
    private List<BorrowCons> borrowConsList = new ArrayList<>();

    public Stock() {}
    public Stock(Integer id){ this.id = id; }

    public Integer getId(){ return id; }
    public void setId(Integer id){ this.id = id; }
    public Branch getBranch(){ return branch; }
    public void setBranch(Branch branch){ this.branch = branch; }
    public Consumable getConsumable(){ return consumable; }
    public void setConsumable(Consumable consumable){ this.consumable = consumable; }
    public Integer getAvailableQuantity(){ return availableQuantity; }
    public void setAvailableQuantity(Integer availableQuantity){ this.availableQuantity = availableQuantity; }
    public Integer getReservedQuantity(){ return reservedQuantity; }
    public void setReservedQuantity(Integer reservedQuantity){ this.reservedQuantity = reservedQuantity; }
    public LocalDate getLastCountDate(){ return lastCountDate; }
    public void setLastCountDate(LocalDate lastCountDate){ this.lastCountDate = lastCountDate; }

    public List<BorrowCons> getBorrowConsList(){ return borrowConsList; }
    public void addBorrowCons(BorrowCons bc){ if(!borrowConsList.contains(bc)){ borrowConsList.add(bc); bc.setStock(this);} }
    public void removeBorrowCons(BorrowCons bc){ if(borrowConsList.remove(bc) && bc.getStock()==this) bc.setStock(null); }
}
package com.example.domain;

import java.util.ArrayList;
import java.util.List;

import javax.persistence.Column;
import javax.persistence.Entity;
import javax.persistence.Id;
import javax.persistence.JoinColumn;
import javax.persistence.ManyToOne;
import javax.persistence.OneToMany;
import javax.persistence.Table;

@Entity
@Table(name = "USERS")
public class User {

    @Id
    @Column(name = "USERID", nullable = false)
    private Integer id;

    @Column(name = "USERNAME", length = 20)
    private String username;

    @Column(name = "DISPLAYNAME", length = 80)
    private String displayName;

    @Column(name = "ROLE", length = 20)
    private String role;

    @Column(name = "PASSHASH", length = 150)
    private String passHash;

    @Column(name = "IS_ACTIVE")
    private Boolean isActive;

    @Column(name = "USERMAIL", length = 120)
    private String email;

    // FK → BRANCH.BranchID
    @ManyToOne
    @JoinColumn(name = "BranchID")
    private Branch branch;

    // reset tinyint(1) NOT NULL
    @Column(name = "reset", nullable = false)
    private Boolean reset;

    @OneToMany(mappedBy = "createdBy")
    private List<Simulator> simulatorsCreated = new ArrayList<>();

    @OneToMany(mappedBy = "updatedBy")
    private List<Simulator> simulatorsUpdated = new ArrayList<>();

    @OneToMany(mappedBy = "createdBy")
    private List<Stock> stocksCreated = new ArrayList<>();

    @OneToMany(mappedBy = "updatedBy")
    private List<Stock> stocksUpdated = new ArrayList<>();

    @OneToMany(mappedBy = "createdBy")
    private List<Maintenance> maintCreated = new ArrayList<>();

    @OneToMany(mappedBy = "updatedBy")
    private List<Maintenance> maintUpdated = new ArrayList<>();

    @OneToMany(mappedBy = "createdBy")
    private List<Borrowing> borrowCreated = new ArrayList<>();

    @OneToMany(mappedBy = "updatedBy")
    private List<Borrowing> borrowUpdated = new ArrayList<>();

    // -------------------------------------------------
    // Constructors
    // -------------------------------------------------
    public User() {}

    public User(Integer id) {
        this.id = id;
    }

    // -------------------------------------------------
    // Getters / Setters (scalar fields)
    // -------------------------------------------------
    public Integer getId() {
        return id;
    }

    public void setId(Integer id) {
        this.id = id;
    }

    public String getUsername() {
        return username;
    }

    public void setUsername(String username) {
        this.username = username;
    }

    public String getDisplayName() {
        return displayName;
    }

    public void setDisplayName(String displayName) {
        this.displayName = displayName;
    }

    public String getRole() {
        return role;
    }

    public void setRole(String role) {
        this.role = role;
    }

    public String getPassHash() {
        return passHash;
    }

    public void setPassHash(String passHash) {
        this.passHash = passHash;
    }

    public Boolean getIsActive() {
        return isActive;
    }

    public void setIsActive(Boolean active) {
        isActive = active;
    }

    public String getEmail() {
        return email;
    }

    public void setEmail(String email) {
        this.email = email;
    }

    public Branch getBranch() {
        return branch;
    }

    public void setBranch(Branch branch) {
        this.branch = branch;
    }

    public Boolean getReset() {
        return reset;
    }

    public void setReset(Boolean reset) {
        this.reset = reset;
    }

    // -------------------------------------------------
    // Getters / Setters (collections)
    // -------------------------------------------------
    public List<Simulator> getSimulatorsCreated() {
        return simulatorsCreated;
    }

    public void setSimulatorsCreated(List<Simulator> simulatorsCreated) {
        this.simulatorsCreated = simulatorsCreated;
    }

    public List<Simulator> getSimulatorsUpdated() {
        return simulatorsUpdated;
    }

    public void setSimulatorsUpdated(List<Simulator> simulatorsUpdated) {
        this.simulatorsUpdated = simulatorsUpdated;
    }

    public List<Stock> getStocksCreated() {
        return stocksCreated;
    }

    public void setStocksCreated(List<Stock> stocksCreated) {
        this.stocksCreated = stocksCreated;
    }

    public List<Stock> getStocksUpdated() {
        return stocksUpdated;
    }

    public void setStocksUpdated(List<Stock> stocksUpdated) {
        this.stocksUpdated = stocksUpdated;
    }

    public List<Maintenance> getMaintCreated() {
        return maintCreated;
    }

    public void setMaintCreated(List<Maintenance> maintCreated) {
        this.maintCreated = maintCreated;
    }

    public List<Maintenance> getMaintUpdated() {
        return maintUpdated;
    }

    public void setMaintUpdated(List<Maintenance> maintUpdated) {
        this.maintUpdated = maintUpdated;
    }

    public List<Borrowing> getBorrowCreated() {
        return borrowCreated;
    }

    public void setBorrowCreated(List<Borrowing> borrowCreated) {
        this.borrowCreated = borrowCreated;
    }

    public List<Borrowing> getBorrowUpdated() {
        return borrowUpdated;
    }

    public void setBorrowUpdated(List<Borrowing> borrowUpdated) {
        this.borrowUpdated = borrowUpdated;
    }
}
package com.example.session;

public final class AppSession {

    private static LoggedInUser currentUser;

    private AppSession() {}

    public static void setCurrentUser(LoggedInUser user) {
        currentUser = user;
    }

    public static LoggedInUser getCurrentUser() {
        return currentUser;
    }

    public static void clear() {
        currentUser = null;
    }

    public static boolean isLoggedIn() {
        return currentUser != null;
    }
}
package com.example.session;

public final class LoggedInUser {

    private final Integer id;
    private final String username;
    private final String displayName;
    private final String role;
    private final String email;
    private final String branchName;

    public LoggedInUser(Integer id,
                        String username,
                        String displayName,
                        String role,
                        String email,
                        String branchName) {
        this.id = id;
        this.username = username;
        this.displayName = displayName;
        this.role = role;
        this.email = email;
        this.branchName = branchName;
    }

    public Integer getId()        { return id; }
    public String getUsername()   { return username; }
    public String getDisplayName(){ return displayName; }
    public String getRole()       { return role; }
    public String getEmail()      { return email; }
    public String getBranchName() { return branchName; }
}
package com.example.ui;

import java.time.LocalDate;

import javax.persistence.EntityManager;

import com.example.app.JPA;
import com.example.app.ViewUtil;
import com.example.session.AppSession;
import com.example.session.LoggedInUser;

import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.scene.control.Alert;
import javafx.scene.control.Button;
import javafx.scene.control.Label;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.scene.control.cell.PropertyValueFactory;

public class HomeController {

    @FXML private Label subtitleLabel;
    @FXML private Label userLabel;

    @FXML private Label totalSimulatorsLabel;
    @FXML private Label activeBorrowingsLabel;
    @FXML private Label upcomingCalibrationsLabel;

    @FXML private TableView<MaintenanceRow> maintenanceTable;
    @FXML private TableColumn<MaintenanceRow, LocalDate> maintDateCol;
    @FXML private TableColumn<MaintenanceRow, String>    maintSimCol;
    @FXML private TableColumn<MaintenanceRow, String>    maintTypeCol;
    @FXML private TableColumn<MaintenanceRow, String>    maintVendorCol;

    @FXML private TableView<LowStockRow> stockTable;
    @FXML private TableColumn<LowStockRow, String>  stockConsCol;
    @FXML private TableColumn<LowStockRow, String>  stockBranchCol;
    @FXML private TableColumn<LowStockRow, Integer> stockAvailCol;
    @FXML private TableColumn<LowStockRow, Integer> stockResCol;

    @FXML private Button logoutButton;

    private final OverviewService overviewService = new OverviewService();

    @FXML
    public void initialize() {
        // 1) Show logged-in user info in top-right
        LoggedInUser u = AppSession.getCurrentUser();
        if (u != null && userLabel != null) {
            StringBuilder sb = new StringBuilder();

            if (u.getDisplayName() != null && !u.getDisplayName().isBlank()) {
                sb.append(u.getDisplayName());
            } else if (u.getUsername() != null) {
                sb.append(u.getUsername());
            }

            if (u.getRole() != null && !u.getRole().isBlank()) {
                sb.append(" (").append(u.getRole()).append(")");
            }

            if (u.getBranchName() != null && !u.getBranchName().isBlank()) {
                sb.append(" · ").append(u.getBranchName());
            }

            if (u.getEmail() != null && !u.getEmail().isBlank()) {
                sb.append(" · ").append(u.getEmail());
            }

            userLabel.setText(sb.toString());
        }

        // 2) Configure table columns
        if (maintDateCol != null)   maintDateCol.setCellValueFactory(new PropertyValueFactory<>("date"));
        if (maintSimCol != null)    maintSimCol.setCellValueFactory(new PropertyValueFactory<>("simulator"));
        if (maintTypeCol != null)   maintTypeCol.setCellValueFactory(new PropertyValueFactory<>("type"));
        if (maintVendorCol != null) maintVendorCol.setCellValueFactory(new PropertyValueFactory<>("vendor"));

        if (stockConsCol != null)   stockConsCol.setCellValueFactory(new PropertyValueFactory<>("consumable"));
        if (stockBranchCol != null) stockBranchCol.setCellValueFactory(new PropertyValueFactory<>("branch"));
        if (stockAvailCol != null)  stockAvailCol.setCellValueFactory(new PropertyValueFactory<>("available"));
        if (stockResCol != null)    stockResCol.setCellValueFactory(new PropertyValueFactory<>("reserved"));

        // 3) Load data from DB for this user
        loadOverviewData();
    }

    private void loadOverviewData() {
        LoggedInUser u = AppSession.getCurrentUser();
        if (u == null) return;

        EntityManager em = JPA.em();
        try {
            // Top cards
            OverviewStats stats = overviewService.loadStats(em, u);
            if (totalSimulatorsLabel != null)
                totalSimulatorsLabel.setText(String.valueOf(stats.getTotalSimulators()));
            if (activeBorrowingsLabel != null)
                activeBorrowingsLabel.setText(String.valueOf(stats.getActiveBorrowings()));
            if (upcomingCalibrationsLabel != null)
                upcomingCalibrationsLabel.setText(String.valueOf(stats.getUpcomingCalibrations()));

            // Tables
            if (maintenanceTable != null) {
                maintenanceTable.getItems().setAll(
                        overviewService.loadRecentMaintenance(em, u)
                );
            }

            if (stockTable != null) {
                stockTable.getItems().setAll(
                        overviewService.loadLowStock(em, u)
                );
            }
        } catch (Exception ex) {
            ex.printStackTrace(); // or show a small error label somewhere
        } finally {
            em.close();
        }
    }


	@FXML
	private void onNavSimulators(ActionEvent event) {
	    try {
	        ViewUtil.switchScene(event, "/ui/simulators.fxml", "Simulators");
	    } catch (Exception e) {
	        e.printStackTrace();
	    }
	}

	@FXML
	private void onNavStock(ActionEvent event) {
	    try {
	        ViewUtil.switchScene(event, "/ui/stock.fxml", "Stock");
	    } catch (Exception e) {
	        e.printStackTrace();
	    }
	}

	@FXML
    private void onNavMaintentance(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/maintenance.fxml", "Maintenance");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

	@FXML
	private void onNavUsers(ActionEvent event) {
	    LoggedInUser u = AppSession.getCurrentUser();
	    if (u == null || u.getRole() == null || !u.getRole().equalsIgnoreCase("ADMIN")) {
	        Alert a = new Alert(Alert.AlertType.WARNING);
	        a.setTitle("Access denied");
	        a.setHeaderText(null);
	        a.setContentText("Only ADMIN users can manage users.");
	        a.showAndWait();
	        return;
	    }
	
	    try {
	        ViewUtil.switchScene(event, "/ui/users.fxml", "Users");
	    } catch (Exception e) {
	        e.printStackTrace();
	    }
	}

	@FXML
    private void onLogout(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/login.fxml", "Login");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
package com.example.ui;

import javax.persistence.EntityManager;

import com.example.app.JPA;
import com.example.app.ViewUtil;
import com.example.domain.User;
import com.example.session.AppSession;
import com.example.session.LoggedInUser;

import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.scene.control.Label;
import javafx.scene.control.PasswordField;
import javafx.scene.control.TextField;

public class LoginController {

    @FXML private TextField usernameField;
    @FXML private PasswordField passwordField;
    @FXML private Label errorLabel;

    private final UserRepository repo = new UserRepository();

    @FXML
    public void initialize() {
        if (usernameField != null) {
            usernameField.requestFocus();
        }
    }

    @FXML
    public void onLogin(ActionEvent event) {
        errorLabel.setText("");

        String usernameRaw = usernameField.getText();
        String password = passwordField.getText();

        if (usernameRaw == null || usernameRaw.trim().isEmpty()) {
            errorLabel.setText("Enter username.");
            return;
        }

        String username = usernameRaw.trim();

        EntityManager em = JPA.em();
        try {
            User u = repo.findByUsername(em, username);

            if (u == null) {
                errorLabel.setText("Invalid username or password.");
                passwordField.clear();
                passwordField.requestFocus();
                return;
            }

            if (Boolean.FALSE.equals(u.getIsActive())) {
                errorLabel.setText("Account is inactive.");
                passwordField.clear();
                passwordField.requestFocus();
                return;
            }

            // First login / no password set
            // if (u.getPassHash() == null || u.getPassHash().isBlank()) {
            //     try {
            //         ViewUtil.switchScene(event, "/ui/set_password.fxml", loader -> {
            //             SetPasswordController controller =
            //                     new SetPasswordController(u.getUsername());
            //             loader.setController(controller);
            //         });
            //     } catch (Exception e) {
            //         e.printStackTrace();
            //         errorLabel.setText("Failed to open password setup screen.");
            //     }
            //     return;
            // }

            // Password mismatch
            if (!PasswordUtil.verify(password, u.getPassHash())) {
                errorLabel.setText("Invalid username or password.");
                passwordField.clear();
                passwordField.requestFocus();
                return;
            }

            // Force reset
            if (Boolean.TRUE.equals(u.getReset())) {
                try {
                    ViewUtil.switchScene(event, "/ui/set_password.fxml", loader -> {
                        SetPasswordController controller =
                                new SetPasswordController(u.getUsername());
                        loader.setController(controller);
                    });
                } catch (Exception e) {
                    e.printStackTrace();
                    errorLabel.setText("Failed to open password setup screen.");
                }
                return;
            }

            // Normal login: set session
            AppSession.setCurrentUser(
                    new LoggedInUser(
                            u.getId(),
                            u.getUsername(),
                            u.getDisplayName(),
                            u.getRole(),
                            u.getEmail(),
                            (u.getBranch() != null ? u.getBranch().getName() : null)
                    )
            );

            // Go to home
            ViewUtil.switchScene(event, "/ui/home.fxml", "Main Menu");

        } catch (Exception ex) {
            ex.printStackTrace();
            errorLabel.setText("Login error: " + ex.getMessage());
        } finally {
            em.close();
        }
    }
}
package com.example.ui;

public class LowStockRow {
    private final String consumable;
    private final String branch;
    private final Integer available;
    private final Integer reserved;

    public LowStockRow(String consumable, String branch,
                       Integer available, Integer reserved) {
        this.consumable = consumable;
        this.branch = branch;
        this.available = available;
        this.reserved = reserved;
    }

    public String getConsumable() { return consumable; }
    public String getBranch()     { return branch; }
    public Integer getAvailable() { return available; }
    public Integer getReserved()  { return reserved; }
}
package com.example.ui;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Optional;

import javax.persistence.EntityManager;
import javax.persistence.TypedQuery;

import com.example.app.JPA;
import com.example.app.ViewUtil;
import com.example.domain.Maintained;
import com.example.domain.Maintenance;
import com.example.domain.Simulator;
import com.example.domain.Status;
import com.example.session.AppSession;
import com.example.session.LoggedInUser;

import javafx.beans.property.SimpleStringProperty;
import javafx.collections.FXCollections;
import javafx.collections.ListChangeListener;
import javafx.collections.ObservableList;
import javafx.collections.transformation.FilteredList;
import javafx.collections.transformation.SortedList;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.geometry.Insets;
import javafx.scene.Node;
import javafx.scene.control.Alert;
import javafx.scene.control.ButtonBar;
import javafx.scene.control.ButtonType;
import javafx.scene.control.ComboBox;
import javafx.scene.control.DatePicker;
import javafx.scene.control.Dialog;
import javafx.scene.control.Label;
import javafx.scene.control.ListCell;
import javafx.scene.control.ListView;
import javafx.scene.control.SelectionMode;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableRow;
import javafx.scene.control.TableView;
import javafx.scene.control.TextArea;
import javafx.scene.control.TextField;
import javafx.scene.layout.GridPane;
import javafx.scene.layout.HBox;
import javafx.scene.layout.VBox;
import javafx.stage.Modality;
import javafx.stage.Window;

public class MaintenanceController {

    @FXML private Label userLabel;

    @FXML private TableView<Maintenance> maintenanceTable;
	@FXML private TableColumn<Maintenance,String> idColumn;
	@FXML private TableColumn<Maintenance,String> typeColumn;
	@FXML private TableColumn<Maintenance,String> vendorColumn;
	@FXML private TableColumn<Maintenance,String> startDateColumn;
	@FXML private TableColumn<Maintenance,String> endDateColumn;
	@FXML private TableColumn<Maintenance,String> simCountColumn;
	@FXML private TableColumn<Maintenance,String> notesColumn;


    @FXML private TextField        searchField;
    @FXML private ComboBox<String> sortByCombo;
    @FXML private Label            infoLabel;

    private final DateTimeFormatter dateFmt =
            DateTimeFormatter.ofPattern("yyyy-MM-dd");

    private final ObservableList<Maintenance> masterData =
            FXCollections.observableArrayList();
    private FilteredList<Maintenance> filteredData;
    private SortedList<Maintenance>   sortedData;

    // Helper row for detail dialog
    private static class SimStatusRow {
        final Simulator simulator;
        final ComboBox<String> combo;

        SimStatusRow(Simulator simulator, ComboBox<String> combo) {
            this.simulator = simulator;
            this.combo = combo;
        }
    }

    // =========================================================
    // Initialization
    // =========================================================
    @FXML
    public void initialize() {
        // Show logged-in user
        LoggedInUser u = AppSession.getCurrentUser();
        if (u != null && userLabel != null) {
            StringBuilder sb = new StringBuilder();

            if (u.getDisplayName() != null && !u.getDisplayName().isBlank()) {
                sb.append(u.getDisplayName());
            } else if (u.getUsername() != null) {
                sb.append(u.getUsername());
            }

            if (u.getRole() != null && !u.getRole().isBlank()) {
                sb.append(" (").append(u.getRole()).append(")");
            }

            if (u.getBranchName() != null && !u.getBranchName().isBlank()) {
                sb.append(" · ").append(u.getBranchName());
            }

            if (u.getEmail() != null && !u.getEmail().isBlank()) {
                sb.append(" · ").append(u.getEmail());
            }

            userLabel.setText(sb.toString());
        }

        // Table columns
        idColumn.setCellValueFactory(cd ->
                new SimpleStringProperty(
                        cd.getValue().getId() != null
                                ? cd.getValue().getId().toString()
                                : ""
                ));
		notesColumn.setCellValueFactory(cd ->
        		new SimpleStringProperty(
        		        cd.getValue().getEventNotes() != null
        		                ? cd.getValue().getEventNotes()
        		                : ""
        		));


        typeColumn.setCellValueFactory(cd ->
                new SimpleStringProperty(
                        cd.getValue().getType() != null
                                ? cd.getValue().getType()
                                : ""
                ));

        vendorColumn.setCellValueFactory(cd ->
                new SimpleStringProperty(
                        cd.getValue().getVendor() != null
                                ? cd.getValue().getVendor()
                                : ""
                ));

        startDateColumn.setCellValueFactory(cd ->
                new SimpleStringProperty(
                        cd.getValue().getEventStartDate() != null
                                ? cd.getValue().getEventStartDate().format(dateFmt)
                                : ""
                ));

        endDateColumn.setCellValueFactory(cd ->
                new SimpleStringProperty(
                        cd.getValue().getEventEndDate() != null
                                ? cd.getValue().getEventEndDate().format(dateFmt)
                                : ""
                ));

        simCountColumn.setCellValueFactory(cd ->
                new SimpleStringProperty(
                        cd.getValue().getMaintainedItems() != null
                                ? Integer.toString(cd.getValue().getMaintainedItems().size())
                                : "0"
                ));

        // Wrappers
        filteredData = new FilteredList<>(masterData, m -> true);
        sortedData   = new SortedList<>(filteredData);
        sortedData.comparatorProperty().bind(maintenanceTable.comparatorProperty());
        maintenanceTable.setItems(sortedData);

        // Double-click row to open details (always fresh from DB)
        maintenanceTable.setRowFactory(tv -> {
            TableRow<Maintenance> row = new TableRow<>();
            row.setOnMouseClicked(ev -> {
                if (ev.getClickCount() == 2 && !row.isEmpty()) {
                    Maintenance selected = row.getItem();
                    if (selected != null && selected.getId() != null) {
                        openMaintenanceDetailDialog(selected.getId());
                    }
                }
            });
            return row;
        });

        setupSearch();
        setupSortCombo();
        loadMaintenance();
    }

    // =========================================================
    // Data loading & filtering
    // =========================================================
    private String branchFilter(LoggedInUser user) {
        if (user == null) return null;
        if (user.getRole() != null && user.getRole().equalsIgnoreCase("ADMIN")) {
            return null;    // admin sees all branches
        }
        return user.getBranchName();      // Beirut / Byblos
    }

    private void loadMaintenance() {
        LoggedInUser u = AppSession.getCurrentUser();
        String branch = branchFilter(u);

        EntityManager em = JPA.em();
        try {
            String jpql =
                    "SELECT DISTINCT m " +
                    "FROM Maintenance m " +
                    "JOIN FETCH m.maintainedItems mt " +
                    "JOIN mt.simulator s " +
                    "WHERE (:branch IS NULL OR s.branch.name = :branch) " +
                    "ORDER BY m.eventStartDate DESC, m.id DESC";

            TypedQuery<Maintenance> q = em.createQuery(jpql, Maintenance.class);
            q.setParameter("branch", branch);

            List<Maintenance> list = q.getResultList();
            masterData.setAll(list);

            if (infoLabel != null) {
                infoLabel.setText(list.isEmpty()
                        ? "No maintenance events found."
                        : "");
            }
        } catch (Exception e) {
            if (infoLabel != null) {
                infoLabel.setText("Error loading maintenance: " + e.getMessage());
            }
            e.printStackTrace();
        } finally {
            em.close();
        }
    }

    private void setupSearch() {
        if (searchField == null) return;

        searchField.textProperty().addListener((obs, old, value) -> {
            String needle = (value == null) ? "" : value.trim().toLowerCase();

            filteredData.setPredicate(m -> {
                if (needle.isEmpty()) return true;

                if (m.getId() != null &&
                        m.getId().toString().contains(needle)) return true;

                if (m.getType() != null &&
                        m.getType().toLowerCase().contains(needle)) return true;

                if (m.getVendor() != null &&
                        m.getVendor().toLowerCase().contains(needle)) return true;

                if (m.getEventNotes() != null &&
                        m.getEventNotes().toLowerCase().contains(needle)) return true;

                if (m.getEventStartDate() != null &&
                        m.getEventStartDate().format(dateFmt).toLowerCase().contains(needle))
                    return true;

                if (m.getEventEndDate() != null &&
                        m.getEventEndDate().format(dateFmt).toLowerCase().contains(needle))
                    return true;

                if (m.getMaintainedItems() != null &&
                        Integer.toString(m.getMaintainedItems().size()).contains(needle))
                    return true;

                return false;
            });
        });
    }

    private void setupSortCombo() {
        if (sortByCombo == null) return;

        sortByCombo.setItems(FXCollections.observableArrayList(
                "Start date", "End date", "Type", "Vendor", "ID", "# Sims"
        ));
        sortByCombo.getSelectionModel().select("Start date");

        sortByCombo.getSelectionModel().selectedItemProperty().addListener((obs, old, sel) -> {
            if (sel == null) return;

            maintenanceTable.getSortOrder().clear();
            TableColumn<Maintenance, ?> col = null;

            switch (sel) {
                case "Start date": col = startDateColumn;  break;
                case "End date":   col = endDateColumn;    break;
                case "Type":       col = typeColumn;       break;
                case "Vendor":     col = vendorColumn;     break;
                case "ID":         col = idColumn;         break;
                case "# Sims":     col = simCountColumn;   break;
            }

            if (col != null) {
                col.setSortType(TableColumn.SortType.DESCENDING);
                maintenanceTable.getSortOrder().add(col);
                maintenanceTable.sort();
            }
        });
    }

    // =========================================================
    // Actions – creation
    // =========================================================
    @FXML
    private void onAddMaintenance() {
        LoggedInUser u = AppSession.getCurrentUser();
        if (u == null) {
            if (infoLabel != null)
                infoLabel.setText("You must be logged in to add maintenance.");
            return;
        }

        EntityManager em = JPA.em();
        try {
            // Load simulators (AVAILABLE / OUT_OF_SERVICE) for user branch (or all for admin)
            boolean filterByBranch = (u.getBranchName() != null &&
                    !u.getBranchName().isBlank() &&
                    (u.getRole() == null ||
                     !u.getRole().equalsIgnoreCase("ADMIN")));

            String jpql = "SELECT s FROM Simulator s " +
                          "WHERE s.status IN (:avail, :oos)";
            if (filterByBranch) {
                jpql += " AND s.branch.name = :branchName";
            }
            jpql += " ORDER BY s.tag";

            TypedQuery<Simulator> q = em.createQuery(jpql, Simulator.class);
            q.setParameter("avail", Status.SIM_AVAILABLE);
            q.setParameter("oos",   Status.SIM_OUT_OF_SERVICE);
            if (filterByBranch) {
                q.setParameter("branchName", u.getBranchName());
            }

            List<Simulator> sims = q.getResultList();
            if (sims.isEmpty()) {
                if (infoLabel != null)
                    infoLabel.setText(
                            "No simulators with status AVAILABLE or OUT_OF_SERVICE " +
                            "found for your branch.");
                return;
            }

            Dialog<NewMaintenanceData> dialog = new Dialog<>();
            Window owner = maintenanceTable.getScene() != null
                    ? maintenanceTable.getScene().getWindow()
                    : null;
            if (owner != null) dialog.initOwner(owner);
            dialog.initModality(Modality.WINDOW_MODAL);

            dialog.setTitle("New maintenance event");
            dialog.setHeaderText("Create a maintenance event and choose one or more simulators.");

            ButtonType saveButtonType =
                    new ButtonType("Save", ButtonBar.ButtonData.OK_DONE);
            dialog.getDialogPane().getButtonTypes().addAll(saveButtonType, ButtonType.CANCEL);

            TextField typeField = new TextField();
            typeField.setPromptText("Type (e.g. Preventive, Calibration, Repair)");

            DatePicker startPicker = new DatePicker(LocalDate.now());
            startPicker.setPromptText("Start date (required)");

            TextField vendorField = new TextField();
            vendorField.setPromptText("Vendor / contractor (optional)");

            TextArea notesArea = new TextArea();
            notesArea.setPromptText("Notes (optional)");
            notesArea.setPrefRowCount(3);

            ListView<Simulator> simList = new ListView<>();
            simList.getItems().addAll(sims);
            simList.getSelectionModel().setSelectionMode(SelectionMode.MULTIPLE);
            simList.setPrefHeight(220);

            // Rich info for each simulator (from SIMULATOR + SIMULATOR_MODEL)
            simList.setCellFactory(list -> new ListCell<>() {
                @Override
                protected void updateItem(Simulator s, boolean empty) {
                    super.updateItem(s, empty);
                    if (empty || s == null) {
                        setText(null);
                    } else {
                        String tag   = s.getTag() != null ? s.getTag() : "SIM#" + s.getId();
                        String model = (s.getModel() != null && s.getModel().getModelName() != null)
                                ? s.getModel().getModelName()
                                : "No model";
                        String branch = (s.getBranch() != null && s.getBranch().getName() != null)
                                ? s.getBranch().getName()
                                : "No branch";
                        String status = s.getStatus() != null ? s.getStatus() : "UNKNOWN";
                        String sn     = (s.getSerialNumber() != null && !s.getSerialNumber().isBlank())
                                ? s.getSerialNumber()
                                : "n/a";
                        String cal    = s.getCalibrationDate() != null
                                ? s.getCalibrationDate().toString()
                                : "n/a";
                        String nextCal = s.getNextCalibrationDate() != null
                                ? s.getNextCalibrationDate().toString()
                                : "n/a";

                        String calReq = "n/a";
                        String maxDays = "n/a";
                        if (s.getModel() != null) {
                            if (s.getModel().getCalReq() != null) {
                                calReq = s.getModel().getCalReq() ? "Yes" : "No";
                            }
                            if (s.getModel().getMaxDays() != null) {
                                maxDays = s.getModel().getMaxDays().toString();
                            }
                        }

                        String cond = (s.getConditionNotes() != null && !s.getConditionNotes().isBlank())
                                ? s.getConditionNotes()
                                : "";

                        StringBuilder sb = new StringBuilder();
                        sb.append(tag).append(" · ").append(model).append(" · ").append(branch).append("\n");
                        sb.append("SN: ").append(sn)
                          .append(" | Status: ").append(status).append("\n");
                        sb.append("Cal: ").append(cal)
                          .append(" | Next cal: ").append(nextCal).append("\n");
                        sb.append("Model cal required: ").append(calReq)
                          .append(" | Max days: ").append(maxDays);
                        if (!cond.isEmpty()) {
                            sb.append("\nCond notes: ").append(cond);
                        }

                        setText(sb.toString());
                    }
                }
            });

            GridPane grid = new GridPane();
            grid.setHgap(10);
            grid.setVgap(8);
            grid.setPadding(new Insets(10, 10, 10, 10));

            int row = 0;
            grid.add(new Label("Type:"), 0, row);
            grid.add(typeField,        1, row++);

            grid.add(new Label("Start date:"), 0, row);
            grid.add(startPicker,             1, row++);

            grid.add(new Label("Vendor:"), 0, row);
            grid.add(vendorField,          1, row++);

            grid.add(new Label("Notes:"), 0, row);
            grid.add(notesArea,           1, row++);

            grid.add(new Label("Simulators (multi-select):"), 0, row);
            grid.add(simList,                           1, row++);

            Label hint = new Label(
                    "Tip: hold Ctrl (or Cmd on macOS) to select multiple simulators.");
            hint.setStyle("-fx-text-fill: #6b7280; -fx-font-size: 10px;");
            grid.add(hint, 1, row);

            dialog.getDialogPane().setContent(grid);

            Node saveButton = dialog.getDialogPane().lookupButton(saveButtonType);
            saveButton.setDisable(true);

            Runnable validate = () -> {
                String type = typeField.getText() == null ? "" : typeField.getText().trim();
                LocalDate sd = startPicker.getValue();
                boolean hasSims = !simList.getSelectionModel().getSelectedItems().isEmpty();
                saveButton.setDisable(type.isEmpty() || sd == null || !hasSims);
            };

            typeField.textProperty().addListener((o, ov, nv) -> validate.run());
            startPicker.valueProperty().addListener((o, ov, nv) -> validate.run());
            simList.getSelectionModel().getSelectedItems().addListener(
                    (ListChangeListener<Simulator>) change -> validate.run()
            );

            dialog.setResultConverter(btn -> {
                if (btn == saveButtonType) {
                    String type  = typeField.getText().trim();
                    LocalDate sd = startPicker.getValue();

                    String vendor = vendorField.getText() == null
                            ? ""
                            : vendorField.getText().trim();
                    String notes  = notesArea.getText() == null
                            ? ""
                            : notesArea.getText().trim();

                    List<Simulator> selected =
                            List.copyOf(simList.getSelectionModel().getSelectedItems());

                    return new NewMaintenanceData(type, sd, vendor, notes, selected);
                }
                return null;
            });

            Optional<NewMaintenanceData> result = dialog.showAndWait();
            if (result.isEmpty()) return; // cancelled

            NewMaintenanceData data = result.get();

            em.getTransaction().begin();

            Integer nextId = ((Number) em.createQuery(
                    "SELECT COALESCE(MAX(m.id), 0) FROM Maintenance m",
                    Number.class
            ).getSingleResult()).intValue() + 1;

            Maintenance m = new Maintenance();
            m.setId(nextId);
            m.setType(data.type());
            m.setEventStartDate(data.startDate());
            // End date stays null; it will be set when all simulators are returned

            String v  = data.vendor() == null ? "" : data.vendor().trim();
            String nt = data.notes()  == null ? "" : data.notes().trim();
            m.setVendor(v.isEmpty() ? null : v);
            m.setEventNotes(nt.isEmpty() ? null : nt);

            // Link simulators + move them to SIM_MAINTENANCE
            for (Simulator sForm : data.simulators()) {
                if (sForm.getId() == null) continue;

                Simulator managedSim = em.getReference(Simulator.class, sForm.getId());
                managedSim.setStatus(Status.SIM_MAINTENANCE);

                Maintained link = new Maintained();
                link.setSimulator(managedSim);
                m.addMaintained(link);
            }

            em.persist(m);
            em.getTransaction().commit();

            loadMaintenance();
            maintenanceTable.refresh();

            if (infoLabel != null) {
                infoLabel.setText("Maintenance event #" + m.getId() +
                        " created for " + data.simulators().size() + " simulator(s).");
            }

        } catch (Exception e) {
            e.printStackTrace();
            if (em.getTransaction().isActive()) {
                em.getTransaction().rollback();
            }
            if (infoLabel != null) {
                infoLabel.setText("Error creating maintenance event: " + e.getMessage());
            }
        } finally {
            em.close();
        }
    }

    private record NewMaintenanceData(
            String type,
            LocalDate startDate,
            String vendor,
            String notes,
            List<Simulator> simulators
    ) {}

    // =========================================================
    // Actions – detail dialog (returns & end date)
    // =========================================================
    private void openMaintenanceDetailDialog(Integer maintenanceId) {
        EntityManager em = JPA.em();
        try {
            Maintenance m = em.find(Maintenance.class, maintenanceId);
            if (m == null) {
                if (infoLabel != null) {
                    infoLabel.setText("Maintenance event no longer exists.");
                }
                return;
            }

            // Force load of associations
            m.getMaintainedItems().size();

            final boolean isClosed = (m.getEventEndDate() != null);

            Dialog<ButtonType> dialog = new Dialog<>();
            Window owner = maintenanceTable.getScene() != null
                    ? maintenanceTable.getScene().getWindow()
                    : null;
            if (owner != null) dialog.initOwner(owner);
            dialog.initModality(Modality.WINDOW_MODAL);

            dialog.setTitle("Maintenance #" + m.getId());
            dialog.setHeaderText(isClosed
                    ? "Maintenance event is closed (end date: " + m.getEventEndDate() + ")."
                    : "Set return status for simulators in this maintenance event.");

            VBox content = new VBox(10);
            content.setPadding(new Insets(10));

            List<SimStatusRow> rows = new java.util.ArrayList<>();

            for (Maintained link : m.getMaintainedItems()) {
                Simulator s = link.getSimulator();

                HBox line = new HBox(10);

                // Build rich info block
                VBox simBox = new VBox(2);

                String tag   = s.getTag() != null ? s.getTag() : "SIM#" + s.getId();
                String model = (s.getModel() != null && s.getModel().getModelName() != null)
                        ? s.getModel().getModelName()
                        : "No model";
                String branch = (s.getBranch() != null && s.getBranch().getName() != null)
                        ? s.getBranch().getName()
                        : "No branch";
                String status = s.getStatus() != null ? s.getStatus() : "UNKNOWN";
                String sn     = (s.getSerialNumber() != null && !s.getSerialNumber().isBlank())
                        ? s.getSerialNumber()
                        : "n/a";
                String cal    = s.getCalibrationDate() != null
                        ? s.getCalibrationDate().toString()
                        : "n/a";
                String nextCal = s.getNextCalibrationDate() != null
                        ? s.getNextCalibrationDate().toString()
                        : "n/a";

                String calReq = "n/a";
                String maxDays = "n/a";
                if (s.getModel() != null) {
                    if (s.getModel().getCalReq() != null) {
                        calReq = s.getModel().getCalReq() ? "Yes" : "No";
                    }
                    if (s.getModel().getMaxDays() != null) {
                        maxDays = s.getModel().getMaxDays().toString();
                    }
                }

                String cond = (s.getConditionNotes() != null && !s.getConditionNotes().isBlank())
                        ? s.getConditionNotes()
                        : "";

                Label l1 = new Label(tag + " · " + model + " · " + branch + " | SN: " + sn);
                Label l2 = new Label("Status: " + status +
                        " | Cal: " + cal + " | Next cal: " + nextCal);
                Label l3 = new Label("Model cal required: " + calReq +
                        " | Max days: " + maxDays);
                simBox.getChildren().addAll(l1, l2, l3);
                if (!cond.isEmpty()) {
                    Label l4 = new Label("Cond notes: " + cond);
                    simBox.getChildren().add(l4);
                }
                simBox.setMinWidth(420);

                line.getChildren().add(simBox);

                if (!isClosed && Status.SIM_MAINTENANCE.equals(status)) {
                    ComboBox<String> combo = new ComboBox<>();
                    combo.getItems().addAll(
                            "Keep in maintenance",
                            Status.SIM_AVAILABLE,
                            Status.SIM_OUT_OF_SERVICE
                    );
                    combo.setValue("Keep in maintenance");
                    line.getChildren().add(new Label("New status:"));
                    line.getChildren().add(combo);
                    rows.add(new SimStatusRow(s, combo));
                } else {
                    String msg = isClosed
                            ? "Event closed"
                            : "Already returned (" + status + ")";
                    Label done = new Label(msg);
                    done.setStyle("-fx-text-fill: #16a34a;");
                    line.getChildren().add(done);
                }

                content.getChildren().add(line);
            }

            if (isClosed) {
                dialog.getDialogPane().getButtonTypes().setAll(ButtonType.CLOSE);
            } else {
                ButtonType saveButtonType =
                        new ButtonType("Save changes", ButtonBar.ButtonData.OK_DONE);
                dialog.getDialogPane().getButtonTypes().setAll(saveButtonType, ButtonType.CANCEL);

                dialog.setResultConverter(btn -> btn);
            }

            dialog.getDialogPane().setContent(content);

            Optional<ButtonType> result = dialog.showAndWait();
            if (isClosed || result.isEmpty()) {
                return; // closed event is read-only OR user cancelled
            }
            if (result.get().getButtonData() != ButtonBar.ButtonData.OK_DONE) {
                return;
            }

            // Apply changes for open events
            em.getTransaction().begin();

            for (SimStatusRow row : rows) {
                String choice = row.combo.getValue();
                if (choice == null || "Keep in maintenance".equals(choice)) {
                    continue; // no change
                }

                Simulator managedSim = em.getReference(Simulator.class, row.simulator.getId());
                managedSim.setStatus(choice);
            }

            // Check if any simulator remains SIM_MAINTENANCE
            Long countStillMaint = em.createQuery(
                    "SELECT COUNT(mt) FROM Maintained mt " +
                    "JOIN mt.simulator s " +
                    "WHERE mt.maintenance.id = :mid " +
                    "AND s.status = :stat", Long.class)
                    .setParameter("mid", m.getId())
                    .setParameter("stat", Status.SIM_MAINTENANCE)
                    .getSingleResult();

            boolean anyStillMaintenance =
                    (countStillMaint != null && countStillMaint > 0);

            // Only set end date if it is currently null
            if (!anyStillMaintenance && m.getEventEndDate() == null) {
                m.setEventEndDate(LocalDate.now());
            }

            em.getTransaction().commit();

            // Reload fresh data so the next dialog is always correct
            loadMaintenance();
            maintenanceTable.refresh();

            if (infoLabel != null) {
                if (!anyStillMaintenance && m.getEventEndDate() != null) {
                    infoLabel.setText("All simulators returned; maintenance #" + m.getId() +
                            " closed with end date " + m.getEventEndDate());
                } else {
                    infoLabel.setText("Maintenance #" + m.getId() + " updated.");
                }
            }

        } catch (Exception e) {
            e.printStackTrace();
            if (em.getTransaction().isActive()) {
                em.getTransaction().rollback();
            }
            if (infoLabel != null) {
                infoLabel.setText("Error updating maintenance: " + e.getMessage());
            }
        } finally {
            em.close();
        }
    }

    // =========================================================
    // Navigation
    // =========================================================
    @FXML
    private void onNavOverview(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/home.fxml", "Main Menu");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @FXML
    private void onNavSimulators(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/simulators.fxml", "Simulators");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @FXML
    private void onNavStock(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/stock.fxml", "Stock");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

	@FXML
	private void onNavUsers(ActionEvent event) {
	    LoggedInUser u = AppSession.getCurrentUser();
	    if (u == null || u.getRole() == null || !u.getRole().equalsIgnoreCase("ADMIN")) {
	        Alert a = new Alert(Alert.AlertType.WARNING);
	        a.setTitle("Access denied");
	        a.setHeaderText(null);
	        a.setContentText("Only ADMIN users can manage users.");
	        a.showAndWait();
	        return;
	    }
	
	    try {
	        ViewUtil.switchScene(event, "/ui/users.fxml", "Users");
	    } catch (Exception e) {
	        e.printStackTrace();
	    }
	}


	
    @FXML
    private void onLogout(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/login.fxml", "Login");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
package com.example.ui;

import java.time.LocalDate;

public class MaintenanceRow {
    private final LocalDate date;
    private final String simulator;
    private final String type;
    private final String vendor;

    public MaintenanceRow(LocalDate date, String simulator, String type, String vendor) {
        this.date = date;
        this.simulator = simulator;
        this.type = type;
        this.vendor = vendor;
    }

    public LocalDate getDate()      { return date; }
    public String getSimulator()    { return simulator; }
    public String getType()         { return type; }
    public String getVendor()       { return vendor; }
}
package com.example.ui;

import java.time.LocalDate;
import java.util.List;

import javax.persistence.EntityManager;
import javax.persistence.TypedQuery;

import com.example.domain.Status;
import com.example.session.LoggedInUser;

public class OverviewService {

    /**
     * If user is ADMIN -> null (no branch filter).
     * Otherwise -> user's branch name (Beirut / Byblos).
     */
    private String branchFilter(LoggedInUser user) {
        if (user == null) return null;
        if (user.getRole() != null && user.getRole().equalsIgnoreCase("ADMIN")) {
            return null;        // ADMIN sees everything
        }
        return user.getBranchName();      // Beirut or Byblos
    }

    public OverviewStats loadStats(EntityManager em, LoggedInUser user) {
        String branch = branchFilter(user);

        // 1) Total simulators (only AVAILABLE)
		TypedQuery<Long> q1 = em.createQuery(
		        "SELECT COUNT(s) FROM Simulator s " +
		        "WHERE s.status = :availStatus " +
		        "AND (:branch IS NULL OR s.branch.name = :branch)",
		        Long.class);
		q1.setParameter("availStatus", Status.SIM_AVAILABLE);
		q1.setParameter("branch", branch);
		long totalSims = q1.getSingleResult();


        // 2) Active borrowings (ACTIVE + PARTIALLY_RETURNED)
        TypedQuery<Long> q2 = em.createQuery(
                "SELECT COUNT(b) FROM Borrowing b " +
                "WHERE b.status IN (:s1, :s2) " +
                "AND (:branch IS NULL OR b.branch.name = :branch)",
                Long.class);
        q2.setParameter("s1", Status.BORROW_ACTIVE);
        q2.setParameter("s2", Status.BORROW_PARTIAL_RETURN);
        q2.setParameter("branch", branch);
        long activeBorrows = q2.getSingleResult();

        // 3) Upcoming calibrations (next 30 days)
        LocalDate today = LocalDate.now();
        LocalDate limit = today.plusDays(30);

        TypedQuery<Long> q3 = em.createQuery(
                "SELECT COUNT(s) FROM Simulator s " +
                "WHERE s.nextCalibrationDate BETWEEN :start AND :end " +
                "AND (:branch IS NULL OR s.branch.name = :branch)",
                Long.class);
        q3.setParameter("start", today);
        q3.setParameter("end",   limit);
        q3.setParameter("branch", branch);
        long upcomingCal = q3.getSingleResult();

        return new OverviewStats(totalSims, activeBorrows, upcomingCal);
    }

    public List<MaintenanceRow> loadRecentMaintenance(EntityManager em, LoggedInUser user) {
        String branch = branchFilter(user);

        TypedQuery<MaintenanceRow> q = em.createQuery(
            "SELECT new com.example.ui.MaintenanceRow(" +
            "   m.eventStartDate, s.tag, m.type, m.vendor) " +
            "FROM Maintained mt " +
            "JOIN mt.maintenance m " +
            "JOIN mt.simulator s " +
            "WHERE (:branch IS NULL OR s.branch.name = :branch) " +
            "ORDER BY m.eventStartDate DESC",
            MaintenanceRow.class
        );
        q.setParameter("branch", branch);
        //q.setMaxResults(10);
        return q.getResultList();
    }

    public List<LowStockRow> loadLowStock(EntityManager em, LoggedInUser user) {
        String branch = branchFilter(user);

        // THRESHOLD: tweak as you like (<= 5 units now)
        int threshold = 5;

        TypedQuery<LowStockRow> q = em.createQuery(
            "SELECT new com.example.ui.LowStockRow(" +
            "   c.itemName, b.name, s.availableQuantity, s.reservedQuantity) " +
            "FROM Stock s " +
            "JOIN s.consumable c " +
            "JOIN s.branch b " +
            "WHERE (:branch IS NULL OR b.name = :branch) " +
            "AND s.availableQuantity IS NOT NULL " +
            "AND s.availableQuantity <= :th " +
            "ORDER BY s.availableQuantity ASC",
            LowStockRow.class
        );
        q.setParameter("branch", branch);
        q.setParameter("th", threshold);
        //q.setMaxResults(10);
        return q.getResultList();
    }
}
package com.example.ui;

public class OverviewStats {
    private final long totalSimulators;
    private final long activeBorrowings;
    private final long upcomingCalibrations;

    public OverviewStats(long totalSimulators,
                         long activeBorrowings,
                         long upcomingCalibrations) {
        this.totalSimulators = totalSimulators;
        this.activeBorrowings = activeBorrowings;
        this.upcomingCalibrations = upcomingCalibrations;
    }

    public long getTotalSimulators()     { return totalSimulators; }
    public long getActiveBorrowings()    { return activeBorrowings; }
    public long getUpcomingCalibrations(){ return upcomingCalibrations; }
}
package com.example.ui;

import java.security.SecureRandom;
import java.util.ArrayList;
import java.util.Collections;
import java.util.List;

import org.mindrot.jbcrypt.BCrypt;

public final class PasswordUtil {

    private static final String UPPER = "ABCDEFGHIJKLMNOPQRSTUVWXYZ";
    private static final String LOWER = "abcdefghijklmnopqrstuvwxyz";
    private static final String DIGIT = "0123456789";

    private static final String ALL = UPPER + LOWER + DIGIT;
    private static final SecureRandom RANDOM = new SecureRandom();

    private PasswordUtil() {}

    /**
     * Hash a raw password using BCrypt with strength 12.
     */
    public static String hash(String raw) {
        return BCrypt.hashpw(raw, BCrypt.gensalt(12));
    }

    /**
     * Verify a raw password against a stored BCrypt hash.
     */
    public static boolean verify(String raw, String hash) {
        return hash != null && BCrypt.checkpw(raw, hash);
    }

    /**
     * Generate a strong password that satisfies the policy:
     * - at least 8 characters
     * - at least one uppercase, one lowercase, one digit.
     *
     * @param length desired length (minimum 8 will be enforced)
     * @return generated password as plain text (you should hash it before storing)
     */
    public static String generateStrongPassword(int length) {
        int len = Math.max(length, 8);

        List<Character> chars = new ArrayList<>();

        // Ensure at least one of each category
        chars.add(randomChar(UPPER));
        chars.add(randomChar(LOWER));
        chars.add(randomChar(DIGIT));

        // Fill the rest with random characters from all pools
        for (int i = chars.size(); i < len; i++) {
            chars.add(randomChar(ALL));
        }

        // Shuffle to avoid predictable positions
        Collections.shuffle(chars, RANDOM);

        StringBuilder sb = new StringBuilder(len);
        for (char c : chars) {
            sb.append(c);
        }
        return sb.toString();
    }

    private static char randomChar(String pool) {
        int idx = RANDOM.nextInt(pool.length());
        return pool.charAt(idx);
    }
}
package com.example.ui;

import javax.persistence.EntityManager;

import com.example.app.JPA;
import com.example.app.ViewUtil;
import com.example.domain.User;
import com.example.session.AppSession;
import com.example.session.LoggedInUser;

import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.scene.control.Label;
import javafx.scene.control.PasswordField;
import javafx.scene.control.TextField;

public class SetPasswordController {

    @FXML private TextField usernameField;
    @FXML private PasswordField pass1;
    @FXML private PasswordField pass2;
    @FXML private Label errorLabel;

    private final String username;
    private final UserRepository repo = new UserRepository();

    // Injected from LoginController
    public SetPasswordController(String username) {
        this.username = username;
    }

    @FXML
    public void initialize() {
        if (usernameField != null) {
            usernameField.setText(username);
        }
    }

    @FXML
    public void onSave(ActionEvent event) {
        errorLabel.setText("");

        String p1 = pass1.getText();
        String p2 = pass2.getText();

        if (p1 == null || p1.length() < 8) {
            errorLabel.setText("Password must be at least 8 characters.");
            return;
        }

        if (!p1.matches("(?=.*[A-Z])(?=.*[a-z])(?=.*\\d).{8,}")) {
            errorLabel.setText("Password must contain upper, lower case letters and a digit.");
            return;
        }

        if (!p1.equals(p2)) {
            errorLabel.setText("Passwords do not match.");
            return;
        }

        EntityManager em = JPA.em();
        try {
            em.getTransaction().begin();

            User u = repo.findByUsername(em, username);
            if (u == null) {
                errorLabel.setText("User disappeared!");
                em.getTransaction().rollback();
                return;
            }

            // Set new password + flags
            u.setPassHash(PasswordUtil.hash(p1));
            u.setReset(Boolean.FALSE);
            if (u.getIsActive() == null) {
                u.setIsActive(Boolean.TRUE);
            }

            repo.save(em, u);
            em.getTransaction().commit();

            // Put this user into the global session
            AppSession.setCurrentUser(
                    new LoggedInUser(
                            u.getId(),
                            u.getUsername(),
                            u.getDisplayName(),
                            u.getRole(),
                            u.getEmail(),
                            (u.getBranch() != null ? u.getBranch().getName() : null)
                    )
            );

            // Go to Home using SAME Stage
            ViewUtil.switchScene(event, "/ui/home.fxml", "Main Menu");

        } catch (Exception ex) {
            if (em.getTransaction().isActive()) em.getTransaction().rollback();
            errorLabel.setText("Error: " + ex.getMessage());
        } finally {
            em.close();
        }
    }
}
package com.example.ui;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Optional;

import javax.persistence.EntityManager;
import javax.persistence.TypedQuery;

import com.example.app.JPA;
import com.example.app.ViewUtil;
import com.example.domain.Branch;
import com.example.domain.Simulator;
import com.example.domain.SimulatorModel;
import com.example.domain.Status;
import com.example.session.AppSession;
import com.example.session.LoggedInUser;

import javafx.beans.property.SimpleStringProperty;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.collections.transformation.FilteredList;
import javafx.collections.transformation.SortedList;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.geometry.Insets;
import javafx.scene.Node;
import javafx.scene.control.Alert;
import javafx.scene.control.ButtonBar;
import javafx.scene.control.ButtonType;
import javafx.scene.control.ComboBox;
import javafx.scene.control.DatePicker;
import javafx.scene.control.Dialog;
import javafx.scene.control.Label;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.scene.control.TextField;
import javafx.scene.layout.GridPane;
import javafx.stage.Modality;
import javafx.stage.Window;

public class SimulatorsController {

    @FXML private Label userLabel;

    @FXML private TableView<Simulator> simulatorTable;
    @FXML private TableColumn<Simulator, String> tagColumn;
    @FXML private TableColumn<Simulator, String> modelColumn;
    @FXML private TableColumn<Simulator, String> modelSpecsColumn;
    @FXML private TableColumn<Simulator, String> modelCalReqColumn;
    @FXML private TableColumn<Simulator, String> modelMaxDaysColumn;
    @FXML private TableColumn<Simulator, String> branchColumn;
    @FXML private TableColumn<Simulator, String> statusColumn;
    @FXML private TableColumn<Simulator, String> nextCalColumn;

    @FXML private TextField searchField;
    @FXML private ComboBox<String> sortByCombo;

    @FXML private Label infoLabel;

    private final DateTimeFormatter dateFmt =
            DateTimeFormatter.ofPattern("yyyy-MM-dd");

    // backing list for the table + filtering/sorting wrappers
    private final ObservableList<Simulator> masterData =
            FXCollections.observableArrayList();
    private FilteredList<Simulator> filteredData;
    private SortedList<Simulator> sortedData;

    @FXML
    public void initialize() {
        // Show logged-in user
        LoggedInUser u = AppSession.getCurrentUser();
        if (u != null && userLabel != null) {
            StringBuilder sb = new StringBuilder();

            if (u.getDisplayName() != null && !u.getDisplayName().isBlank()) {
                sb.append(u.getDisplayName());
            } else if (u.getUsername() != null) {
                sb.append(u.getUsername());
            }
            if (u.getRole() != null && !u.getRole().isBlank()) {
                sb.append(" (").append(u.getRole()).append(")");
            }
            if (u.getBranchName() != null && !u.getBranchName().isBlank()) {
                sb.append(" · ").append(u.getBranchName());
            }
            if (u.getEmail() != null && !u.getEmail().isBlank()) {
                sb.append(" · ").append(u.getEmail());
            }
            userLabel.setText(sb.toString());
        }

        tagColumn.setCellValueFactory(cd -> new SimpleStringProperty(cd.getValue().getTag()));

        modelColumn.setCellValueFactory(cd -> new SimpleStringProperty(cd.getValue().getModel() != null ? cd.getValue().getModel().getModelName() : ""));

        modelSpecsColumn.setCellValueFactory(cd ->
                new SimpleStringProperty(
                        cd.getValue().getModel() != null &&
                        cd.getValue().getModel().getSpecs() != null
                                ? cd.getValue().getModel().getSpecs()
                                : ""
                ));

        modelCalReqColumn.setCellValueFactory(cd -> {
            if (cd.getValue().getModel() != null &&
                cd.getValue().getModel().getCalReq() != null) {
                return new SimpleStringProperty(
                        cd.getValue().getModel().getCalReq() ? "Yes" : "No"
                );
            }
            return new SimpleStringProperty("");
        });

        modelMaxDaysColumn.setCellValueFactory(cd -> {
            if (cd.getValue().getModel() != null &&
                cd.getValue().getModel().getMaxDays() != null) {
                return new SimpleStringProperty(
                        cd.getValue().getModel().getMaxDays().toString()
                );
            }
            return new SimpleStringProperty("");
        });

        branchColumn.setCellValueFactory(cd ->
                new SimpleStringProperty(
                        cd.getValue().getBranch() != null
                                ? cd.getValue().getBranch().getName()
                                : ""
                ));

        statusColumn.setCellValueFactory(cd ->
                new SimpleStringProperty(
                        cd.getValue().getStatus() != null
                                ? cd.getValue().getStatus()
                                : ""
                ));

        nextCalColumn.setCellValueFactory(cd ->
                new SimpleStringProperty(
                        cd.getValue().getNextCalibrationDate() != null
                                ? cd.getValue().getNextCalibrationDate().format(dateFmt)
                                : ""
                ));

        // Wrap master data with Filtered + Sorted lists
        filteredData = new FilteredList<>(masterData, s -> true);
        sortedData = new SortedList<>(filteredData);
        sortedData.comparatorProperty().bind(simulatorTable.comparatorProperty());
        simulatorTable.setItems(sortedData);

        setupSearch();
        setupSortCombo();

        loadSimulators();
    }

    /** Load simulators from DB (filtered by user's branch if not admin). */
    private void loadSimulators() {
        LoggedInUser u = AppSession.getCurrentUser();

        EntityManager em = JPA.em();
        try {
            String jpql = "SELECT s FROM Simulator s";
            boolean filterByBranch =
                    (u != null &&
                     u.getBranchName() != null &&
                     !u.getBranchName().isBlank() &&
                     (u.getRole() == null ||
                      !u.getRole().equalsIgnoreCase("ADMIN")));

            if (filterByBranch) {
                // Non-admin: only their own branch
                jpql += " WHERE s.branch.name = :branchName";
            }

            jpql += " ORDER BY s.tag";

            TypedQuery<Simulator> q = em.createQuery(jpql, Simulator.class);
            if (filterByBranch) {
                q.setParameter("branchName", u.getBranchName());
            }

            List<Simulator> sims = q.getResultList();
            masterData.setAll(sims);

            if (infoLabel != null) {
                if (sims.isEmpty()) {
                    infoLabel.setText("No simulators found for your branch.");
                } else {
                    infoLabel.setText("");  // clear
                }
            }
        } catch (Exception e) {
            if (infoLabel != null) {
                infoLabel.setText("Error loading simulators: " + e.getMessage());
            }
            e.printStackTrace();
        } finally {
            em.close();
        }
    }

    /** Live search on main fields. */
    private void setupSearch() {
        if (searchField == null) return;

        searchField.textProperty().addListener((obs, old, value) -> {
            String needle = (value == null) ? "" : value.trim().toLowerCase();

            filteredData.setPredicate(sim -> {
                if (needle.isEmpty()) return true;

                if (sim.getTag() != null &&
                        sim.getTag().toLowerCase().contains(needle)) return true;

                if (sim.getModel() != null &&
                        sim.getModel().getModelName() != null &&
                        sim.getModel().getModelName().toLowerCase().contains(needle)) return true;

                if (sim.getModel() != null &&
                        sim.getModel().getSpecs() != null &&
                        sim.getModel().getSpecs().toLowerCase().contains(needle)) return true;

                if (sim.getBranch() != null &&
                        sim.getBranch().getName() != null &&
                        sim.getBranch().getName().toLowerCase().contains(needle)) return true;

                if (sim.getStatus() != null &&
                        sim.getStatus().toLowerCase().contains(needle)) return true;

                if (sim.getNextCalibrationDate() != null &&
                        sim.getNextCalibrationDate().format(dateFmt).toLowerCase().contains(needle))
                    return true;

                return false;
            });
        });
    }

    /** Sort combo that drives TableView sort order. */
    private void setupSortCombo() {
        if (sortByCombo == null) return;

        sortByCombo.setItems(FXCollections.observableArrayList(
                "Tag", "Model", "Branch", "Status", "Next calibration"
        ));
        sortByCombo.getSelectionModel().select("Tag");

        sortByCombo.getSelectionModel().selectedItemProperty().addListener((obs, old, sel) -> {
            if (sel == null) return;

            simulatorTable.getSortOrder().clear();
            TableColumn<Simulator, ?> col = null;

            switch (sel) {
                case "Tag":              col = tagColumn;     break;
                case "Model":            col = modelColumn;   break;
                case "Branch":           col = branchColumn;  break;
                case "Status":           col = statusColumn;  break;
                case "Next calibration": col = nextCalColumn; break;
                default: break;
            }

            if (col != null) {
                col.setSortType(TableColumn.SortType.ASCENDING);
                simulatorTable.getSortOrder().add(col);
                simulatorTable.sort();
            }
        });
    }

    // -------- Actions from right panel --------

    /** Mark selected simulator as OUT OF SERVICE. */
	@FXML
	private void onMarkOutOfService() {
	    Simulator selected = simulatorTable.getSelectionModel().getSelectedItem();
	    if (selected == null) {
	        if (infoLabel != null)
	            infoLabel.setText("Select a simulator first.");
	        return;
	    }

	    EntityManager em = JPA.em();
	    try {
	        em.getTransaction().begin();

	        // Re-attach the entity from DB (managed instance)
	        Simulator managed = em.merge(selected);

	        // Change the mapped field
	        managed.setStatus(Status.SIM_OUT_OF_SERVICE);

	        // Force SQL generation *now* (before commit)
	        em.flush();

	        em.getTransaction().commit();

	        // Reload table from DB so UI reflects real state
	        loadSimulators();

	        if (infoLabel != null)
	            infoLabel.setText("Simulator marked as OUT OF SERVICE.");
	    } catch (Exception e) {
	        if (em.getTransaction().isActive())
	            em.getTransaction().rollback();
	        if (infoLabel != null)
	            infoLabel.setText("Error updating status: " + e.getMessage());
	        e.printStackTrace();
	    } finally {
	        em.close();
	    }
	}

    @FXML
    private void onAddSimulator() {
        LoggedInUser u = AppSession.getCurrentUser();
        if (u == null || u.getBranchName() == null || u.getBranchName().isBlank()) {
            if (infoLabel != null)
                infoLabel.setText("Cannot determine branch for new simulator.");
            return;
        }

        EntityManager em = JPA.em();
        try {
            // 1) Load ALL models (no branch filter)
            List<SimulatorModel> models = em.createQuery(
                    "SELECT m FROM SimulatorModel m ORDER BY m.modelName",
                    SimulatorModel.class
            ).getResultList();

            if (models.isEmpty()) {
                if (infoLabel != null)
                    infoLabel.setText("No simulator models found. Create a model first.");
                return;
            }

            // 2) Dialog with SIMULATOR fields
            Dialog<Simulator> dialog = new Dialog<>();

            Window owner = simulatorTable.getScene() != null
                    ? simulatorTable.getScene().getWindow()
                    : null;
            if (owner != null) {
                dialog.initOwner(owner);
            }
            dialog.initModality(Modality.WINDOW_MODAL);

            dialog.setTitle("New simulator");
            dialog.setHeaderText("Enter simulator details");

            ButtonType saveButtonType = new ButtonType("Save", ButtonBar.ButtonData.OK_DONE);
            dialog.getDialogPane().getButtonTypes().addAll(saveButtonType, ButtonType.CANCEL);

            ComboBox<SimulatorModel> modelBox = new ComboBox<>();
            modelBox.getItems().addAll(models);
            modelBox.setPrefWidth(260);
            modelBox.getSelectionModel().selectFirst(); // default

            TextField tagField = new TextField();
            tagField.setPromptText("Tag (required)");

            TextField snField = new TextField();
            snField.setPromptText("Serial number (optional)");

            TextField condNotesField = new TextField();
            condNotesField.setPromptText("Condition notes (optional)");

            DatePicker nextCalPicker = new DatePicker();
            nextCalPicker.setPromptText("Next calibration date (optional)");

            GridPane grid = new GridPane();
            grid.setHgap(10);
            grid.setVgap(8);
            grid.setPadding(new Insets(10, 10, 10, 10));

            int row = 0;
            grid.add(new Label("Model:"), 0, row);
            grid.add(modelBox, 1, row++);

            grid.add(new Label("Tag:"), 0, row);
            grid.add(tagField, 1, row++);

            grid.add(new Label("SN:"), 0, row);
            grid.add(snField, 1, row++);

            grid.add(new Label("Condition notes:"), 0, row);
            grid.add(condNotesField, 1, row++);

            grid.add(new Label("Next calibration date:"), 0, row);
            grid.add(nextCalPicker, 1, row++);

            dialog.getDialogPane().setContent(grid);

            // Disable Save until required fields are present
            Node saveButton = dialog.getDialogPane().lookupButton(saveButtonType);
            saveButton.setDisable(true);

            Runnable validate = () -> {
                boolean ok =
                        modelBox.getValue() != null &&
                        tagField.getText() != null &&
                        !tagField.getText().trim().isEmpty();
                saveButton.setDisable(!ok);
            };

            modelBox.valueProperty().addListener((obs, ov, nv) -> validate.run());
            tagField.textProperty().addListener((obs, ov, nv) -> validate.run());

            dialog.setResultConverter(btn -> {
                if (btn == saveButtonType) {
                    SimulatorModel model = modelBox.getValue();
                    if (model == null) return null;

                    Simulator s = new Simulator();
                    s.setModel(model);
                    s.setTag(tagField.getText().trim());

                    String sn = snField.getText() == null ? "" : snField.getText().trim();
                    s.setSerialNumber(sn.isEmpty() ? null : sn);

                    String notes = condNotesField.getText() == null ? "" : condNotesField.getText().trim();
                    s.setConditionNotes(notes.isEmpty() ? null : notes);

                    LocalDate ncd = nextCalPicker.getValue();   // optional
                    s.setNextCalibrationDate(ncd);

                    // Default status
                    s.setStatus(Status.SIM_AVAILABLE);
                    return s;
                }
                return null;
            });

            Optional<Simulator> result = dialog.showAndWait();
            if (result.isEmpty()) {
                return; // cancelled
            }

            Simulator formSim = result.get();

            // 3) Persist to DB
            em.getTransaction().begin();

            // get branch entity for current user
            Branch branch = em.createQuery(
                    "SELECT b FROM Branch b WHERE b.name = :name",
                    Branch.class
            ).setParameter("name", u.getBranchName())
             .getSingleResult();

            Simulator s = new Simulator();
            s.setTag(formSim.getTag());
            s.setModel(em.getReference(SimulatorModel.class, formSim.getModel().getId()));
            s.setBranch(branch);
            s.setStatus(formSim.getStatus());
            s.setSerialNumber(formSim.getSerialNumber());
            s.setConditionNotes(formSim.getConditionNotes());
            s.setNextCalibrationDate(formSim.getNextCalibrationDate());
            // CALDATE can stay null for a new simulator

            em.persist(s);
            em.getTransaction().commit();

            masterData.add(s);

            if (infoLabel != null)
                infoLabel.setText("Simulator added.");

        } catch (Exception e) {
            if (em.getTransaction().isActive())
                em.getTransaction().rollback();
            if (infoLabel != null)
                infoLabel.setText("Error adding simulator: " + e.getMessage());
            e.printStackTrace();
        } finally {
            em.close();
        }
    }

    /**
     * Add a new SIMULATOR_MODEL.
     *
     * Business rule:
     *   - MODEL NAME, SPECS, and MAXDAYS are mandatory.
     *   - CALREQ is optional (checkbox).
     */
    @FXML
    private void onAddModel() {
        Dialog<SimulatorModel> dialog = new Dialog<>();

        Window owner = simulatorTable.getScene() != null
                ? simulatorTable.getScene().getWindow()
                : null;
        if (owner != null) {
            dialog.initOwner(owner);
        }
        dialog.initModality(Modality.WINDOW_MODAL);

        dialog.setTitle("New simulator model");
        dialog.setHeaderText("Create a new simulator model");

        ButtonType saveButtonType = new ButtonType("Save", ButtonBar.ButtonData.OK_DONE);
        dialog.getDialogPane().getButtonTypes().addAll(saveButtonType, ButtonType.CANCEL);

        TextField nameField = new TextField();
        nameField.setPromptText("Model name (required)");

        TextField specsField = new TextField();
        specsField.setPromptText("Specs / notes (required)");

        javafx.scene.control.CheckBox calReqBox =
                new javafx.scene.control.CheckBox("Requires calibration?");
        calReqBox.setSelected(false);

        TextField maxDaysField = new TextField();
        maxDaysField.setPromptText("Max days (integer, required)");

        GridPane grid = new GridPane();
        grid.setHgap(10);
        grid.setVgap(8);
        grid.setPadding(new Insets(10, 10, 10, 10));

        int row = 0;
        grid.add(new Label("Model name:"), 0, row);
        grid.add(nameField, 1, row++);

        grid.add(new Label("Specs:"), 0, row);
        grid.add(specsField, 1, row++);

        grid.add(new Label("Calibration required:"), 0, row);
        grid.add(calReqBox, 1, row++);

        grid.add(new Label("Max days:"), 0, row);
        grid.add(maxDaysField, 1, row++);

        dialog.getDialogPane().setContent(grid);

        Node saveButton = dialog.getDialogPane().lookupButton(saveButtonType);
        saveButton.setDisable(true);

        // Enforce: MODELNAME, SPECS and MAXDAYS (valid int) are mandatory
        Runnable validate = () -> {
            String name  = nameField.getText()  == null ? "" : nameField.getText().trim();
            String specs = specsField.getText() == null ? "" : specsField.getText().trim();
            String max   = maxDaysField.getText() == null ? "" : maxDaysField.getText().trim();

            boolean ok = !name.isEmpty() && !specs.isEmpty();

            if (max.isEmpty()) {
                ok = false;
            } else {
                try {
                    Integer.parseInt(max);
                } catch (NumberFormatException e) {
                    ok = false;
                }
            }

            saveButton.setDisable(!ok);
        };

        nameField.textProperty().addListener((obs, ov, nv) -> validate.run());
        specsField.textProperty().addListener((obs, ov, nv) -> validate.run());
        maxDaysField.textProperty().addListener((obs, ov, nv) -> validate.run());

        dialog.setResultConverter(btn -> {
            if (btn == saveButtonType) {
                SimulatorModel m = new SimulatorModel();
                m.setModelName(nameField.getText().trim());
                m.setSpecs(specsField.getText().trim());
                m.setCalReq(calReqBox.isSelected());

                String maxText = maxDaysField.getText().trim();
                m.setMaxDays(Integer.parseInt(maxText));  // safe thanks to validate()

                return m;
            }
            return null;
        });

        Optional<SimulatorModel> result = dialog.showAndWait();
        if (result.isEmpty()) {
            return; // cancelled
        }

        SimulatorModel formModel = result.get();

        EntityManager em = JPA.em();
        try {
            em.getTransaction().begin();

            SimulatorModel model = new SimulatorModel();
            model.setModelName(formModel.getModelName());
            model.setSpecs(formModel.getSpecs());
            model.setCalReq(formModel.getCalReq());
            model.setMaxDays(formModel.getMaxDays());

            em.persist(model);
            em.getTransaction().commit();

            if (infoLabel != null)
                infoLabel.setText("Simulator model created: " + model.getModelName());
        } catch (Exception e) {
            if (em.getTransaction().isActive())
                em.getTransaction().rollback();
            if (infoLabel != null)
                infoLabel.setText("Error creating model: " + e.getMessage());
            e.printStackTrace();
        } finally {
            em.close();
        }
    }


    @FXML
    private void onNavOverview(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/home.fxml", "Main Mennu");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @FXML
    private void onNavStock(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/stock.fxml", "Stock");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

	@FXML
    private void onNavMaintentance(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/maintenance.fxml", "Maintenance");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

	@FXML
	private void onNavUsers(ActionEvent event) {
	    LoggedInUser u = AppSession.getCurrentUser();
	    if (u == null || u.getRole() == null || !u.getRole().equalsIgnoreCase("ADMIN")) {
	        Alert a = new Alert(Alert.AlertType.WARNING);
	        a.setTitle("Access denied");
	        a.setHeaderText(null);
	        a.setContentText("Only ADMIN users can manage users.");
	        a.showAndWait();
	        return;
	    }
	
	    try {
	        ViewUtil.switchScene(event, "/ui/users.fxml", "Users");
	    } catch (Exception e) {
	        e.printStackTrace();
	    }
	}


	
	@FXML
    private void onLogout(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/login.fxml", "Login");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}package com.example.ui;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Optional;

import javax.persistence.EntityManager;
import javax.persistence.TypedQuery;

import com.example.app.JPA;
import com.example.app.ViewUtil;
import com.example.domain.Branch;
import com.example.domain.Consumable;
import com.example.domain.Stock;
import com.example.session.AppSession;
import com.example.session.LoggedInUser;

import javafx.beans.property.SimpleIntegerProperty;
import javafx.beans.property.SimpleStringProperty;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.collections.transformation.FilteredList;
import javafx.collections.transformation.SortedList;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.geometry.Insets;
import javafx.scene.Node;
import javafx.scene.control.Alert;
import javafx.scene.control.ButtonBar;
import javafx.scene.control.ButtonType;
import javafx.scene.control.ComboBox;
import javafx.scene.control.DatePicker;
import javafx.scene.control.Dialog;
import javafx.scene.control.Label;
import javafx.scene.control.ListCell;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.scene.control.TextField;
import javafx.scene.layout.GridPane;
import javafx.stage.Modality;
import javafx.stage.Window;

public class StockController {

    @FXML private Label userLabel;

    @FXML private TableView<Stock>          stockTable;
    @FXML private TableColumn<Stock,String> consColumn;
    @FXML private TableColumn<Stock,String> measureColumn;
    @FXML private TableColumn<Stock,String> branchColumn;
    @FXML private TableColumn<Stock,Number> availColumn;
    @FXML private TableColumn<Stock,Number> resColumn;
    @FXML private TableColumn<Stock,String> lastCountCol;

    @FXML private TextField   searchField;
    @FXML private ComboBox<String> sortByCombo;
    @FXML private Label       infoLabel;

    private final DateTimeFormatter dateFmt =
            DateTimeFormatter.ofPattern("yyyy-MM-dd");

    private final ObservableList<Stock> masterData =
            FXCollections.observableArrayList();
    private FilteredList<Stock> filteredData;
    private SortedList<Stock>   sortedData;

    @FXML
    public void initialize() {
        // Show logged in user
        LoggedInUser u = AppSession.getCurrentUser();
        if (u != null && userLabel != null) {
            StringBuilder sb = new StringBuilder();

            if (u.getDisplayName() != null && !u.getDisplayName().isBlank()) {
                sb.append(u.getDisplayName());
            } else if (u.getUsername() != null) {
                sb.append(u.getUsername());
            }

            if (u.getRole() != null && !u.getRole().isBlank()) {
                sb.append(" (").append(u.getRole()).append(")");
            }

            if (u.getBranchName() != null && !u.getBranchName().isBlank()) {
                sb.append(" · ").append(u.getBranchName());
            }

            if (u.getEmail() != null && !u.getEmail().isBlank()) {
                sb.append(" · ").append(u.getEmail());
            }

            userLabel.setText(sb.toString());
        }

        // Table columns
        consColumn.setCellValueFactory(cd ->
                new SimpleStringProperty(
                        cd.getValue().getConsumable() != null &&
                        cd.getValue().getConsumable().getItemName() != null
                                ? cd.getValue().getConsumable().getItemName()
                                : ""
                ));

        measureColumn.setCellValueFactory(cd ->
                new SimpleStringProperty(
                        cd.getValue().getConsumable() != null &&
                        cd.getValue().getConsumable().getMeasure() != null
                                ? cd.getValue().getConsumable().getMeasure()
                                : ""
                ));

        branchColumn.setCellValueFactory(cd ->
                new SimpleStringProperty(
                        cd.getValue().getBranch() != null &&
                        cd.getValue().getBranch().getName() != null
                                ? cd.getValue().getBranch().getName()
                                : ""
                ));

        availColumn.setCellValueFactory(cd ->
                new SimpleIntegerProperty(
                        cd.getValue().getAvailableQuantity() != null
                                ? cd.getValue().getAvailableQuantity()
                                : 0
                ));

        resColumn.setCellValueFactory(cd ->
                new SimpleIntegerProperty(
                        cd.getValue().getReservedQuantity() != null
                                ? cd.getValue().getReservedQuantity()
                                : 0
                ));

        lastCountCol.setCellValueFactory(cd ->
                new SimpleStringProperty(
                        cd.getValue().getLastCountDate() != null
                                ? cd.getValue().getLastCountDate().format(dateFmt)
                                : ""
                ));

        // Wrappers
        filteredData = new FilteredList<>(masterData, s -> true);
        sortedData   = new SortedList<>(filteredData);
        sortedData.comparatorProperty().bind(stockTable.comparatorProperty());
        stockTable.setItems(sortedData);

        setupSearch();
        setupSortCombo();
        loadStock();
    }

    private void loadStock() {
        LoggedInUser u = AppSession.getCurrentUser();

        EntityManager em = JPA.em();
        try {
            boolean filterByBranch = (u != null &&
                    u.getBranchName() != null &&
                    !u.getBranchName().isBlank() &&
                    (u.getRole() == null ||
                     !u.getRole().equalsIgnoreCase("ADMIN")));

            String jpql =
                    "SELECT s FROM Stock s " +
                    "JOIN FETCH s.consumable c " +
                    "JOIN FETCH s.branch b";
            if (filterByBranch) {
                jpql += " WHERE b.name = :branchName";
            }
            jpql += " ORDER BY c.itemName, b.name";

            TypedQuery<Stock> q = em.createQuery(jpql, Stock.class);
            if (filterByBranch) {
                q.setParameter("branchName", u.getBranchName());
            }

            List<Stock> list = q.getResultList();
            masterData.setAll(list);

            if (infoLabel != null) {
                infoLabel.setText(list.isEmpty()
                        ? "No stock rows found."
                        : "");
            }
        } catch (Exception e) {
            if (infoLabel != null) {
                infoLabel.setText("Error loading stock: " + e.getMessage());
            }
            e.printStackTrace();
        } finally {
            em.close();
        }
    }

    private void setupSearch() {
        if (searchField == null) return;

        searchField.textProperty().addListener((obs, old, value) -> {
            String needle = (value == null) ? "" : value.trim().toLowerCase();

            filteredData.setPredicate(st -> {
                if (needle.isEmpty()) return true;

                if (st.getConsumable() != null &&
                        st.getConsumable().getItemName() != null &&
                        st.getConsumable().getItemName().toLowerCase().contains(needle))
                    return true;

                if (st.getConsumable() != null &&
                        st.getConsumable().getMeasure() != null &&
                        st.getConsumable().getMeasure().toLowerCase().contains(needle))
                    return true;

                if (st.getBranch() != null &&
                        st.getBranch().getName() != null &&
                        st.getBranch().getName().toLowerCase().contains(needle))
                    return true;

                if (st.getAvailableQuantity() != null &&
                        st.getAvailableQuantity().toString().contains(needle))
                    return true;

                if (st.getReservedQuantity() != null &&
                        st.getReservedQuantity().toString().contains(needle))
                    return true;

                if (st.getLastCountDate() != null &&
                        st.getLastCountDate().format(dateFmt).toLowerCase().contains(needle))
                    return true;

                return false;
            });
        });
    }

    private void setupSortCombo() {
        if (sortByCombo == null) return;

        sortByCombo.setItems(FXCollections.observableArrayList(
                "Consumable", "Branch", "Available", "Reserved", "Last count"
        ));
        sortByCombo.getSelectionModel().select("Consumable");

        sortByCombo.getSelectionModel().selectedItemProperty().addListener((obs, old, sel) -> {
            if (sel == null) return;

            stockTable.getSortOrder().clear();
            TableColumn<Stock, ?> col = null;

            switch (sel) {
                case "Consumable": col = consColumn;   break;
                case "Branch":     col = branchColumn; break;
                case "Available":  col = availColumn;  break;
                case "Reserved":   col = resColumn;    break;
                case "Last count": col = lastCountCol; break;
            }

            if (col != null) {
                col.setSortType(TableColumn.SortType.ASCENDING);
                stockTable.getSortOrder().add(col);
                stockTable.sort();
            }
        });
    }

    @FXML
    private void onTopUpStock() {
        Stock selected = stockTable.getSelectionModel().getSelectedItem();
        if (selected == null) {
            if (infoLabel != null)
                infoLabel.setText("Select a stock row first.");
            return;
        }

        Dialog<TopUpData> dialog = new Dialog<>();

        Window owner = stockTable.getScene() != null
                ? stockTable.getScene().getWindow()
                : null;
        if (owner != null) {
            dialog.initOwner(owner);
        }
        dialog.initModality(Modality.WINDOW_MODAL);

        dialog.setTitle("Top up stock");
        dialog.setHeaderText("Top up available quantity for: " +
                (selected.getConsumable() != null ? selected.getConsumable().getItemName() : "???") +
                " @ " +
                (selected.getBranch() != null ? selected.getBranch().getName() : "???"));

        ButtonType saveButtonType =
                new ButtonType("Apply", ButtonBar.ButtonData.OK_DONE);
        dialog.getDialogPane().getButtonTypes().addAll(saveButtonType, ButtonType.CANCEL);

        TextField amountField = new TextField();
        amountField.setPromptText("Amount to add (integer > 0)");

        DatePicker countDatePicker = new DatePicker(LocalDate.now());
        countDatePicker.setPromptText("New last count date (optional)");

        GridPane grid = new GridPane();
        grid.setHgap(10);
        grid.setVgap(8);
        grid.setPadding(new Insets(10, 10, 10, 10));

        int row = 0;
        grid.add(new Label("Top-up amount:"), 0, row);
        grid.add(amountField,               1, row++);

        grid.add(new Label("Last count date:"), 0, row);
        grid.add(countDatePicker,              1, row++);

        dialog.getDialogPane().setContent(grid);

        Node saveButton = dialog.getDialogPane().lookupButton(saveButtonType);
        saveButton.setDisable(true);

        Runnable validate = () -> {
            String text = amountField.getText() == null ? "" : amountField.getText().trim();
            boolean ok = false;
            if (!text.isEmpty()) {
                try {
                    int val = Integer.parseInt(text);
                    ok = val > 0;
                } catch (NumberFormatException ignored) {}
            }
            saveButton.setDisable(!ok);
        };

        amountField.textProperty().addListener((obs, ov, nv) -> validate.run());

        dialog.setResultConverter(btn -> {
            if (btn == saveButtonType) {
                int amount = Integer.parseInt(amountField.getText().trim());
                LocalDate date = countDatePicker.getValue();  // can be null
                return new TopUpData(amount, date);
            }
            return null;
        });

        Optional<TopUpData> result = dialog.showAndWait();
        if (result.isEmpty()) {
            return; // cancelled
        }

        TopUpData data   = result.get();
        int       toAdd  = data.topUpAmount();
        LocalDate newDate = data.lastCountDate();

        EntityManager em = JPA.em();
        try {
            em.getTransaction().begin();

            Stock managed = em.merge(selected);

            int currentAvail = managed.getAvailableQuantity() != null
                    ? managed.getAvailableQuantity()
                    : 0;
            managed.setAvailableQuantity(currentAvail + toAdd);

            if (newDate != null) {
                managed.setLastCountDate(newDate);
            }

            em.getTransaction().commit();

            // update UI copy
            selected.setAvailableQuantity(currentAvail + toAdd);
            if (newDate != null) {
                selected.setLastCountDate(newDate);
            }
            stockTable.refresh();

            if (infoLabel != null) {
                infoLabel.setText("Stock topped up by " + toAdd + " units.");
            }

        } catch (Exception e) {
            if (em.getTransaction().isActive())
                em.getTransaction().rollback();
            if (infoLabel != null)
                infoLabel.setText("Error topping up stock: " + e.getMessage());
            e.printStackTrace();
        } finally {
            em.close();
        }
    }

	@FXML
	private void onTopUpReserved() {
	    Stock selected = stockTable.getSelectionModel().getSelectedItem();
	    if (selected == null) {
	        if (infoLabel != null)
	            infoLabel.setText("Select a stock row first.");
	        return;
	    }

	    Dialog<TopUpData> dialog = new Dialog<>();

	    Window owner = stockTable.getScene() != null
	            ? stockTable.getScene().getWindow()
	            : null;
	    if (owner != null) {
	        dialog.initOwner(owner);
	    }
	    dialog.initModality(Modality.WINDOW_MODAL);

	    dialog.setTitle("Top up reserved");
	    dialog.setHeaderText("Top up RESERVED quantity for: " +
	            (selected.getConsumable() != null ? selected.getConsumable().getItemName() : "???") +
	            " @ " +
	            (selected.getBranch() != null ? selected.getBranch().getName() : "???"));

	    ButtonType saveButtonType =
	            new ButtonType("Apply", ButtonBar.ButtonData.OK_DONE);
	    dialog.getDialogPane().getButtonTypes().addAll(saveButtonType, ButtonType.CANCEL);

	    TextField amountField = new TextField();
	    amountField.setPromptText("Amount to add (integer > 0)");

	    DatePicker countDatePicker = new DatePicker(LocalDate.now());
	    countDatePicker.setPromptText("New last count date (optional)");

	    GridPane grid = new GridPane();
	    grid.setHgap(10);
	    grid.setVgap(8);
	    grid.setPadding(new Insets(10, 10, 10, 10));

	    int row = 0;
	    grid.add(new Label("Top-up amount:"), 0, row);
	    grid.add(amountField,               1, row++);

	    grid.add(new Label("Last count date:"), 0, row);
	    grid.add(countDatePicker,              1, row++);

	    dialog.getDialogPane().setContent(grid);

	    Node saveButton = dialog.getDialogPane().lookupButton(saveButtonType);
	    saveButton.setDisable(true);

	    Runnable validate = () -> {
	        String text = amountField.getText() == null ? "" : amountField.getText().trim();
	        boolean ok = false;
	        if (!text.isEmpty()) {
	            try {
	                int val = Integer.parseInt(text);
	                ok = val > 0;
	            } catch (NumberFormatException ignored) {}
	        }
	        saveButton.setDisable(!ok);
	    };

	    amountField.textProperty().addListener((obs, ov, nv) -> validate.run());

	    dialog.setResultConverter(btn -> {
	        if (btn == saveButtonType) {
	            int amount = Integer.parseInt(amountField.getText().trim());
	            LocalDate date = countDatePicker.getValue();  // can be null
	            return new TopUpData(amount, date);
	        }
	        return null;
	    });

	    Optional<TopUpData> result = dialog.showAndWait();
	    if (result.isEmpty()) {
	        return; // cancelled
	    }

	    TopUpData data   = result.get();
	    int       toAdd  = data.topUpAmount();
	    LocalDate newDate = data.lastCountDate();

	    EntityManager em = JPA.em();
	    try {
	        em.getTransaction().begin();

	        // Reattach with merge
	        Stock managed = em.merge(selected);

	        int currentReserved = managed.getReservedQuantity() != null
	                ? managed.getReservedQuantity()
	                : 0;
	        managed.setReservedQuantity(currentReserved + toAdd);

	        if (newDate != null) {
	            managed.setLastCountDate(newDate);
	        }

	        em.getTransaction().commit();

	        // update UI copy
	        selected.setReservedQuantity(currentReserved + toAdd);
	        if (newDate != null) {
	            selected.setLastCountDate(newDate);
	        }
	        stockTable.refresh();

	        if (infoLabel != null) {
	            infoLabel.setText("Reserved quantity topped up by " + toAdd + " units.");
	        }

	    } catch (Exception e) {
	        if (em.getTransaction().isActive())
	            em.getTransaction().rollback();
	        if (infoLabel != null)
	            infoLabel.setText("Error topping up reserved: " + e.getMessage());
	        e.printStackTrace();
	    } finally {
	        em.close();
	    }
	}

	@FXML
	private void onTopUpFromReserved() {
	    Stock selected = stockTable.getSelectionModel().getSelectedItem();
	    if (selected == null) {
	        if (infoLabel != null)
	            infoLabel.setText("Select a stock row first.");
	        return;
	    }

	    Dialog<TopUpData> dialog = new Dialog<>();

	    Window owner = stockTable.getScene() != null
	            ? stockTable.getScene().getWindow()
	            : null;
	    if (owner != null) {
	        dialog.initOwner(owner);
	    }
	    dialog.initModality(Modality.WINDOW_MODAL);

	    dialog.setTitle("Top up from reserved");
	    dialog.setHeaderText("Move quantity FROM RESERVED to AVAILABLE for: " +
	            (selected.getConsumable() != null ? selected.getConsumable().getItemName() : "???") +
	            " @ " +
	            (selected.getBranch() != null ? selected.getBranch().getName() : "???"));

	    ButtonType saveButtonType =
	            new ButtonType("Apply", ButtonBar.ButtonData.OK_DONE);
	    dialog.getDialogPane().getButtonTypes().addAll(saveButtonType, ButtonType.CANCEL);

	    TextField amountField = new TextField();
	    amountField.setPromptText("Amount to move (integer > 0)");

	    DatePicker countDatePicker = new DatePicker(LocalDate.now());
	    countDatePicker.setPromptText("New last count date (optional)");

	    GridPane grid = new GridPane();
	    grid.setHgap(10);
	    grid.setVgap(8);
	    grid.setPadding(new Insets(10, 10, 10, 10));

	    int row = 0;
	    grid.add(new Label("Amount to move:"), 0, row);
	    grid.add(amountField,                 1, row++);

	    grid.add(new Label("Last count date:"), 0, row);
	    grid.add(countDatePicker,              1, row++);

	    dialog.getDialogPane().setContent(grid);

	    Node saveButton = dialog.getDialogPane().lookupButton(saveButtonType);
	    saveButton.setDisable(true);

	    Runnable validate = () -> {
	        String text = amountField.getText() == null ? "" : amountField.getText().trim();
	        boolean ok = false;
	        if (!text.isEmpty()) {
	            try {
	                int val = Integer.parseInt(text);
	                ok = val > 0;
	            } catch (NumberFormatException ignored) {}
	        }
	        saveButton.setDisable(!ok);
	    };

	    amountField.textProperty().addListener((obs, ov, nv) -> validate.run());

	    dialog.setResultConverter(btn -> {
	        if (btn == saveButtonType) {
	            int amount = Integer.parseInt(amountField.getText().trim());
	            LocalDate date = countDatePicker.getValue();  // can be null
	            return new TopUpData(amount, date);
	        }
	        return null;
	    });

	    Optional<TopUpData> result = dialog.showAndWait();
	    if (result.isEmpty()) {
	        return; // cancelled
	    }

	    TopUpData data   = result.get();
	    int       toMove = data.topUpAmount();
	    LocalDate newDate = data.lastCountDate();

	    EntityManager em = JPA.em();
	    try {
	        em.getTransaction().begin();

	        // Reattach with merge
	        Stock managed = em.merge(selected);

	        int currentReserved = managed.getReservedQuantity() != null
	                ? managed.getReservedQuantity()
	                : 0;
	        int currentAvail = managed.getAvailableQuantity() != null
	                ? managed.getAvailableQuantity()
	                : 0;

	        if (toMove > currentReserved) {
	            throw new IllegalArgumentException(
	                    "Cannot move " + toMove + " from reserved; only " + currentReserved + " reserved.");
	        }

	        managed.setReservedQuantity(currentReserved - toMove);
	        managed.setAvailableQuantity(currentAvail + toMove);

	        if (newDate != null) {
	            managed.setLastCountDate(newDate);
	        }

	        em.getTransaction().commit();

	        // update UI copy
	        selected.setReservedQuantity(currentReserved - toMove);
	        selected.setAvailableQuantity(currentAvail + toMove);
	        if (newDate != null) {
	            selected.setLastCountDate(newDate);
	        }
	        stockTable.refresh();

	        if (infoLabel != null) {
	            infoLabel.setText("Moved " + toMove + " units from reserved to available.");
	        }

	    } catch (Exception e) {
	        if (em.getTransaction().isActive())
	            em.getTransaction().rollback();
	        if (infoLabel != null)
	            infoLabel.setText("Error moving from reserved: " + e.getMessage());
	        e.printStackTrace();
	    } finally {
	        em.close();
	    }
	}

    private record TopUpData(int topUpAmount, LocalDate lastCountDate) {}

    @FXML
    private void onAddConsumable() {
        Dialog<Consumable> dialog = new Dialog<>();

        Window owner = stockTable.getScene() != null
                ? stockTable.getScene().getWindow()
                : null;
        if (owner != null) {
            dialog.initOwner(owner);
        }
        dialog.initModality(Modality.WINDOW_MODAL);

        dialog.setTitle("New consumable");
        dialog.setHeaderText("Create a new consumable item");

        ButtonType saveButtonType =
                new ButtonType("Save", ButtonBar.ButtonData.OK_DONE);
        dialog.getDialogPane().getButtonTypes().addAll(saveButtonType, ButtonType.CANCEL);

        TextField nameField = new TextField();
        nameField.setPromptText("Item name (required)");

        TextField measureField = new TextField();
        measureField.setPromptText("Measure (EA, BOX, etc.) (required)");

        GridPane grid = new GridPane();
        grid.setHgap(10);
        grid.setVgap(8);
        grid.setPadding(new Insets(10, 10, 10, 10));

        int row = 0;
        grid.add(new Label("Item name:"), 0, row);
        grid.add(nameField,              1, row++);
        grid.add(new Label("Measure:"),  0, row);
        grid.add(measureField,           1, row++);

        dialog.getDialogPane().setContent(grid);

        Node saveButton = dialog.getDialogPane().lookupButton(saveButtonType);
        saveButton.setDisable(true);

        Runnable validate = () -> {
            String n = nameField.getText() == null ? "" : nameField.getText().trim();
            String m = measureField.getText() == null ? "" : measureField.getText().trim();
            saveButton.setDisable(n.isEmpty() || m.isEmpty());
        };

        nameField.textProperty().addListener((o, ov, nv) -> validate.run());
        measureField.textProperty().addListener((o, ov, nv) -> validate.run());

        dialog.setResultConverter(btn -> {
            if (btn == saveButtonType) {
                Consumable c = new Consumable();
                c.setItemName(nameField.getText().trim());
                c.setMeasure(measureField.getText().trim());
                return c;
            }
            return null;
        });

        Optional<Consumable> result = dialog.showAndWait();
        if (result.isEmpty()) return;

        Consumable form = result.get();

        EntityManager em = JPA.em();
        try {
            em.getTransaction().begin();
            Consumable c = new Consumable();
            c.setItemName(form.getItemName());
            c.setMeasure(form.getMeasure());
            em.persist(c);
            em.getTransaction().commit();

            if (infoLabel != null)
                infoLabel.setText("Consumable created: " + c.getItemName());
            // no need to reload stock; we haven’t created a stock row yet
        } catch (Exception e) {
            if (em.getTransaction().isActive())
                em.getTransaction().rollback();
            if (infoLabel != null)
                infoLabel.setText("Error creating consumable: " + e.getMessage());
            e.printStackTrace();
        } finally {
            em.close();
        }
    }

    @FXML
    private void onAddStock() {
        LoggedInUser u = AppSession.getCurrentUser();
        if (u == null || u.getBranchName() == null || u.getBranchName().isBlank()) {
            if (infoLabel != null)
                infoLabel.setText("Cannot determine your branch for new stock row.");
            return;
        }

        EntityManager em = JPA.em();
        try {
            // Load consumables
            List<Consumable> consumables = em.createQuery(
                    "SELECT c FROM Consumable c ORDER BY c.itemName",
                    Consumable.class
            ).getResultList();

            if (consumables.isEmpty()) {
                if (infoLabel != null)
                    infoLabel.setText("No consumables found. Create a consumable first.");
                return;
            }

            // Load branch for current user
            Branch branch = em.createQuery(
                    "SELECT b FROM Branch b WHERE b.name = :name",
                    Branch.class
            ).setParameter("name", u.getBranchName())
             .getSingleResult();

            // Dialog UI
            Dialog<NewStockData> dialog = new Dialog<>();

            Window owner = stockTable.getScene() != null
                    ? stockTable.getScene().getWindow()
                    : null;
            if (owner != null) dialog.initOwner(owner);
            dialog.initModality(Modality.WINDOW_MODAL);

            dialog.setTitle("New stock row");
            dialog.setHeaderText("Create stock for branch: " + branch.getName());

            ButtonType saveButtonType =
                    new ButtonType("Save", ButtonBar.ButtonData.OK_DONE);
            dialog.getDialogPane().getButtonTypes().addAll(saveButtonType, ButtonType.CANCEL);

            ComboBox<Consumable> consBox = new ComboBox<>();
            consBox.getItems().addAll(consumables);
            consBox.getSelectionModel().selectFirst();
            consBox.setPrefWidth(260);

            // Friendly display in LOV
            consBox.setCellFactory(cb -> new ListCell<>() {
                @Override
                protected void updateItem(Consumable item, boolean empty) {
                    super.updateItem(item, empty);
                    if (empty || item == null) {
                        setText(null);
                    } else {
                        String name = item.getItemName() != null
                                ? item.getItemName()
                                : "Consumable #" + item.getId();
                        String m = item.getMeasure() != null ? item.getMeasure() : "";
                        setText(m.isEmpty() ? name : name + " (" + m + ")");
                    }
                }
            });
            consBox.setButtonCell(new ListCell<>() {
                @Override
                protected void updateItem(Consumable item, boolean empty) {
                    super.updateItem(item, empty);
                    if (empty || item == null) {
                        setText(null);
                    } else {
                        String name = item.getItemName() != null
                                ? item.getItemName()
                                : "Consumable #" + item.getId();
                        String m = item.getMeasure() != null ? item.getMeasure() : "";
                        setText(m.isEmpty() ? name : name + " (" + m + ")");
                    }
                }
            });

            TextField availField = new TextField();
            availField.setPromptText("Available quantity (>= 0)");

            TextField resField = new TextField();
            resField.setPromptText("Reserved quantity (>= 0, optional)");

            DatePicker datePicker = new DatePicker(LocalDate.now());
            datePicker.setPromptText("Last count date");

            GridPane grid = new GridPane();
            grid.setHgap(10);
            grid.setVgap(8);
            grid.setPadding(new Insets(10, 10, 10, 10));

            int row = 0;
            grid.add(new Label("Consumable:"), 0, row);
            grid.add(consBox,                1, row++);
            grid.add(new Label("Available:"), 0, row);
            grid.add(availField,             1, row++);
            grid.add(new Label("Reserved:"), 0, row);
            grid.add(resField,               1, row++);
            grid.add(new Label("Last count:"), 0, row);
            grid.add(datePicker,             1, row++);

            dialog.getDialogPane().setContent(grid);

            Node saveButton = dialog.getDialogPane().lookupButton(saveButtonType);
            saveButton.setDisable(true);

            Runnable validate = () -> {
                boolean ok = consBox.getValue() != null;
                String a = availField.getText() == null ? "" : availField.getText().trim();
                if (a.isEmpty()) {
                    ok = false;
                } else {
                    try {
                        int v = Integer.parseInt(a);
                        if (v < 0) ok = false;
                    } catch (NumberFormatException ex) {
                        ok = false;
                    }
                }
                String r = resField.getText() == null ? "" : resField.getText().trim();
                if (!r.isEmpty()) {
                    try {
                        int v = Integer.parseInt(r);
                        if (v < 0) ok = false;
                    } catch (NumberFormatException ex) {
                        ok = false;
                    }
                }
                saveButton.setDisable(!ok);
            };

            consBox.valueProperty().addListener((o, ov, nv) -> validate.run());
            availField.textProperty().addListener((o, ov, nv) -> validate.run());
            resField.textProperty().addListener((o, ov, nv) -> validate.run());

            dialog.setResultConverter(btn -> {
                if (btn == saveButtonType) {
                    Consumable c = consBox.getValue();
                    int avail = Integer.parseInt(availField.getText().trim());
                    String resText = resField.getText() == null ? "" : resField.getText().trim();
                    Integer reserved = resText.isEmpty()
                            ? 0
                            : Integer.parseInt(resText);
                    LocalDate d = datePicker.getValue();
                    return new NewStockData(c, avail, reserved, d);
                }
                return null;
            });

            Optional<NewStockData> result = dialog.showAndWait();
            if (result.isEmpty()) {
                return; // cancelled
            }

            NewStockData data = result.get();

            // Persist new Stock
            em.getTransaction().begin();

            Stock s = new Stock();
            s.setBranch(branch);
            s.setConsumable(em.getReference(Consumable.class, data.consumable().getId()));
            s.setAvailableQuantity(data.available());
            s.setReservedQuantity(data.reserved());
            s.setLastCountDate(data.lastCountDate());

            em.persist(s);
            em.getTransaction().commit();

            // update UI
            masterData.add(s);
            stockTable.refresh();

            if (infoLabel != null)
                infoLabel.setText("Stock row created for " +
                        data.consumable().getItemName() +
                        " @ " + branch.getName());

        } catch (Exception e) {
            if (em.getTransaction().isActive())
                em.getTransaction().rollback();
            if (infoLabel != null)
                infoLabel.setText("Error creating stock row: " + e.getMessage());
            e.printStackTrace();
        } finally {
            em.close();
        }
    }

    private record NewStockData(Consumable consumable,
                                int available,
                                int reserved,
                                LocalDate lastCountDate) {}

    @FXML
    private void onNavOverview(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/home.fxml", "Main Menu");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @FXML
    private void onNavSimulators(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/simulators.fxml", "Simulators");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

	@FXML
    private void onNavMaintentance(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/maintenance.fxml", "Maintenance");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

	@FXML
	private void onNavUsers(ActionEvent event) {
	    LoggedInUser u = AppSession.getCurrentUser();
	    if (u == null || u.getRole() == null || !u.getRole().equalsIgnoreCase("ADMIN")) {
	        Alert a = new Alert(Alert.AlertType.WARNING);
	        a.setTitle("Access denied");
	        a.setHeaderText(null);
	        a.setContentText("Only ADMIN users can manage users.");
	        a.showAndWait();
	        return;
	    }
	
	    try {
	        ViewUtil.switchScene(event, "/ui/users.fxml", "Users");
	    } catch (Exception e) {
	        e.printStackTrace();
	    }
	}
		



    @FXML
    private void onLogout(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/login.fxml", "Login");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
package com.example.ui;

import javax.persistence.EntityManager;
import javax.persistence.NoResultException;
import javax.persistence.TypedQuery;

import com.example.domain.User;

public class UserRepository {
    public User findByUsername(EntityManager em, String username) {
        try {
            TypedQuery<User> q = em.createQuery("SELECT u FROM User u WHERE u.username = :u", User.class);
            q.setParameter("u", username);
            return q.getSingleResult();
        } catch (NoResultException nre) {
            return null;
        }
    }

    public void save(EntityManager em, User u) {
        if (em.contains(u) || u.getId() != null && em.find(User.class, u.getId()) != null) {
            em.merge(u);
        } else {
            em.persist(u);
        }
    }
}
package com.example.ui;

import java.util.List;
import java.util.Optional;

import javax.persistence.EntityManager;
import javax.persistence.TypedQuery;

import com.example.app.JPA;
import com.example.app.ViewUtil;
import com.example.domain.Branch;
import com.example.domain.User;
import com.example.session.AppSession;
import com.example.session.LoggedInUser;

import javafx.beans.property.SimpleStringProperty;
import javafx.collections.FXCollections;
import javafx.collections.ObservableList;
import javafx.collections.transformation.FilteredList;
import javafx.collections.transformation.SortedList;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.geometry.Insets;
import javafx.scene.Node;
import javafx.scene.control.Alert;
import javafx.scene.control.ButtonBar;
import javafx.scene.control.ButtonType;
import javafx.scene.control.ComboBox;
import javafx.scene.control.Dialog;
import javafx.scene.control.Label;
import javafx.scene.control.ListCell;
import javafx.scene.control.TableColumn;
import javafx.scene.control.TableView;
import javafx.scene.control.TextField;
import javafx.scene.layout.GridPane;
import javafx.stage.Modality;
import javafx.stage.Window;

public class UsersController {

    @FXML private Label userLabel;

    @FXML private TableView<User> userTable;
    @FXML private TableColumn<User, String> usernameColumn;
    @FXML private TableColumn<User, String> displayNameColumn;
    @FXML private TableColumn<User, String> roleColumn;
    @FXML private TableColumn<User, String> emailColumn;
    @FXML private TableColumn<User, String> branchColumn;
    @FXML private TableColumn<User, String> activeColumn;
    @FXML private TableColumn<User, String> resetColumn;

    @FXML private TextField        searchField;
    @FXML private ComboBox<String> sortByCombo;
    @FXML private Label            infoLabel;

    private final ObservableList<User> masterData =
            FXCollections.observableArrayList();
    private FilteredList<User> filteredData;
    private SortedList<User>   sortedData;

    @FXML
    public void initialize() {
        LoggedInUser loggedIn = AppSession.getCurrentUser();
        if (loggedIn != null && userLabel != null) {
            StringBuilder sb = new StringBuilder();
            if (loggedIn.getDisplayName() != null && !loggedIn.getDisplayName().isBlank())
                sb.append(loggedIn.getDisplayName());
            else if (loggedIn.getUsername() != null)
                sb.append(loggedIn.getUsername());

            if (loggedIn.getRole() != null && !loggedIn.getRole().isBlank())
                sb.append(" (").append(loggedIn.getRole()).append(")");

            if (loggedIn.getBranchName() != null && !loggedIn.getBranchName().isBlank())
                sb.append(" · ").append(loggedIn.getBranchName());

            if (loggedIn.getEmail() != null && !loggedIn.getEmail().isBlank())
                sb.append(" · ").append(loggedIn.getEmail());

            userLabel.setText(sb.toString());
        }

        // Access control: only ADMIN
        if (loggedIn == null || loggedIn.getRole() == null ||
            !loggedIn.getRole().equalsIgnoreCase("ADMIN")) {

            if (infoLabel != null) {
                infoLabel.setText("Access denied: only ADMIN can manage users.");
            }
            if (userTable != null) userTable.setDisable(true);
        }

        // Table columns
        usernameColumn.setCellValueFactory(
                cd -> new SimpleStringProperty(
                        cd.getValue().getUsername() != null ? cd.getValue().getUsername() : ""));

        displayNameColumn.setCellValueFactory(
                cd -> new SimpleStringProperty(
                        cd.getValue().getDisplayName() != null ? cd.getValue().getDisplayName() : ""));

        roleColumn.setCellValueFactory(
                cd -> new SimpleStringProperty(
                        cd.getValue().getRole() != null ? cd.getValue().getRole() : ""));

        emailColumn.setCellValueFactory(
                cd -> new SimpleStringProperty(
                        cd.getValue().getEmail() != null ? cd.getValue().getEmail() : ""));

        branchColumn.setCellValueFactory(
                cd -> new SimpleStringProperty(
                        cd.getValue().getBranch() != null
                                && cd.getValue().getBranch().getName() != null
                                ? cd.getValue().getBranch().getName()
                                : ""));

        activeColumn.setCellValueFactory(
                cd -> new SimpleStringProperty(
                        Boolean.TRUE.equals(cd.getValue().getIsActive()) ? "Yes" : "No"));

        resetColumn.setCellValueFactory(
                cd -> new SimpleStringProperty(
                        Boolean.TRUE.equals(cd.getValue().getReset()) ? "Yes" : "No"));

        filteredData = new FilteredList<>(masterData, u -> true);
        sortedData   = new SortedList<>(filteredData);
        sortedData.comparatorProperty().bind(userTable.comparatorProperty());
        userTable.setItems(sortedData);

        setupSearch();
        setupSortCombo();
        loadUsers();
    }

    private boolean isAdmin() {
        LoggedInUser u = AppSession.getCurrentUser();
        return u != null &&
               u.getRole() != null &&
               u.getRole().equalsIgnoreCase("ADMIN");
    }

    private void loadUsers() {
        if (!isAdmin()) return;

        EntityManager em = JPA.em();
        try {
            // fetch branch to avoid N+1
            TypedQuery<User> q = em.createQuery(
                    "SELECT u FROM User u LEFT JOIN FETCH u.branch ORDER BY u.username",
                    User.class
            );
            List<User> list = q.getResultList();
            masterData.setAll(list);

            if (infoLabel != null) {
                infoLabel.setText(list.isEmpty()
                        ? "No users found."
                        : "");
            }
        } catch (Exception e) {
            if (infoLabel != null) {
                infoLabel.setText("Error loading users: " + e.getMessage());
            }
            e.printStackTrace();
        } finally {
            em.close();
        }
    }

    private void setupSearch() {
        if (searchField == null) return;

        searchField.textProperty().addListener((obs, oldVal, newVal) -> {
            String needle = (newVal == null) ? "" : newVal.trim().toLowerCase();

            filteredData.setPredicate(u -> {
                if (needle.isEmpty()) return true;

                if (u.getUsername() != null &&
                    u.getUsername().toLowerCase().contains(needle)) return true;

                if (u.getDisplayName() != null &&
                    u.getDisplayName().toLowerCase().contains(needle)) return true;

                if (u.getRole() != null &&
                    u.getRole().toLowerCase().contains(needle)) return true;

                if (u.getEmail() != null &&
                    u.getEmail().toLowerCase().contains(needle)) return true;

                if (u.getBranch() != null &&
                    u.getBranch().getName() != null &&
                    u.getBranch().getName().toLowerCase().contains(needle)) return true;

                return false;
            });
        });
    }

    private void setupSortCombo() {
        if (sortByCombo == null) return;

        sortByCombo.setItems(FXCollections.observableArrayList(
                "Username", "Role", "Branch", "Active"
        ));
        sortByCombo.getSelectionModel().select("Username");

        sortByCombo.getSelectionModel().selectedItemProperty().addListener((obs, old, sel) -> {
            if (sel == null) return;

            userTable.getSortOrder().clear();
            TableColumn<User, ?> col = null;

            switch (sel) {
                case "Username": col = usernameColumn; break;
                case "Role":     col = roleColumn;     break;
                case "Branch":   col = branchColumn;   break;
                case "Active":   col = activeColumn;   break;
            }

            if (col != null) {
                col.setSortType(TableColumn.SortType.ASCENDING);
                userTable.getSortOrder().add(col);
                userTable.sort();
            }
        });
    }

    // =====================================================
    // Actions
    // =====================================================

    @FXML
    private void onAddUser() {
        if (!isAdmin()) {
            if (infoLabel != null)
                infoLabel.setText("Only ADMIN can create users.");
            return;
        }

        EntityManager em = JPA.em();
        try {
            List<Branch> branches = em.createQuery(
                    "SELECT b FROM Branch b ORDER BY b.name",
                    Branch.class
            ).getResultList();

            Dialog<NewUserData> dialog = new Dialog<>();
            Window owner = userTable.getScene() != null
                    ? userTable.getScene().getWindow()
                    : null;
            if (owner != null) dialog.initOwner(owner);
            dialog.initModality(Modality.WINDOW_MODAL);

            dialog.setTitle("New user");
            dialog.setHeaderText("Create a new user (ADMIN or STAFF)");

            ButtonType saveButtonType =
                    new ButtonType("Save", ButtonBar.ButtonData.OK_DONE);
            dialog.getDialogPane().getButtonTypes().addAll(saveButtonType, ButtonType.CANCEL);

            TextField usernameField = new TextField();
            usernameField.setPromptText("Username (required)");

            TextField displayNameField = new TextField();
            displayNameField.setPromptText("Display name (optional)");

            TextField emailField = new TextField();
            emailField.setPromptText("Email (optional)");

            ComboBox<String> roleBox = new ComboBox<>();
            roleBox.getItems().addAll("ADMIN", "STAFF");
            roleBox.getSelectionModel().select("STAFF");

            ComboBox<Branch> branchBox = new ComboBox<>();
            branchBox.getItems().addAll(branches);
            branchBox.setCellFactory(cb -> new ListCell<>() {
                @Override
                protected void updateItem(Branch item, boolean empty) {
                    super.updateItem(item, empty);
                    if (empty || item == null) {
                        setText(null);
                    } else {
                        setText(item.getName());
                    }
                }
            });
            branchBox.setButtonCell(new ListCell<>() {
                @Override
                protected void updateItem(Branch item, boolean empty) {
                    super.updateItem(item, empty);
                    if (empty || item == null) {
                        setText(null);
                    } else {
                        setText(item.getName());
                    }
                }
            });

            GridPane grid = new GridPane();
            grid.setHgap(10);
            grid.setVgap(8);
            grid.setPadding(new Insets(10, 10, 10, 10));

            int row = 0;
            grid.add(new Label("Username:"), 0, row);
            grid.add(usernameField,         1, row++);

            grid.add(new Label("Display name:"), 0, row);
            grid.add(displayNameField,          1, row++);

            grid.add(new Label("Email:"), 0, row);
            grid.add(emailField,         1, row++);

            grid.add(new Label("Role:"), 0, row);
            grid.add(roleBox,            1, row++);

            grid.add(new Label("Branch (for STAFF):"), 0, row);
            grid.add(branchBox,                     1, row++);

            dialog.getDialogPane().setContent(grid);

            Node saveButton = dialog.getDialogPane().lookupButton(saveButtonType);
            saveButton.setDisable(true);

            Runnable validate = () -> {
                String username = usernameField.getText() == null
                        ? ""
                        : usernameField.getText().trim();
                String role = roleBox.getValue();
                Branch b = branchBox.getValue();

                boolean ok = !username.isEmpty() && role != null;

                // STAFF must have branch
                if ("STAFF".equals(role) && b == null) {
                    ok = false;
                }
                saveButton.setDisable(!ok);
            };

            usernameField.textProperty().addListener((o, ov, nv) -> validate.run());
            roleBox.valueProperty().addListener((o, ov, nv) -> validate.run());
            branchBox.valueProperty().addListener((o, ov, nv) -> validate.run());

            dialog.setResultConverter(btn -> {
                if (btn == saveButtonType) {
                    String username   = usernameField.getText().trim();
                    String display    = displayNameField.getText() == null
                            ? null
                            : displayNameField.getText().trim();
                    String email      = emailField.getText() == null
                            ? null
                            : emailField.getText().trim();
                    String role       = roleBox.getValue();
                    Branch branch     = branchBox.getValue();
                    return new NewUserData(username, display, email, role, branch);
                }
                return null;
            });

            Optional<NewUserData> result = dialog.showAndWait();
            if (result.isEmpty()) return;

            NewUserData form = result.get();

            // Check username uniqueness
            Long countExisting = em.createQuery(
                    "SELECT COUNT(u) FROM User u WHERE u.username = :un", Long.class)
                    .setParameter("un", form.username())
                    .getSingleResult();
            if (countExisting != null && countExisting > 0L) {
                showAlert(Alert.AlertType.ERROR,
                        "Username already exists",
                        "The username '" + form.username() + "' is already in use.");
                return;
            }

            // Generate temp password
            String tempPassword = PasswordUtil.generateStrongPassword(10);

            em.getTransaction().begin();

            Integer nextId = ((Number) em.createQuery(
                    "SELECT COALESCE(MAX(u.id), 0) FROM User u",
                    Number.class
            ).getSingleResult()).intValue() + 1;

            User u = new User();
            u.setId(nextId);
            u.setUsername(form.username());
            u.setDisplayName(form.displayName());
            u.setEmail(form.email());
            u.setRole(form.role());
            u.setIsActive(Boolean.TRUE);
            u.setReset(Boolean.TRUE); // force change at first login
            if (form.branch() != null) {
                Branch managedBranch = em.getReference(Branch.class, form.branch().getId());
                u.setBranch(managedBranch);
            } else {
                u.setBranch(null);
            }

            u.setPassHash(PasswordUtil.hash(tempPassword));

            em.persist(u);
            em.getTransaction().commit();

            masterData.add(u);
            userTable.refresh();

            if (infoLabel != null) {
                infoLabel.setText("User created: " + u.getUsername());
            }

            showAlert(Alert.AlertType.INFORMATION,
                    "User created",
                    "Username: " + u.getUsername() + "\n" +
                    "Temporary password (share with user):\n\n" + tempPassword);

        } catch (Exception e) {
            e.printStackTrace();
            if (em.getTransaction().isActive())
                em.getTransaction().rollback();
            if (infoLabel != null) {
                infoLabel.setText("Error creating user: " + e.getMessage());
            }
        } finally {
            em.close();
        }
    }

    private record NewUserData(
            String username,
            String displayName,
            String email,
            String role,
            Branch branch
    ) {}

    @FXML
    private void onResetPassword() {
        if (!isAdmin()) {
            if (infoLabel != null)
                infoLabel.setText("Only ADMIN can reset passwords.");
            return;
        }

        User selected = userTable.getSelectionModel().getSelectedItem();
        if (selected == null) {
            if (infoLabel != null)
                infoLabel.setText("Select a user first.");
            return;
        }

        Alert confirm = new Alert(Alert.AlertType.CONFIRMATION);
        confirm.setTitle("Reset password");
        confirm.setHeaderText("Reset password for user: " + selected.getUsername());
        confirm.setContentText("This will generate a new temporary password "
                + "and force the user to change it at next login.");
        Optional<ButtonType> confRes = confirm.showAndWait();
        if (confRes.isEmpty() || confRes.get() != ButtonType.OK) {
            return;
        }

        String tempPassword = PasswordUtil.generateStrongPassword(10);

        EntityManager em = JPA.em();
        try {
            em.getTransaction().begin();
            User managed = em.find(User.class, selected.getId());
            if (managed == null) {
                em.getTransaction().rollback();
                if (infoLabel != null)
                    infoLabel.setText("User no longer exists.");
                return;
            }

            managed.setPassHash(PasswordUtil.hash(tempPassword));
            managed.setReset(Boolean.TRUE);

            em.getTransaction().commit();

            selected.setReset(Boolean.TRUE);
            userTable.refresh();

            if (infoLabel != null) {
                infoLabel.setText("Password reset for " + managed.getUsername());
            }

            showAlert(Alert.AlertType.INFORMATION,
                    "Password reset",
                    "Username: " + managed.getUsername() + "\n" +
                    "New temporary password:\n\n" + tempPassword);

        } catch (Exception e) {
            if (em.getTransaction().isActive())
                em.getTransaction().rollback();
            if (infoLabel != null)
                infoLabel.setText("Error resetting password: " + e.getMessage());
            e.printStackTrace();
        } finally {
            em.close();
        }
    }

    @FXML
    private void onToggleActive() {
        if (!isAdmin()) {
            if (infoLabel != null)
                infoLabel.setText("Only ADMIN can deactivate/activate users.");
            return;
        }

        User selected = userTable.getSelectionModel().getSelectedItem();
        if (selected == null) {
            if (infoLabel != null)
                infoLabel.setText("Select a user first.");
            return;
        }

        boolean newActive = !Boolean.TRUE.equals(selected.getIsActive());

        EntityManager em = JPA.em();
        try {
            em.getTransaction().begin();
            User managed = em.find(User.class, selected.getId());
            if (managed == null) {
                em.getTransaction().rollback();
                if (infoLabel != null)
                    infoLabel.setText("User no longer exists.");
                return;
            }

            managed.setIsActive(newActive);
            em.getTransaction().commit();

            selected.setIsActive(newActive);
            userTable.refresh();

            if (infoLabel != null) {
                infoLabel.setText("User " + managed.getUsername() +
                        (newActive ? " activated." : " deactivated."));
            }

        } catch (Exception e) {
            if (em.getTransaction().isActive())
                em.getTransaction().rollback();
            if (infoLabel != null)
                infoLabel.setText("Error updating user: " + e.getMessage());
            e.printStackTrace();
        } finally {
            em.close();
        }
    }

    private void showAlert(Alert.AlertType type, String title, String message) {
        Alert a = new Alert(type);
        a.setTitle(title);
        a.setHeaderText(null);
        a.setContentText(message);
        a.showAndWait();
    }

    // =====================================================
    // Navigation
    // =====================================================

    @FXML
    private void onNavOverview(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/home.fxml", "Main Menu");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @FXML
    private void onNavSimulators(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/simulators.fxml", "Simulators");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @FXML
    private void onNavStock(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/stock.fxml", "Stock");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }

    @FXML
    private void onNavMaintentance(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/maintenance.fxml", "Maintenance");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }


	
    @FXML
    private void onLogout(ActionEvent event) {
        try {
            ViewUtil.switchScene(event, "/ui/login.fxml", "Login");
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
<?xml version="1.0" encoding="UTF-8"?>
<persistence xmlns="http://xmlns.jcp.org/xml/ns/persistence"
             xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
             version="2.2"
             xsi:schemaLocation="
               http://xmlns.jcp.org/xml/ns/persistence
               http://xmlns.jcp.org/xml/ns/persistence/persistence_2_2.xsd">

  <persistence-unit name="dbprojectPU" transaction-type="RESOURCE_LOCAL">
    <provider>org.hibernate.jpa.HibernatePersistenceProvider</provider>

    <!-- Entities -->
    <class>com.example.domain.User</class>
    <!-- <class>com.example.domain.AuditableEntity</class> -->
    <class>com.example.domain.Branch</class>
    <class>com.example.domain.Department</class>
    <class>com.example.domain.SimulatorModel</class>
    <class>com.example.domain.Simulator</class>
    <class>com.example.domain.Maintenance</class>
    <class>com.example.domain.Maintained</class>
    <class>com.example.domain.Borrowing</class>
    <class>com.example.domain.BorrowSim</class>
    <class>com.example.domain.Consumable</class>
    <class>com.example.domain.Stock</class>
    <class>com.example.domain.BorrowCons</class>

    <properties>
      <!-- DB connection -->
      <property name="javax.persistence.jdbc.driver" value="com.mysql.cj.jdbc.Driver"/>
      <property name="javax.persistence.jdbc.url"
                value="jdbc:mysql://192.168.56.101:3306/dbproject?useSSL=false&amp;allowPublicKeyRetrieval=true&amp;serverTimezone=UTC"/>
      <property name="javax.persistence.jdbc.user" value="dbsys1"/>
      <property name="javax.persistence.jdbc.password" value="dbsys1"/>

      <!-- Hibernate -->
      <property name="hibernate.dialect" value="org.hibernate.dialect.MySQL8Dialect"/>
      <property name="hibernate.hbm2ddl.auto" value="validate"/>
      <property name="hibernate.show_sql" value="true"/>
      <property name="hibernate.format_sql" value="true"/>
    </properties>
  </persistence-unit>
</persistence>
<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>

<BorderPane xmlns="http://javafx.com/javafx/8"
            xmlns:fx="http://javafx.com/fxml/1"
            fx:controller="com.example.ui.HomeController"
            prefWidth="1200" prefHeight="750"
            style="-fx-background-color: linear-gradient(to bottom right, #14532d, #22c55e);">

    <top>
        <HBox alignment="CENTER_LEFT"
              spacing="10"
              style="-fx-padding: 16 32 16 32;">
            <children>
                <Label text="LAU"
                       style="-fx-text-fill: #f9fafb; -fx-font-size: 22px; -fx-font-weight: bold;"/>

                <Label text="· Clinical Simulator Center Inventory Management"
                       style="-fx-text-fill: #d1fae5; -fx-font-size: 13px;"/>

                <Pane HBox.hgrow="ALWAYS"/>

                <Label fx:id="userLabel"
                       text="Logged in user"
                       style="-fx-text-fill: #f9fafb; -fx-font-size: 12px;"/>
            </children>
        </HBox>
    </top>

    <left>
        <VBox spacing="8"
              style="-fx-background-color: #14532d;
                     -fx-padding: 24 14 24 24;">
            <children>
                <Label text="Navigation"
                       style="-fx-text-fill: #e5e7eb;
                              -fx-font-size: 12px;
                              -fx-font-weight: bold;
                              -fx-padding: 0 0 8 0;"/>

                <Button text="Overview"
                        maxWidth="Infinity"
                        style="-fx-background-color: rgba(0,0,0,0.22);
                               -fx-text-fill: #f9fafb;
							   -fx-font-weight: bold;
                               -fx-alignment: CENTER_LEFT;
							   -fx-background-radius: 999;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Simulators"
                        onAction="#onNavSimulators"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #ecfdf5;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 14 8 14;"/>

                <Button text="Consumables &amp; Stock"
                        onAction="#onNavStock"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Borrowing"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Maintenance"
                        maxWidth="Infinity"
						onAction="#onNavMaintentance"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Users"
                        maxWidth="Infinity"
						onAction="#onNavUsers"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Separator style="-fx-opacity: 0.4; -fx-padding: 8 0 8 0;"/>

                <Button text="Settings"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Pane VBox.vgrow="ALWAYS"/>

                <Button text="Logout"
                        onAction="#onLogout"
                        maxWidth="Infinity"
                        style="-fx-background-color: #ef4444;
                               -fx-text-fill: white;
                               -fx-font-weight: bold;
                               -fx-background-radius: 999;
                               -fx-padding: 8 12 8 12;"/>
            </children>
        </VBox>
    </left>

    <center>
        <!-- <ScrollPane fitToWidth="true" fitToHeight="true"
                    style="-fx-background-color: transparent; 
						   -fx-padding: 8 24 24 8;">
            <content> -->
                <StackPane>
                    <padding>
                        <Insets top="8" right="8" bottom="8" left="8"/>
                    </padding>
                    <children>
                        <VBox spacing="16"
                              style="-fx-background-color: #f9fafb;
                                     -fx-background-radius: 20;
                                     -fx-padding: 24;
                                     -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.24), 22, 0.21, 0, 4);">

                            <HBox spacing="4" alignment="CENTER_LEFT">
                                <children>
                                    <VBox spacing="4">
                                        <Label text="Overview"
                                               style="-fx-text-fill: #111827;
                                                      -fx-font-size: 22px;
                                                      -fx-font-weight: bold;"/>
                                    </VBox>
                                </children>
                            </HBox>

                            <!-- KPI CARDS: now in a 2x2 layout with icons-like accent -->
                            <HBox spacing="14">
                                <!-- Total simulators -->
                                <VBox spacing="6"
                                      HBox.hgrow="ALWAYS"
                                      style="-fx-background-color: #ffffff;
                                             -fx-background-radius: 14;
                                             -fx-padding: 14;
                                             -fx-border-color: #e5e7eb;
                                             -fx-border-radius: 14;">
                                    <Label text="Total Simulators"
                                           style="-fx-text-fill: #6b7280;
                                                  -fx-font-size: 11px;
                                                  -fx-font-weight: bold;"/>
                                    <Label fx:id="totalSimulatorsLabel"
                                           text="—"
                                           style="-fx-text-fill: #111827;
                                                  -fx-font-size: 24px;
                                                  -fx-font-weight: bold;"/>
                                    <Label text="Across all branches."
                                           style="-fx-text-fill: #9ca3af;
                                                  -fx-font-size: 11px;"/>
                                </VBox>

                                <!-- Active borrowings -->
                                <VBox spacing="6"
                                      HBox.hgrow="ALWAYS"
                                      style="-fx-background-color: #ffffff;
                                             -fx-background-radius: 14;
                                             -fx-padding: 14;
                                             -fx-border-color: #e5e7eb;
                                             -fx-border-radius: 14;">
                                    <Label text="Active Borrowings"
                                           style="-fx-text-fill: #6b7280;
                                                  -fx-font-size: 11px;
                                                  -fx-font-weight: bold;"/>
                                    <Label fx:id="activeBorrowingsLabel"
                                           text="—"
                                           style="-fx-text-fill: #111827;
                                                  -fx-font-size: 24px;
                                                  -fx-font-weight: bold;"/>
                                    <Label text="Open simulator loans."
                                           style="-fx-text-fill: #9ca3af;
                                                  -fx-font-size: 11px;"/>
                                </VBox>

                                <!-- Upcoming calibrations -->
                                <VBox spacing="6"
                                      HBox.hgrow="ALWAYS"
                                      style="-fx-background-color: #ffffff;
                                             -fx-background-radius: 14;
                                             -fx-padding: 14;
                                             -fx-border-color: #e5e7eb;
                                             -fx-border-radius: 14;">
                                    <Label text="Upcoming Calibrations"
                                           style="-fx-text-fill: #6b7280;
                                                  -fx-font-size: 11px;
                                                  -fx-font-weight: bold;"/>
                                    <Label fx:id="upcomingCalibrationsLabel"
                                           text="—"
                                           style="-fx-text-fill: #111827;
                                                  -fx-font-size: 24px;
                                                  -fx-font-weight: bold;"/>
                                    <Label text="Within the next 30 days."
                                           style="-fx-text-fill: #9ca3af;
                                                  -fx-font-size: 11px;"/>
                                </VBox>
                            </HBox>

                            <Separator style="-fx-opacity: 0.4;"/>

                            <!-- LOWER SECTION: TWO CARDS STACKED SIDE BY SIDE -->
                            <HBox spacing="16">
                                <!-- Recent Maintenance -->
                                <VBox spacing="8" HBox.hgrow="ALWAYS"
                                      style="-fx-background-color: #ffffff;
                                             -fx-background-radius: 14;
                                             -fx-padding: 14;
                                             -fx-border-color: #e5e7eb;
                                             -fx-border-radius: 14;">
                                    <Label text="Recent Maintenance Events"
                                           style="-fx-text-fill: #111827;
                                                  -fx-font-size: 14px;
                                                  -fx-font-weight: bold;"/>
                                    <Label text="Latest work done on simulators."
                                           style="-fx-text-fill: #6b7280;
                                                  -fx-font-size: 11px;"/>

                                    <TableView fx:id="maintenanceTable"
                                               prefHeight="230"
                                               style="-fx-background-color: transparent;
                                                      -fx-control-inner-background: #ffffff;
                                                      -fx-table-cell-border-color: #e5e7eb;
                                                      -fx-table-header-border-color: #e5e7eb;">
                                        <columns>
                                            <TableColumn fx:id="maintDateCol"   text="Date"      prefWidth="110"/>
                                            <TableColumn fx:id="maintSimCol"    text="Simulator" prefWidth="150"/>
                                            <TableColumn fx:id="maintTypeCol"   text="Type"      prefWidth="140"/>
                                            <TableColumn fx:id="maintVendorCol" text="Vendor"    prefWidth="150"/>
                                        </columns>
                                    </TableView>
                                </VBox>

                                <!-- Low stock -->
                                <VBox spacing="8" HBox.hgrow="ALWAYS"
                                      style="-fx-background-color: #ffffff;
                                             -fx-background-radius: 14;
                                             -fx-padding: 14;
                                             -fx-border-color: #e5e7eb;
                                             -fx-border-radius: 14;">
                                    <Label text="Low Stock Alerts"
                                           style="-fx-text-fill: #111827;
                                                  -fx-font-size: 14px;
                                                  -fx-font-weight: bold;"/>
                                    <Label text="Consumables at or below threshold."
                                           style="-fx-text-fill: #6b7280;
                                                  -fx-font-size: 11px;"/>

                                    <TableView fx:id="stockTable"
                                               prefHeight="230"
                                               style="-fx-background-color: transparent;
                                                      -fx-control-inner-background: #ffffff;
                                                      -fx-table-cell-border-color: #e5e7eb;
                                                      -fx-table-header-border-color: #e5e7eb;">
                                        <columns>
                                            <TableColumn fx:id="stockConsCol"   text="Consumable" prefWidth="170"/>
                                            <TableColumn fx:id="stockBranchCol" text="Branch"     prefWidth="130"/>
                                            <TableColumn fx:id="stockAvailCol"  text="Available"  prefWidth="80"/>
                                            <TableColumn fx:id="stockResCol"    text="Reserved"   prefWidth="80"/>
                                        </columns>
                                    </TableView>
                                </VBox>
                            </HBox>
                        </VBox>
                    </children>
                </StackPane>
            <!-- </content>
        </ScrollPane> -->
    </center>

    <bottom>
        <HBox alignment="CENTER_RIGHT"
              style="-fx-padding: 4 24 8 24;">
            <children>
                <Label text="LAU · Clinical Simulator Center Inventory"
                       style="-fx-text-fill: #e5e7eb; -fx-font-size: 11px;"/>
            </children>
        </HBox>
    </bottom>
</BorderPane>
<?xml version="1.0" encoding="UTF-8"?>
<?import javafx.scene.layout.*?>
<?import javafx.scene.control.*?>
<?import javafx.geometry.*?>

<BorderPane xmlns="http://javafx.com/javafx"
            xmlns:fx="http://javafx.com/fxml"
            fx:controller="com.example.ui.LoginController"
            prefWidth="1200" prefHeight="720"
            style="-fx-background-color: linear-gradient(to bottom right, #14532d, #22c55e);">

    <!-- Top header bar -->
    <top>
        <HBox alignment="CENTER_LEFT"
              spacing="10"
              style="-fx-padding: 18 32 12 32;">
            <children>
                <Label text="LAU"
                       style="-fx-text-fill: #f9fafb;
                              -fx-font-size: 24px;
                              -fx-font-weight: bold;"/>

                <Label text="· Clinical Simulator Center Inventory Management"
                       style="-fx-text-fill: #d1fae5;
                              -fx-font-size: 14px;"/>

                <Pane HBox.hgrow="ALWAYS"/>

                <Label text="v1.0"
                       style="-fx-text-fill: #bbf7d0;
                              -fx-font-size: 11px;"/>
            </children>
        </HBox>
    </top>

    <!-- Center content -->
    <center>
        <StackPane>
            <padding>
                <Insets top="0" right="40" bottom="0" left="40"/>
            </padding>
            <children>

                <!-- subtle background card behind the main one -->
                <VBox spacing="18" alignment="CENTER">
                    <children>
                        <StackPane maxWidth="520">
                            <children>
                                <!-- Glassy background shape -->
                                <Pane style="-fx-background-color: rgba(15,118,110,0.25);
                                             -fx-background-radius: 32;
                                             -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.35), 40, 0.3, 0, 10);"
                                      prefHeight="420"/>
                            </children>
                        </StackPane>
                    </children>
                </VBox>

                <!-- Main login card -->
                <VBox spacing="24"
                      alignment="CENTER"
                      maxWidth="520"
                      style="-fx-background-color: #f9fafb;
                             -fx-background-radius: 26;
                             -fx-padding: 28 32 28 32;
                             -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.35), 28, 0.18, 0, 6);">

                    <!-- Title + subtitle -->
                    <VBox spacing="6" alignment="CENTER_LEFT" maxWidth="Infinity">
                        <Label text="Sign in to your account"
                               style="-fx-font-size: 22px;
                                      -fx-font-weight: bold;
                                      -fx-text-fill: #111827;"/>
                        <Label text="Use your LAU simulator center credentials to continue."
                               wrapText="true"
                               maxWidth="420"
                               style="-fx-font-size: 12px;
                                      -fx-text-fill: #6b7280;"/>
                    </VBox>

                    <Separator/>

                    <!-- Form section -->
                    <VBox spacing="16" alignment="CENTER_LEFT" maxWidth="Infinity">

                        <!-- Username -->
                        <VBox spacing="4" maxWidth="Infinity">
                            <Label text="Username"
                                   style="-fx-text-fill: #374151;
                                          -fx-font-size: 12px;
                                          -fx-font-weight: bold;"/>

                            <TextField fx:id="usernameField"
                                       promptText="Enter your username"
                                       maxWidth="Infinity"
                                       style="-fx-background-radius: 999;
                                              -fx-border-radius: 999;
                                              -fx-border-color: #d1d5db;
                                              -fx-padding: 8 12 8 12;
                                              -fx-background-color: #ffffff;"/>
                        </VBox>

                        <!-- Password -->
                        <VBox spacing="4" maxWidth="Infinity">
                            <Label text="Password"
                                   style="-fx-text-fill: #374151;
                                          -fx-font-size: 12px;
                                          -fx-font-weight: bold;"/>

                            <PasswordField fx:id="passwordField"
                                           promptText="••••••••"
                                           onAction="#onLogin"
                                           maxWidth="Infinity"
                                           style="-fx-background-radius: 999;
                                                  -fx-border-radius: 999;
                                                  -fx-border-color: #d1d5db;
                                                  -fx-padding: 8 12 8 12;
                                                  -fx-background-color: #ffffff;"/>
                        </VBox>

                        <!-- Error label -->
                        <Label fx:id="errorLabel"
                               textFill="red"
                               wrapText="true"
                               maxWidth="Infinity"
                               style="-fx-font-size: 11px;"/>
							   
                    </VBox>

                    <!-- Sign in button -->
                    <Button text="Sign in"
                            onAction="#onLogin"
                            maxWidth="Infinity"
                            style="-fx-background-color: linear-gradient(to right,#16a34a,#22c55e);
                                   -fx-text-fill: white;
                                   -fx-font-weight: bold;
                                   -fx-background-radius: 999;
                                   -fx-padding: 10 20 10 20;"/>

                    <!-- Small footer inside card -->
                    <HBox alignment="CENTER" spacing="4">
                        <Label text="LAU Clinical Simulator Center"
                               style="-fx-text-fill: #9ca3af;
                                      -fx-font-size: 11px;"/>
                        <Label text="·"
                               style="-fx-text-fill: #d1d5db;"/>
                        <Label text="Internal use only"
                               style="-fx-text-fill: #9ca3af;
                                      -fx-font-size: 11px;"/>
                    </HBox>
                </VBox>
            </children>
        </StackPane>
    </center>

    <!-- Bottom footer -->
    <bottom>
        <HBox alignment="CENTER_RIGHT"
              style="-fx-padding: 6 24 10 24;">
            <children>
                <Label text="© LAU · Clinical Simulator Center Inventory"
                       style="-fx-text-fill: #d1fae5;
                              -fx-font-size: 11px;"/>
            </children>
        </HBox>
    </bottom>
</BorderPane>
<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>

<BorderPane xmlns="http://javafx.com/javafx"
            xmlns:fx="http://javafx.com/fxml"
            fx:controller="com.example.ui.MaintenanceController"
            prefWidth="1200" prefHeight="750"
            style="-fx-background-color: linear-gradient(to bottom right, #14532d, #22c55e);">

    <!-- TOP BAR -->
    <top>
        <HBox alignment="CENTER_LEFT"
              spacing="10"
              style="-fx-padding: 16 32 16 32;">
            <children>
                <Label text="LAU"
                       style="-fx-text-fill: #f9fafb;
                              -fx-font-size: 22px;
                              -fx-font-weight: bold;"/>

                <Label text="· Clinical Simulator Center Inventory Management"
                       style="-fx-text-fill: #d1fae5;
                              -fx-font-size: 13px;"/>

                <Pane HBox.hgrow="ALWAYS"/>

                <Label fx:id="userLabel"
                       text="Logged in user"
                       style="-fx-text-fill: #f9fafb;
                              -fx-font-size: 12px;"/>
            </children>
        </HBox>
    </top>

    <!-- LEFT NAV -->
    <left>
        <VBox spacing="8"
              style="-fx-background-color: #14532d;
                     -fx-padding: 24 14 24 24;">
            <children>
                <Label text="Navigation"
                       style="-fx-text-fill: #e5e7eb;
                              -fx-font-size: 12px;
                              -fx-font-weight: bold;
                              -fx-padding: 0 0 8 0;"/>

                <Button text="Overview"
                        onAction="#onNavOverview"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Simulators"
                        onAction="#onNavSimulators"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Consumables &amp; Stock"
                        onAction="#onNavStock"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Borrowing"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Maintenance"
                        maxWidth="Infinity"
                        style="-fx-background-color: rgba(0,0,0,0.22);
                               -fx-text-fill: #f9fafb;
                               -fx-font-weight: bold;
                               -fx-alignment: CENTER_LEFT;
                               -fx-background-radius: 999;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Users"
                        maxWidth="Infinity"
						onAction="#onNavUsers"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Separator style="-fx-opacity: 0.4; -fx-padding: 8 0 8 0;"/>

                <Button text="Settings"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Pane VBox.vgrow="ALWAYS"/>

                <Button text="Logout"
                        onAction="#onLogout"
                        maxWidth="Infinity"
                        style="-fx-background-color: #ef4444;
                               -fx-text-fill: white;
                               -fx-font-weight: bold;
                               -fx-background-radius: 999;
                               -fx-padding: 8 12 8 12;"/>
            </children>
        </VBox>
    </left>

    <!-- CENTER CONTENT -->
    <center>
	    <!-- <ScrollPane fitToWidth="true" fitToHeight="true"
	                style="-fx-background-color: transparent;
	                       -fx-padding: 12 16 16 8;">
	        <content> -->
	            <StackPane>
	                <padding>
	                    <Insets top="8" right="8" bottom="8" left="8"/>
	                </padding>
	                <children>
	                    <VBox spacing="16"
	                          maxWidth="1400"
	                          StackPane.alignment="TOP_CENTER"
	                          style="-fx-background-color: #f9fafb;
	                                 -fx-background-radius: 20;
	                                 -fx-padding: 24;
	                                 -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.24), 22, 0.21, 0, 4);">
	
	                        <!-- Title -->
	                        <VBox spacing="4">
	                            <Label text="Maintenance"
	                                   style="-fx-text-fill: #111827;
	                                          -fx-font-size: 22px;
	                                          -fx-font-weight: bold;"/>
	                            <Label text="Create and track maintenance events for simulators."
	                                   style="-fx-text-fill: #6b7280;
	                                          -fx-font-size: 11px;"/>
	                        </VBox>
	
	                        <!-- Search / sort -->
	                        <HBox spacing="10">
	                            <TextField fx:id="searchField"
	                                       promptText="Search by type, vendor, ID, notes, date..."
	                                       HBox.hgrow="ALWAYS"
	                                       style="-fx-background-radius: 999;
	                                              -fx-border-radius: 999;
	                                              -fx-border-color: #d1d5db;
	                                              -fx-padding: 6 12 6 12;
	                                              -fx-background-color: #ffffff;"/>
	
	                            <ComboBox fx:id="sortByCombo"
	                                      prefWidth="180"
	                                      promptText="Sort by"
	                                      style="-fx-background-radius: 999;
	                                             -fx-border-radius: 999;
	                                             -fx-border-color: #d1d5db;
	                                             -fx-padding: 4 10 4 10;
	                                             -fx-background-color: #ffffff;"/>
	                        </HBox>
	
	                        <!-- Main layout: table + actions -->
	                        <HBox spacing="14">
	                            <!-- Table -->
	                            <TableView fx:id="maintenanceTable"
	                                       prefHeight="520"
	                                       HBox.hgrow="ALWAYS"
	                                       style="-fx-background-color: transparent;
	                                              -fx-control-inner-background: #ffffff;
	                                              -fx-table-cell-border-color: #e5e7eb;
	                                              -fx-table-header-border-color: #e5e7eb;">
	                                <columns>
	                                    <TableColumn fx:id="idColumn"
	                                                 text="ID"
	                                                 prefWidth="60"/>
	                                    <TableColumn fx:id="typeColumn"
	                                                 text="Type"
	                                                 prefWidth="140"/>
	                                    <TableColumn fx:id="vendorColumn"
	                                                 text="Vendor"
	                                                 prefWidth="170"/>
	                                    <TableColumn fx:id="startDateColumn"
	                                                 text="Start date"
	                                                 prefWidth="110"/>
	                                    <TableColumn fx:id="endDateColumn"
	                                                 text="End date"
	                                                 prefWidth="110"/>
	                                    <TableColumn fx:id="simCountColumn"
	                                                 text="# Sims"
	                                                 prefWidth="70"/>
	                                    <TableColumn fx:id="notesColumn"
	                                                 text="Notes"
	                                                 prefWidth="260"/>
	                                </columns>
	                            </TableView>
	
	                            <!-- Actions panel -->
	                            <VBox spacing="12"
	                                  prefWidth="240"
	                                  style="-fx-background-color: #ffffff;
	                                         -fx-background-radius: 14;
	                                         -fx-padding: 16;
	                                         -fx-border-color: #e5e7eb;
	                                         -fx-border-radius: 14;">
	                                <Label text="Actions"
	                                       style="-fx-text-fill: #111827;
	                                              -fx-font-size: 16px;
	                                              -fx-font-weight: bold;"/>
	
	                                <Separator/>
	
	                                <Label text="New maintenance event"
	                                       style="-fx-text-fill: #111827;
	                                              -fx-font-size: 14px;
	                                              -fx-font-weight: bold;"/>
	
	
	                                <Button text="Add maintenance event"
	                                        onAction="#onAddMaintenance"
	                                        maxWidth="Infinity"
	                                        style="-fx-background-color: #22c55e;
	                                               -fx-text-fill: white;
	                                               -fx-font-weight: bold;
	                                               -fx-background-radius: 999;
	                                               -fx-padding: 8 12 8 12;"/>
	
	                                <Label text="Tip: in the pop-up, hold Ctrl (or Cmd on macOS) to select multiple simulators."
	                                       wrapText="true"
	                                       style="-fx-text-fill: #6b7280;
	                                              -fx-font-size: 10px;"/>
									
									<Separator/>
	
	                                <Label text="Tip: double click on the maintenance event for the returned simulators."
	                                       wrapText="true"
	                                       style="-fx-text-fill: #6b7280;
	                                              -fx-font-size: 10px;"/>
	                            </VBox>
	                        </HBox>
	
	                        <Label fx:id="infoLabel"
	                               textFill="red"
	                               wrapText="true"
	                               maxWidth="Infinity"/>
	                    </VBox>
	                </children>
	            </StackPane>
	        <!-- </content>
	    </ScrollPane> -->
	</center>

    <!-- BOTTOM FOOTER -->
    <bottom>
        <HBox alignment="CENTER_RIGHT"
              style="-fx-padding: 4 24 8 24;">
            <children>
                <Label text="LAU · Clinical Simulator Center Inventory"
                       style="-fx-text-fill: #e5e7eb; -fx-font-size: 11px;"/>
            </children>
        </HBox>
    </bottom>
</BorderPane>
<?xml version="1.0" encoding="UTF-8"?>
<?import javafx.scene.layout.*?>
<?import javafx.scene.control.*?>
<?import javafx.geometry.*?>

<BorderPane xmlns="http://javafx.com/javafx"
            xmlns:fx="http://javafx.com/fxml"
            prefWidth="1000" prefHeight="650"
            style="-fx-background-color: linear-gradient(to bottom right, #2d7a00ff, #38800fff);">

    <!-- Top header bar -->
    <top>
        <HBox alignment="CENTER_LEFT"
              spacing="10"
              style="-fx-padding: 16 32 12 32;">
            <children>
                <Label text="LAU"
                       style="-fx-text-fill: #e5e7eb; -fx-font-size: 22px; -fx-font-weight: bold;"/>
                <Label text="· Create your password"
                       style="-fx-text-fill: #e5e7eb; -fx-font-size: 14px;"/>
            </children>
        </HBox>
    </top>

    <!-- Center content -->
    <center>
        <StackPane>
            <padding>
                <Insets top="0" right="40" bottom="0" left="40"/>
            </padding>
            <children>
                <HBox spacing="40" alignment="CENTER">
                    <!-- Left explanatory panel -->
                    <VBox spacing="16" alignment="CENTER_LEFT">
                        <Label text="Secure your account"
                               style="-fx-text-fill: #e5e7eb; -fx-font-size: 26px; -fx-font-weight: bold;"/>
                        <Label text="Choose a strong password. You will use it to sign in to the system."
                               wrapText="true"
                               maxWidth="320"
                               style="-fx-text-fill: #e5e7eb; -fx-font-size: 13px;"/>
                    </VBox>

                    <!-- Right card with form -->
                    <VBox spacing="20"
                          alignment="CENTER"
                          maxWidth="420"
                          style="
                            -fx-background-color: #ffffff;
                            -fx-background-radius: 18;
                            -fx-padding: 28;
                            -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.35), 24, 0.2, 0, 4);
                          ">

                        <!-- Title -->
                        <VBox spacing="4" alignment="CENTER_LEFT">
                            <Label text="Create your password"
                                   style="-fx-font-size: 20px; -fx-font-weight: bold; -fx-text-fill: #111827;"/>
                            <Label text="Passwords must be at least 8 characters and include upper, lower case letters and a digit."
                                   wrapText="true"
                                   style="-fx-font-size: 12px; -fx-text-fill: #6b7280;"/>
                        </VBox>

                        <Separator/>

                        <!-- Form: simple vertical stack, so no overlap -->
                        <VBox spacing="10" alignment="CENTER_LEFT" maxWidth="Infinity">

                            <!-- Username (read-only) -->
                            <VBox spacing="4" maxWidth="Infinity">
                                <Label text="Username:"
                                       style="-fx-text-fill: #374151;"/>
                                <TextField fx:id="usernameField"
                                           editable="false"
                                           style="
                                              -fx-background-radius: 8;
                                              -fx-border-radius: 8;
                                              -fx-border-color: #e5e7eb;
                                              -fx-padding: 6;
                                              -fx-background-color: #f9fafb;
                                           "
                                           maxWidth="Infinity"/>
                            </VBox>

                            <!-- New password -->
                            <VBox spacing="4" maxWidth="Infinity">
                                <Label text="New password:"
                                       style="-fx-text-fill: #374151;"/>
                                <PasswordField fx:id="pass1"
                                               promptText="at least 8 characters"
                                               style="
                                                 -fx-background-radius: 8;
                                                 -fx-border-radius: 8;
                                                 -fx-border-color: #d1d5db;
                                                 -fx-padding: 6;
                                               "
                                               maxWidth="Infinity"/>
                            </VBox>

                            <!-- Confirm password -->
                            <VBox spacing="4" maxWidth="Infinity">
                                <Label text="Confirm password:"
                                       style="-fx-text-fill: #374151;"/>
                                <PasswordField fx:id="pass2"
                                               promptText="retype password"
                                               onAction="#onSave"
                                               style="
                                                 -fx-background-radius: 8;
                                                 -fx-border-radius: 8;
                                                 -fx-border-color: #d1d5db;
                                                 -fx-padding: 6;
                                               "
                                               maxWidth="Infinity"/>
                            </VBox>

                            <!-- Error label -->
                            <Label fx:id="errorLabel"
                                   textFill="red"
                                   wrapText="true"
                                   maxWidth="Infinity"/>
                        </VBox>

                        <!-- Save button -->
                        <Button text="Save password"
                                onAction="#onSave"
                                maxWidth="Infinity"
                                style="
                                  -fx-background-color: linear-gradient(to right, #38800fff, #2d7a00ff);
                                  -fx-text-fill: white;
                                  -fx-font-weight: bold;
                                  -fx-background-radius: 999;
                                  -fx-padding: 10 20 10 20;
                                "/>
                    </VBox>
                </HBox>
            </children>
        </StackPane>
    </center>
</BorderPane>
<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>

<BorderPane xmlns="http://javafx.com/javafx"
            xmlns:fx="http://javafx.com/fxml"
            fx:controller="com.example.ui.SimulatorsController"
            prefWidth="1200" prefHeight="750"
            style="-fx-background-color: linear-gradient(to bottom right, #14532d, #22c55e);">

    <top>
        <HBox alignment="CENTER_LEFT"
              spacing="10"
              style="-fx-padding: 16 32 16 32;">
            <children>
                <Label text="LAU"
                       style="-fx-text-fill: #f9fafb;
					   		  -fx-font-size: 22px;
							  -fx-font-weight: bold;"/>

                <Label text="· Clinical Simulator Center Inventory Management"
                       style="-fx-text-fill: #d1fae5;
					   		  -fx-font-size: 13px;"/>

                <Pane HBox.hgrow="ALWAYS"/>

                <Label fx:id="userLabel"
                       text="Logged in user"
                       style="-fx-text-fill: #f9fafb;
					   		  -fx-font-size: 12px;"/>
            </children>
        </HBox>
    </top>

    <left>
        <VBox spacing="8"
              style="-fx-background-color: #14532d;
                     -fx-padding: 24 14 24 24;">
            <children>
                <Label text="Navigation"
                       style="-fx-text-fill: #e5e7eb;
					   -fx-font-size: 12px;
					   -fx-font-weight: bold;
					   -fx-padding: 0 0 8 0;"/>

                <Button text="Overview"
                        onAction="#onNavOverview"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Simulators"
                        maxWidth="Infinity"
                        style="-fx-background-color: rgba(0,0,0,0.22);
                               -fx-text-fill: #f9fafb;
                               -fx-font-weight: bold;
                               -fx-alignment: CENTER_LEFT;
                               -fx-background-radius: 999;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Consumables &amp; Stock"
                        onAction="#onNavStock"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Borrowing"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Maintenance"
                        maxWidth="Infinity"
						onAction="#onNavMaintentance"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Users"
                        maxWidth="Infinity"
						onAction="#onNavUsers"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Separator style="-fx-opacity: 0.4; -fx-padding: 8 0 8 0;"/>

                <Button text="Settings"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Pane VBox.vgrow="ALWAYS"/>

                <Button text="Logout"
                        onAction="#onLogout"
                        maxWidth="Infinity"
                        style="-fx-background-color: #ef4444;
                               -fx-text-fill: white;
                               -fx-font-weight: bold;
                               -fx-background-radius: 999;
                               -fx-padding: 8 12 8 12;"/>
            </children>
        </VBox>
    </left>

    <center>
        <!-- <ScrollPane fitToWidth="true" fitToHeight="true"
                    style="-fx-background-color: transparent; 
						   -fx-padding: 8 24 24 8;">
            <content> -->
                <StackPane>
                    <padding>
                        <Insets top="8" right="8" bottom="8" left="8"/>
                    </padding>
                    <children>
                        <VBox spacing="16"
							  maxWidth="1400"
                              style="-fx-background-color: #f9fafb;
                                     -fx-background-radius: 20;
                                     -fx-padding: 24;
                                     -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.24), 22, 0.21, 0, 4);">

                            <VBox spacing="4">
                                <Label text="Simulators"
                                       style="-fx-text-fill: #111827;
									   		  -fx-font-size: 22px;
											  -fx-font-weight: bold;"/>
                            </VBox>

                            <HBox spacing="10">
                                <TextField fx:id="searchField"
                                           promptText="Search by tag, model, branch, status, date..."
                                           HBox.hgrow="ALWAYS"
                                           style="-fx-background-radius: 999;
                                             	  -fx-border-radius: 999;
												  -fx-border-color: #d1d5db;
												  -fx-padding: 6 12 6 12;
												  -fx-background-color: #ffffff;"/>

                                <ComboBox fx:id="sortByCombo"
                                          prefWidth="180"
                                          promptText="Sort by"
                                          style="-fx-background-radius: 999;
										  		 -fx-border-radius: 999;
												 -fx-border-color: #d1d5db;
												 -fx-padding: 4 10 4 10;
												 -fx-background-color: #ffffff;"/>
                            </HBox>

                            <HBox spacing="16">
                                <TableView fx:id="simulatorTable"
                                           prefHeight="480"
                                           HBox.hgrow="ALWAYS"
                                           style="-fx-background-color: transparent;
										   		  -fx-control-inner-background: #ffffff;
												  -fx-table-cell-border-color: #e5e7eb;
												  -fx-table-header-border-color: #e5e7eb;">
                                    <columns>
                                        <TableColumn fx:id="tagColumn"
                                                     text="Tag"
                                                     prefWidth="120"/>
                                        <TableColumn fx:id="modelColumn"
                                                     text="Model"
                                                     prefWidth="140"/>
                                        <TableColumn fx:id="modelSpecsColumn"
                                                     text="Specs"
                                                     prefWidth="220"/>
                                        <TableColumn fx:id="modelCalReqColumn"
                                                     text="Cal. required"
                                                     prefWidth="110"/>
                                        <TableColumn fx:id="modelMaxDaysColumn"
                                                     text="Max days"
                                                     prefWidth="90"/>
                                        <TableColumn fx:id="branchColumn"
                                                     text="Branch"
                                                     prefWidth="130"/>
                                        <TableColumn fx:id="statusColumn"
                                                     text="Status"
                                                     prefWidth="120"/>
                                        <TableColumn fx:id="nextCalColumn"
                                                     text="Next Calibration"
                                                     prefWidth="140"/>
                                    </columns>
                                </TableView>

                                <VBox spacing="12"
                                      prefWidth="260"
                                      style="-fx-background-color: #ffffff;
                                             -fx-background-radius: 14;
                                             -fx-padding: 16;
                                             -fx-border-color: #e5e7eb;
                                             -fx-border-radius: 14;">
                                    <Label text="Actions"
                                           style="-fx-text-fill: #111827;
										   		  -fx-font-size: 16px;
										   		  -fx-font-weight: bold;"/>

                                    <Separator/>

									<Label text="Simulator operations"
                                           style="-fx-text-fill: #111827;
                                                  -fx-font-size: 14px;
                                                  -fx-font-weight: bold;"/>
									
                                    <Button text="Mark as OUT OF SERVICE"
                                            onAction="#onMarkOutOfService"
                                            maxWidth="Infinity"
                                            style="-fx-background-color: #22c55e;
                                                   -fx-text-fill: white;
                                                   -fx-font-weight: bold;
                                                   -fx-background-radius: 999;
                                                   -fx-padding: 8 12 8 12;"/>

									<Label text="Tip: click on the simulator row to mark it."
                                           style="-fx-text-fill: #4c4e53ff;
                                                  -fx-font-size: 10px;"/>

                                    <Separator/>

									<Label text="New Simulator"
                                           style="-fx-text-fill: #111827;
                                                  -fx-font-size: 14px;
                                                  -fx-font-weight: bold;"/>

                                    <Button text="Add simulator (from model)"
                                            onAction="#onAddSimulator"
                                            maxWidth="Infinity"
                                            style="-fx-background-color: #22c55e;
                                                   -fx-text-fill: white;
                                                   -fx-font-weight: bold;
                                                   -fx-background-radius: 999;
                                                   -fx-padding: 8 12 8 12;"/>

                                    <Button text="Add simulator model"
                                            onAction="#onAddModel"
                                            maxWidth="Infinity"
                                            style="-fx-background-color: #22c55e;
                                                   -fx-text-fill: white;
                                                   -fx-font-weight: bold;
                                                   -fx-background-radius: 999;
                                                   -fx-padding: 8 12 8 12;"/>

                                </VBox>
                            </HBox>

                            <Label fx:id="infoLabel"
                                   textFill="red"
                                   wrapText="true"
                                   maxWidth="Infinity"/>
                        </VBox>
                    </children>
                </StackPane>
            <!-- </content>
        </ScrollPane> -->
    </center>

    <bottom>
        <HBox alignment="CENTER_RIGHT"
              style="-fx-padding: 4 24 8 24;">
            <children>
                <Label text="LAU · Clinical Simulator Center Inventory"
                       style="-fx-text-fill: #e5e7eb; -fx-font-size: 11px;"/>
            </children>
        </HBox>
    </bottom>
</BorderPane>
<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>

<BorderPane xmlns="http://javafx.com/javafx/8"
            xmlns:fx="http://javafx.com/fxml/1"
            fx:controller="com.example.ui.StockController"
            prefWidth="1200" prefHeight="750"
            style="-fx-background-color: linear-gradient(to bottom right, #14532d, #22c55e);">

    <top>
        <HBox alignment="CENTER_LEFT"
              spacing="10"
              style="-fx-padding: 16 32 16 32;">
            <children>
                <Label text="LAU"
                       style="-fx-text-fill: #f9fafb;
                              -fx-font-size: 22px;
                              -fx-font-weight: bold;"/>

                <Label text="· Clinical Simulator Center Inventory Management"
                       style="-fx-text-fill: #d1fae5;
                              -fx-font-size: 13px;"/>

                <Pane HBox.hgrow="ALWAYS"/>

                <Label fx:id="userLabel"
                       text="Logged in user"
                       style="-fx-text-fill: #f9fafb;
                              -fx-font-size: 12px;"/>
            </children>
        </HBox>
    </top>

    <left>
        <VBox spacing="8"
              style="-fx-background-color: #14532d;
                     -fx-padding: 24 14 24 24;">
            <children>
                <Label text="Navigation"
                       style="-fx-text-fill: #e5e7eb;
                              -fx-font-size: 12px;
                              -fx-font-weight: bold;
                              -fx-padding: 0 0 8 0;"/>

                <Button text="Overview"
                        onAction="#onNavOverview"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Simulators"
                        onAction="#onNavSimulators"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #ecfdf5;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 14 8 14;"/>

                <Button text="Consumables &amp; Stock"
                        maxWidth="Infinity"
                        style="-fx-background-color: rgba(0,0,0,0.22);
                               -fx-text-fill: #f9fafb;
                               -fx-font-weight: bold;
                               -fx-alignment: CENTER_LEFT;
                               -fx-background-radius: 999;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Borrowing"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Maintenance"
                        maxWidth="Infinity"
						onAction="#onNavMaintentance"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Users"
                        maxWidth="Infinity"
						onAction="#onNavUsers"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Separator style="-fx-opacity: 0.4; -fx-padding: 8 0 8 0;"/>>

                <Button text="Settings"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Pane VBox.vgrow="ALWAYS"/>

                <Button text="Logout"
                        onAction="#onLogout"
                        maxWidth="Infinity"
                        style="-fx-background-color: #ef4444;
                               -fx-text-fill: white;
                               -fx-font-weight: bold;
                               -fx-background-radius: 999;
                               -fx-padding: 8 12 8 12;"/>
            </children>
        </VBox>
    </left>

    <center>
        <!-- <ScrollPane fitToWidth="true" fitToHeight="true"
                    style="-fx-background-color: transparent;
                           -fx-padding: 8 24 24 8;">
            <content> -->
                <StackPane>
                    <padding>
                        <Insets top="8" right="8" bottom="8" left="8"/>
                    </padding>
                    <children>
                        <VBox spacing="16"
							  maxWidth="1400"
                              style="-fx-background-color: #f9fafb;
                                     -fx-background-radius: 20;
                                     -fx-padding: 24;
                                     -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.24), 22, 0.21, 0, 4);">

                            <VBox spacing="4">
                                <Label text="Consumables &amp; Stock"
                                       style="-fx-text-fill: #111827;
                                              -fx-font-size: 22px;
                                              -fx-font-weight: bold;"/>
                            </VBox>

                            <HBox spacing="10">
                                <TextField fx:id="searchField"
                                           promptText="Search by consumable, measure, branch, quantities, date..."
                                           HBox.hgrow="ALWAYS"
                                           style="-fx-background-radius: 999;
                                                  -fx-border-radius: 999;
                                                  -fx-border-color: #d1d5db;
                                                  -fx-padding: 6 12 6 12;
                                                  -fx-background-color: #ffffff;"/>

                                <ComboBox fx:id="sortByCombo"
                                          prefWidth="180"
                                          promptText="Sort by"
                                          style="-fx-background-radius: 999;
                                                 -fx-border-radius: 999;
                                                 -fx-border-color: #d1d5db;
                                                 -fx-padding: 4 10 4 10;
                                                 -fx-background-color: #ffffff;"/>
                            </HBox>

                            <HBox spacing="16">

                                <TableView fx:id="stockTable"
                                           prefHeight="480"
                                           HBox.hgrow="ALWAYS"
                                           style="-fx-background-color: transparent;
                                                  -fx-control-inner-background: #ffffff;
                                                  -fx-table-cell-border-color: #e5e7eb;
                                                  -fx-table-header-border-color: #e5e7eb;">
                                    <columns>
                                        <TableColumn fx:id="consColumn"
                                                     text="Consumable"
                                                     prefWidth="280"/>
                                        <TableColumn fx:id="measureColumn"
                                                     text="Measure"
                                                     prefWidth="80"/>
                                        <TableColumn fx:id="branchColumn"
                                                     text="Branch"
                                                     prefWidth="130"/>
                                        <TableColumn fx:id="availColumn"
                                                     text="Available"
                                                     prefWidth="80"/>
                                        <TableColumn fx:id="resColumn"
                                                     text="Reserved"
                                                     prefWidth="80"/>
                                        <TableColumn fx:id="lastCountCol"
                                                     text="Last count"
                                                     prefWidth="120"/>
                                    </columns>
                                </TableView>

                                <VBox spacing="12"
                                      prefWidth="260"
                                      style="-fx-background-color: #ffffff;
                                             -fx-background-radius: 14;
                                             -fx-padding: 16;
                                             -fx-border-color: #e5e7eb;
                                             -fx-border-radius: 14;">

                                    <Label text="Actions"
                                           style="-fx-text-fill: #111827;
                                                  -fx-font-size: 16px;
                                                  -fx-font-weight: bold;"/>

                                    <Separator/>

                                    <Label text="Stock operations"
                                           style="-fx-text-fill: #111827;
                                                  -fx-font-size: 14px;
                                                  -fx-font-weight: bold;"/>

                                    <Button text="Top up"
									        onAction="#onTopUpStock"
									        maxWidth="Infinity"
									        style="-fx-background-color: #22c55e;
									               -fx-text-fill: white;
									               -fx-font-weight: bold;
									               -fx-background-radius: 999;
									               -fx-padding: 8 12 8 12;"/>

									<Button text="Top up reserved"
									        onAction="#onTopUpReserved"
									        maxWidth="Infinity"
									        style="-fx-background-color: #22c55e;
									               -fx-text-fill: white;
									               -fx-font-weight: bold;
									               -fx-background-radius: 999;
									               -fx-padding: 8 12 8 12;"/>

									<Button text="Top up from reserved"
									        onAction="#onTopUpFromReserved"
									        maxWidth="Infinity"
									        style="-fx-background-color: #22c55e;
									               -fx-text-fill: white;
									               -fx-font-weight: bold;
									               -fx-background-radius: 999;
									               -fx-padding: 8 12 8 12;"/>
									
									<Separator/>

									<Label text="New Stock &amp; Consumables"
                                           style="-fx-text-fill: #111827;
                                                  -fx-font-size: 14px;
                                                  -fx-font-weight: bold;"/>

                                    <Button text="Add consumable"
                                            onAction="#onAddConsumable"
                                            maxWidth="Infinity"
                                            style="-fx-background-color: #22c55e;
                                                   -fx-text-fill: white;
                                                   -fx-font-weight: bold;
                                                   -fx-background-radius: 999;
                                                   -fx-padding: 8 12 8 12;"/>

                                    <Button text="Add stock row"
                                            onAction="#onAddStock"
                                            maxWidth="Infinity"
                                            style="-fx-background-color: #22c55e;
                                                   -fx-text-fill: white;
                                                   -fx-font-weight: bold;
                                                   -fx-background-radius: 999;
                                                   -fx-padding: 8 12 8 12;"/>

                                </VBox>
                            </HBox>

                            <Label fx:id="infoLabel"
                                   textFill="red"
                                   wrapText="true"
                                   maxWidth="Infinity"/>
                        </VBox>
                    </children>
                </StackPane>
            <!-- </content>
        </ScrollPane> -->
    </center>

    <bottom>
        <HBox alignment="CENTER_RIGHT"
              style="-fx-padding: 4 24 8 24;">
            <children>
                <Label text="LAU · Clinical Simulator Center Inventory"
                       style="-fx-text-fill: #e5e7eb; -fx-font-size: 11px;"/>
            </children>
        </HBox>
    </bottom>
</BorderPane>
<?xml version="1.0" encoding="UTF-8"?>

<?import javafx.geometry.Insets?>
<?import javafx.scene.control.*?>
<?import javafx.scene.layout.*?>

<BorderPane xmlns="http://javafx.com/javafx/8"
            xmlns:fx="http://javafx.com/fxml/1"
            fx:controller="com.example.ui.UsersController"
            prefWidth="1200" prefHeight="750"
            style="-fx-background-color: linear-gradient(to bottom right, #14532d, #22c55e);">

    <!-- TOP BAR -->
    <top>
        <HBox alignment="CENTER_LEFT"
              spacing="10"
              style="-fx-padding: 16 32 16 32;">
            <children>
                <Label text="LAU"
                       style="-fx-text-fill: #f9fafb; -fx-font-size: 22px; -fx-font-weight: bold;"/>

                <Label text="· Clinical Simulator Center Inventory Management"
                       style="-fx-text-fill: #d1fae5; -fx-font-size: 13px;"/>

                <Pane HBox.hgrow="ALWAYS"/>

                <Label fx:id="userLabel"
                       text="Logged in user"
                       style="-fx-text-fill: #f9fafb; -fx-font-size: 12px;"/>
            </children>
        </HBox>
    </top>

    <!-- LEFT NAV -->
    <left>
        <VBox spacing="8"
              style="-fx-background-color: #14532d;
                     -fx-padding: 24 14 24 24;">
            <children>
                <Label text="Navigation"
                       style="-fx-text-fill: #e5e7eb;
                              -fx-font-size: 12px;
                              -fx-font-weight: bold;
                              -fx-padding: 0 0 8 0;"/>

                <Button text="Overview"
                        onAction="#onNavOverview"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Simulators"
                        onAction="#onNavSimulators"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Consumables &amp; Stock"
                        onAction="#onNavStock"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Borrowing"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Maintenance"
                        onAction="#onNavMaintentance"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Button text="Users"
                        maxWidth="Infinity"
                        style="-fx-background-color: rgba(0,0,0,0.22);
                               -fx-text-fill: #f9fafb;
                               -fx-font-weight: bold;
                               -fx-alignment: CENTER_LEFT;
                               -fx-background-radius: 999;
                               -fx-padding: 8 12 8 12;"/>

                <Separator style="-fx-opacity: 0.4; -fx-padding: 8 0 8 0;"/>

                <Button text="Settings"
                        maxWidth="Infinity"
                        style="-fx-background-color: transparent;
                               -fx-text-fill: #f9fafb;
                               -fx-alignment: CENTER_LEFT;
                               -fx-padding: 8 12 8 12;"/>

                <Pane VBox.vgrow="ALWAYS"/>

                <Button text="Logout"
                        onAction="#onLogout"
                        maxWidth="Infinity"
                        style="-fx-background-color: #ef4444;
                               -fx-text-fill: white;
                               -fx-font-weight: bold;
                               -fx-background-radius: 999;
                               -fx-padding: 8 12 8 12;"/>
            </children>
        </VBox>
    </left>

    <!-- CENTER: USERS TABLE + ACTIONS -->
    <center>
        <StackPane>
            <padding>
                <Insets top="8" right="8" bottom="8" left="8"/>
            </padding>
            <children>
                <VBox spacing="16"
					  maxWidth = "1400"
                      style="-fx-background-color: #f9fafb;
                             -fx-background-radius: 20;
                             -fx-padding: 24;
                             -fx-effect: dropshadow(gaussian, rgba(0,0,0,0.24), 22, 0.21, 0, 4);">

                    <!-- Header -->
                    <HBox spacing="4" alignment="CENTER_LEFT">
                        <children>
                            <VBox spacing="4">
                                <Label text="User Management"
                                       style="-fx-text-fill: #111827;
                                              -fx-font-size: 22px;
                                              -fx-font-weight: bold;"/>
                                <Label text="Create, reset and deactivate users (ADMIN only)."
                                       style="-fx-text-fill: #6b7280; -fx-font-size: 11px;"/>
                            </VBox>

                            <Pane HBox.hgrow="ALWAYS"/>

                            <TextField fx:id="searchField"
                                       promptText="Search users..."
                                       style="-fx-background-radius: 999;
                                              -fx-border-radius: 999;
                                              -fx-border-color: #d1d5db;
                                              -fx-padding: 6 12 6 12;
                                              -fx-background-color: #ffffff;"/>

                            <ComboBox fx:id="sortByCombo"
                                      prefWidth="140"
                                      style="-fx-background-radius: 999;
                                             -fx-border-radius: 999;
                                             -fx-border-color: #d1d5db;
                                             -fx-padding: 4 10 4 10;
                                             -fx-background-color: #ffffff;"/>
                        </children>
                    </HBox>

                    <HBox spacing="16">
                        <!-- Table -->
                        <VBox spacing="6" HBox.hgrow="ALWAYS">
                            <TableView fx:id="userTable"
                                       prefHeight="420"
                                       style="-fx-background-color: transparent;
                                              -fx-control-inner-background: #ffffff;
                                              -fx-table-cell-border-color: #e5e7eb;
                                              -fx-table-header-border-color: #e5e7eb;">
                                <columns>
                                    <TableColumn fx:id="usernameColumn"    text="Username"   prefWidth="140"/>
                                    <TableColumn fx:id="displayNameColumn" text="Name"       prefWidth="160"/>
                                    <TableColumn fx:id="roleColumn"        text="Role"       prefWidth="90"/>
                                    <TableColumn fx:id="emailColumn"       text="Email"      prefWidth="200"/>
                                    <TableColumn fx:id="branchColumn"      text="Branch"     prefWidth="140"/>
                                    <TableColumn fx:id="activeColumn"      text="Active"     prefWidth="80"/>
                                    <TableColumn fx:id="resetColumn"       text="Reset flag" prefWidth="90"/>
                                </columns>
                            </TableView>
                        </VBox>

                        <!-- Actions -->
                        <VBox spacing="10">
                            <Label text="Actions"
                                   style="-fx-text-fill: #111827;
                                          -fx-font-size: 13px;
                                          -fx-font-weight: bold;"/>

                            <Button text="New user"
                                    onAction="#onAddUser"
                                    maxWidth="Infinity"
                                    style="-fx-background-color: #22c55e;
                                           -fx-text-fill: white;
                                           -fx-font-weight: bold;
                                           -fx-background-radius: 999;
                                           -fx-padding: 8 12 8 12;"/>

                            <Button text="Reset password"
                                    onAction="#onResetPassword"
                                    maxWidth="Infinity"
                                    style="-fx-background-color: #22c55e;
                                           -fx-text-fill: white;
                                           -fx-font-weight: bold;
                                           -fx-background-radius: 999;
                                           -fx-padding: 8 12 8 12;"/>

                            <Button text="Activate / Deactivate"
                                    onAction="#onToggleActive"
                                    maxWidth="Infinity"
                                    style="-fx-background-color: #22c55e;
                                           -fx-text-fill: white;
                                           -fx-font-weight: bold;
                                           -fx-background-radius: 999;
                                           -fx-padding: 8 12 8 12;"/>

                            <Pane VBox.vgrow="ALWAYS"/>

                            <Label fx:id="infoLabel"
                                   text=""
                                   wrapText="true"
                                   style="-fx-text-fill: #6b7280; -fx-font-size: 11px;"/>
                        </VBox>
                    </HBox>
                </VBox>
            </children>
        </StackPane>
    </center>

	    <!-- BOTTOM FOOTER -->
    <bottom>
        <HBox alignment="CENTER_RIGHT"
              style="-fx-padding: 4 24 8 24;">
            <children>
                <Label text="LAU · Clinical Simulator Center Inventory"
                       style="-fx-text-fill: #e5e7eb; -fx-font-size: 11px;"/>
            </children>
        </HBox>
    </bottom>
</BorderPane>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 https://maven.apache.org/xsd/maven-4.0.0.xsd">
  <modelVersion>4.0.0</modelVersion>

  <groupId>com.example</groupId>
  <artifactId>dbproject</artifactId>
  <version>1.0.0</version>
  <name>dbproject</name>
  <packaging>jar</packaging>

  <properties>
    <maven.compiler.release>17</maven.compiler.release>
    <project.build.sourceEncoding>UTF-8</project.build.sourceEncoding>
    <javafx.version>21.0.3</javafx.version>
    <hibernate.version>5.6.15.Final</hibernate.version>
  </properties>

  <dependencies>
    <!-- JPA API -->
    <dependency>
      <groupId>javax.persistence</groupId>
      <artifactId>javax.persistence-api</artifactId>
      <version>2.2</version>
    </dependency>

    <!-- Hibernate -->
    <dependency>
      <groupId>org.hibernate</groupId>
      <artifactId>hibernate-core</artifactId>
      <version>${hibernate.version}</version>
    </dependency>

    <!-- MySQL driver -->
    <dependency>
      <groupId>com.mysql</groupId>
      <artifactId>mysql-connector-j</artifactId>
      <version>9.1.0</version>
      <scope>runtime</scope>
    </dependency>

    <!-- JavaFX (controls + fxml + graphics) -->
    <dependency>
      <groupId>org.openjfx</groupId>
      <artifactId>javafx-controls</artifactId>
      <version>${javafx.version}</version>
    </dependency>
    <dependency>
      <groupId>org.openjfx</groupId>
      <artifactId>javafx-fxml</artifactId>
      <version>${javafx.version}</version>
    </dependency>
    <dependency>
      <groupId>org.openjfx</groupId>
      <artifactId>javafx-graphics</artifactId>
      <version>${javafx.version}</version>
    </dependency>

    <!-- BCrypt -->
    <dependency>
      <groupId>org.mindrot</groupId>
      <artifactId>jbcrypt</artifactId>
      <version>0.4</version>
    </dependency>
  </dependencies>

  <build>
    <plugins>
      <!-- Java 17 -->
      <plugin>
        <groupId>org.apache.maven.plugins</groupId>
        <artifactId>maven-compiler-plugin</artifactId>
        <version>3.11.0</version>
        <configuration>
          <release>${maven.compiler.release}</release>
        </configuration>
      </plugin>

      <!-- JavaFX run plugin (this is what provides the 'javafx:run' goal) -->
      <plugin>
        <groupId>org.openjfx</groupId>
        <artifactId>javafx-maven-plugin</artifactId>
        <version>0.0.8</version>
        <configuration>
          <!-- Your JavaFX Application class -->
          <mainClass>com.example.app.MainApp</mainClass>
          <!-- tell the launcher which JavaFX modules to enable -->
          <addModules>javafx.controls,javafx.fxml,javafx.graphics</addModules>
        </configuration>
      </plugin>
    </plugins>
  </build>

  <!-- Optional profile name 'ui' so you can run: mvn -Pui javafx:run -->
  <profiles>
    <profile>
      <id>ui</id>
      <properties>
        <exec.mainClass>com.example.ui.MainApp</exec.mainClass>
      </properties>
    </profile>
  </profiles>
</project>
